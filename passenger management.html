<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pasakay - Passenger</title>
  <link rel="icon" href="tricy.png" type="image/png">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      onValue,
      get,
      set,
      update
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBS-g5bFBaJ6a35hWmjvoN-s8FuMEuxtew",
      authDomain: "pasakay-project-ph.firebaseapp.com",
      databaseURL: "https://pasakay-project-ph-default-rtdb.firebaseio.com",
      projectId: "pasakay-project-ph",
      storageBucket: "pasakay-project-ph.firebasestorage.app",
      messagingSenderId: "189297787561",
      appId: "1:189297787561:web:ddad5de3fdf638c6d8dfb8",
      measurementId: "G-2VWQ0C8EZE"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Expose DB helpers to the non-module React script
    window.db = db;
    window.dbRef = ref;
    window.dbOnValue = onValue;
    window.dbGet = get;
    window.dbSet = set;
    window.dbUpdate = update;
  </script>

  <script src="ui-modals.js"></script>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: "Inter", sans-serif;
      background: #0a0e1a;
      margin: 0;
    }
    
    /* Customized Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: #1a2333;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #fbbf24 0%, #f59e0b 100%);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #fcd34d 0%, #fbbf24 100%);
    }
    
    /* Firefox Scrollbar */
    * {
      scrollbar-color: #2e3c57 #1a2333;
      scrollbar-width: thin;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Helper: strip +63 prefix for display
    const stripPhonePrefix = (phone) => {
      if (!phone) return '';
      const str = phone.toString();
      if (str.startsWith('+63')) return str.slice(3);
      return str;
    };

    const PassengerManagement = () => {
      const [showEditModal, setShowEditModal] = React.useState(false);
      const [showFilterModal, setShowFilterModal] = React.useState(false);
      const [selectedPassenger, setSelectedPassenger] = React.useState(null);
      const [selectedPassengerIndex, setSelectedPassengerIndex] = React.useState(null);
      const [searchQuery, setSearchQuery] = React.useState("");
      const [startDate, setStartDate] = React.useState("");
      const [endDate, setEndDate] = React.useState("");
      const [emailError, setEmailError] = React.useState("");
      const [phoneError, setPhoneError] = React.useState("");

      // Raw objects from DB
      const [rawUsers, setRawUsers] = React.useState({});
      const [rawPassengers, setRawPassengers] = React.useState({});
      const [rawDrivers, setRawDrivers] = React.useState({});
      const [rawBookings, setRawBookings] = React.useState({});
      const [rawFeedback, setRawFeedback] = React.useState({});

      // Derived arrays for UI
      const [passengers, setPassengers] = React.useState([]);
      const [rideHistory, setRideHistory] = React.useState([]);

      // Set up realtime listeners to DB nodes
      React.useEffect(() => {
        if (!window.db || !window.dbRef || !window.dbOnValue) return;

        const usersRef = window.dbRef(window.db, 'users');
        const passengersRef = window.dbRef(window.db, 'passengers');
        const driversRef = window.dbRef(window.db, 'drivers');
        const bookingsRef = window.dbRef(window.db, 'booking');
        const feedbackRef = window.dbRef(window.db, 'feedback');

        const unsubUsers = window.dbOnValue(usersRef, snap => setRawUsers(snap.val() || {}));
        const unsubPassengers = window.dbOnValue(passengersRef, snap => setRawPassengers(snap.val() || {}));
        const unsubDrivers = window.dbOnValue(driversRef, snap => setRawDrivers(snap.val() || {}));
        const unsubBookings = window.dbOnValue(bookingsRef, snap => setRawBookings(snap.val() || {}));
        const unsubFeedback = window.dbOnValue(feedbackRef, snap => setRawFeedback(snap.val() || {}));

        return () => {
          try { unsubUsers(); } catch(e) {}
          try { unsubPassengers(); } catch(e) {}
          try { unsubDrivers(); } catch(e) {}
          try { unsubBookings(); } catch(e) {}
          try { unsubFeedback(); } catch(e) {}
        };
      }, []);

      // Derive passengers and ride history from DB objects
      React.useEffect(() => {
        const makeFullName = (u) => {
          if (!u) return 'Unknown';
          return [u.Firstname, u.Middlename, u.Lastname].filter(Boolean).join(' ');
        };

        // Build passengers from users node - filter by PassengerID and RoleID
        const passengersArr = [];
        Object.entries(rawUsers || {}).forEach(([userId, userObj]) => {
          try {
            // Include users where PassengerID exists AND RoleID indicates passenger role
            // Check for PassengerID field and RoleID matching passenger (case-insensitive)
            const hasPassengerId = userObj.PassengerID && String(userObj.PassengerID).trim() !== '';
            const isPassengerRole = userObj.RoleID && (String(userObj.RoleID).toLowerCase() === 'passenger' || String(userObj.RoleID) === '2');
            
            // Also support legacy Role field for backward compatibility
            const isLegacyPassenger = !isPassengerRole && String(userObj.Role || '').toLowerCase() === 'passenger';
            
            if (!userObj || (!hasPassengerId && !isPassengerRole && !isLegacyPassenger)) return;

            const name = makeFullName(userObj);
            const initials = name.split(" ").map(n => n[0]).join("").slice(0, 2).toUpperCase();
            
            // Count total rides for this passenger using PassengerID
            const passengerIdForMatch = userObj.PassengerID || userId;
            const totalRides = Object.values(rawBookings || {}).filter(b => 
              String(b.PassengerID) === String(passengerIdForMatch) || 
              String(b.PassengerID) === String(userId) || 
              String(b.PassengerID) === `P${userId}`
            ).length;
            
            passengersArr.push({
              id: userObj.PassengerID || userId,
              userId,
              initials,
              name,
              phone: userObj ? userObj.MobileNumber : '',
              email: userObj ? userObj.Email : '',
              rides: totalRides,
              status: userObj && userObj.IsActive ? 'ACTIVE' : 'INACTIVE'
            });
          } catch (e) {
            // ignore parsing errors for malformed user objects
            console.warn('Error processing user:', userId, e);
          }
        });

        // Build ride history
        const historyArr = [];
        Object.entries(rawBookings || {}).forEach(([bookingId, b]) => {
          // Try to find passenger by PassengerID in booking, then lookup in users
          let passengerUser = null;
          let passengerIdDisplay = b.PassengerID;
          
          // Search users for matching PassengerID
          Object.entries(rawUsers || {}).forEach(([userId, u]) => {
            if (u.PassengerID && String(u.PassengerID) === String(b.PassengerID)) {
              passengerUser = u;
            }
          });
          
          // Fallback: if booking has direct reference to users node
          if (!passengerUser && rawUsers && rawUsers[b.PassengerID]) {
            passengerUser = rawUsers[b.PassengerID];
            passengerIdDisplay = b.PassengerID;
          }
          
          const driverRec = rawDrivers && rawDrivers[b.DriverID];
          const driverUser = driverRec ? rawUsers[driverRec.UserID] : null;
          const passengerName = passengerUser ? makeFullName(passengerUser) : 'Passenger';
          const driverName = driverUser ? makeFullName(driverUser) : 'Driver';
          
          // Get feedback/rating for this booking
          const feedback = Object.values(rawFeedback || {}).find(f => String(f.BookingID) === String(bookingId));
          const rating = feedback ? `${feedback.Rating}/5` : 'No rating';
          
          historyArr.push({
            passengerId: passengerIdDisplay,
            passengerName,
            driverName,
            fare: `₱ ${Number(b.TotalFare || 0).toFixed(2)}`,
            tricycleNo: driverRec ? driverRec.TricycleNumber : 'Unknown',
            pickup: b.PickUpLocation || '',
            dropOff: b.DropOffLocation || '',
            payment: 'Cash', // TODO: get from payment table if available
            rating,
            date: b.RequestedAt ? b.RequestedAt.slice(0, 10) : ''
          });
        });

        setPassengers(passengersArr);
        setRideHistory(historyArr);
      }, [rawUsers, rawPassengers, rawDrivers, rawBookings, rawFeedback]);

      // Filter rides based on search query and date range
      const getFilteredRides = () => {
        let filtered = [...rideHistory];

        // Filter by passenger ID, passenger name, driver name, tricycle number, or pickup/dropoff location
        if (searchQuery && searchQuery.trim()) {
          const query = searchQuery.toLowerCase();
          filtered = filtered.filter(ride => {
            const passengerId = (ride.passengerId || '').toLowerCase();
            const passengerName = (ride.passengerName || '').toLowerCase();
            const driverName = (ride.driverName || '').toLowerCase();
            const tricycleNo = (ride.tricycleNo || '').toLowerCase();
            const pickup = (ride.pickup || '').toLowerCase();
            const dropOff = (ride.dropOff || '').toLowerCase();
            
            return passengerId.includes(query) || 
                   passengerName.includes(query) ||
                   driverName.includes(query) ||
                   tricycleNo.includes(query) ||
                   pickup.includes(query) ||
                   dropOff.includes(query);
          });
        }

        // Filter by date range - using string comparison for consistency
        if (startDate && startDate.trim()) {
          filtered = filtered.filter(ride => {
            return ride.date >= startDate;
          });
        }
        if (endDate && endDate.trim()) {
          filtered = filtered.filter(ride => {
            return ride.date <= endDate;
          });
        }

        return filtered;
      };

      const handleEdit = (passenger, index) => {
        setSelectedPassenger({ ...passenger });
        setSelectedPassengerIndex(index);
        setShowEditModal(true);
      };

      const handleClose = () => {
        setShowEditModal(false);
        setSelectedPassenger(null);
        setSelectedPassengerIndex(null);
      };
      
      const handleSave = async () => {
        if (selectedPassengerIndex !== null) {
          try {
            const passengerToUpdate = passengers[selectedPassengerIndex];
            const passengerId = passengerToUpdate.id;
            const userId = passengerToUpdate.userId;

            // Split the name into first, middle, last
            const nameParts = selectedPassenger.name.trim().split(/\s+/);
            const firstname = nameParts[0] || '';
            const lastname = nameParts.length > 1 ? nameParts[nameParts.length - 1] : '';
            const middlename = nameParts.length > 2 ? nameParts.slice(1, -1).join(' ') : (nameParts.length === 2 ? '' : '');

            // Validate contact number: digits only, exactly 11
            const phoneRaw = (selectedPassenger.phone || '').toString().replace(/\D/g, '');
            if (phoneRaw.length !== 11) {
              window.showAlert('Contact number must be exactly 11 digits', 'error');
              return;
            }

            // Prepare email: enforce gmail.com domain. If user didn't include domain, append @gmail.com
            let emailRaw = (selectedPassenger.email || '').toString().trim().toLowerCase();
            if (!emailRaw.includes('@')) {
              emailRaw = emailRaw + '@gmail.com';
            }
            const emailDomain = emailRaw.split('@')[1] || '';
            if (emailDomain !== 'gmail.com') {
              window.showAlert('Email must be on \"gmail.com\" format', 'error');
              return;
            }if (emailDomain !== 'gmail.com') {
              window.showAlert('Email must be on \"gmail.com\" format', 'error');
              return;
            }

            // Update user record in Firebase
            const userRef = window.dbRef(window.db, `users/${userId}`);
            await window.dbUpdate(userRef, {
              Firstname: firstname,
              Middlename: middlename,
              Lastname: lastname,
              MobileNumber: phoneRaw,
              Email: emailRaw
            });

            // Update local state (will also be updated by realtime listener)
            const updatedPassengers = [...passengers];
            updatedPassengers[selectedPassengerIndex] = {
              ...updatedPassengers[selectedPassengerIndex],
              name: selectedPassenger.name,
              email: emailRaw,
              phone: phoneRaw
            };
            setPassengers(updatedPassengers);
            window.showAlert("Changes saved for " + selectedPassenger.name, 'success');
            handleClose();
          } catch (error) {
            console.error('Error saving passenger:', error);
            window.showAlert('Error saving changes: ' + error.message, 'error');
          }
        }
      };

      const rawSegment = window.location.pathname.split("/").pop() || window.location.href.split("/").pop() || '';
      const normalize = (s) => decodeURIComponent((s || '').toString()).toLowerCase().trim();
      const currentPage = normalize(rawSegment);

      const getLinkClass = (page) => {
        const isActive = currentPage === normalize(page);
        return "flex items-center gap-3 px-4 py-3 rounded-lg transition-colors " +
          (isActive ? "bg-yellow-500 text-gray-900 font-semibold" : "text-gray-300 hover:bg-gray-700");
      };

      return (
        <div className="flex min-h-screen bg-[#0a0e1a]">
          {/* Sidebar */}
          <aside className="w-72 bg-[#0e1420] text-white p-6 flex flex-col border-r border-gray-900">
            <div className="flex items-center gap-3 mb-10">
              <div className="w-14 h-14 rounded-2xl flex items-center justify-center overflow-hidden">
                <img src="tricy.png" alt="Pasakay" className="w-full h-full object-cover bg-yellow-500 p-1" />
              </div>
              <div>
                <h1 className="text-2xl font-bold text-yellow-500">PASAKAY</h1>
                <p className="text-sm text-gray-400">Admin Dashboard</p>
              </div>
            </div>

            <nav className="flex flex-col gap-2">
              <a href="dashboard.html" className={getLinkClass("dashboard.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                Dashboard
              </a>
              <a href="driver management.html" className={getLinkClass("driver management.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                Drivers
              </a>
              <a href="passenger management.html" className={getLinkClass("passenger management.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                Passengers
              </a>
              <a href="Driver application.html" className={getLinkClass("Driver application.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Membership
              </a>
              <a href="booking management.html" className={getLinkClass("booking management.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                Bookings
              </a>
              <a href="Logs.html" className={getLinkClass("Logs.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Logs
              </a>
              <a href="Fare Matrix.html" className={getLinkClass("Fare Matrix.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Fare Matrix
              </a>
              <a href="log out.html" className={getLinkClass("log out.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                Log out
              </a>
            </nav>
          </aside>

          {/* Main Content */}
          <main className="flex-1 bg-[#1a202e] p-8">
            {/* Header */}
            <header className="flex justify-between items-center mb-8">
              <h2 className="text-3xl font-bold text-white">Passenger Management</h2>
              <div className="flex items-center gap-3 bg-yellow-500 px-4 py-2 rounded-lg">
                <div className="w-10 h-10 bg-gray-900 text-yellow-500 rounded-full flex items-center justify-center font-bold text-lg">
                  A
                </div>
                <span className="font-semibold text-gray-900">Admin</span>
              </div>
            </header>

            {/* Passenger list box */}
            <div className="bg-[#1e2538] p-8 rounded-xl">
              <div className="flex justify-between items-center mb-6">
                <h3 className="text-2xl font-bold text-white">Passenger Management</h3>
                <button
                  onClick={() => setShowFilterModal(true)}
                  className="bg-yellow-500 hover:bg-yellow-600 px-6 py-3 rounded-lg font-semibold text-gray-900 flex items-center gap-2"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                  </svg>
                  FILTER PASSENGER
                </button>
              </div>

              <div className="space-y-4">
                {passengers.map((p, index) => (
                  <div key={index} className="flex justify-between items-center bg-[#252d42] p-6 rounded-lg hover:bg-[#2d3548] transition-colors">
                    <div className="flex items-center gap-4">
                      <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-white text-lg ${
                        p.status === "ACTIVE" ? "bg-green-500" : "bg-gray-500"
                      }`}>
                        {p.initials}
                      </div>
                      <div>
                        <h4 className="font-bold text-white text-lg">{p.name}</h4>
                        <p className="text-sm text-gray-400">
                          Passenger ID: {p.id} | Phone: {stripPhonePrefix(p.phone)} | {p.rides} rides total
                        </p>
                      </div>
                    </div>
                    <div className="flex items-center gap-3">
                      <span className={`px-4 py-2 rounded-lg text-sm font-bold text-white ${
                        p.status === "ACTIVE" ? "bg-green-500" : "bg-gray-500"
                      }`}>
                        {p.status}
                      </span>
                      <button
                        onClick={() => handleEdit(p, index)}
                        className="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-lg text-sm font-semibold text-gray-900 flex items-center gap-2"
                      >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        Edit
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </main>

          {/* Filter Passenger Modal */}
          {showFilterModal && (
            <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50 overflow-y-auto py-8">
              <div className="bg-[#1e2538] rounded-xl shadow-lg p-8 w-[900px] max-h-[90vh] overflow-y-auto relative">
                <button
                  className="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl font-light"
                  onClick={() => setShowFilterModal(false)}
                >
                  ×
                </button>
                <h3 className="text-2xl font-bold mb-6 text-white">Filter Passenger Ride History</h3>
                
                <div className="flex items-center gap-4 mb-6">
                  <input
                    type="text"
                    placeholder="Search by Passenger, Driver, Tricycle #, Location..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="flex-1 px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none placeholder-gray-500"
                  />
                  <input 
                    type="date" 
                    value={startDate}
                    onChange={(e) => setStartDate(e.target.value)}
                    className="px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                  />
                  <span className="text-gray-300">to</span>
                  <input 
                    type="date" 
                    value={endDate}
                    onChange={(e) => setEndDate(e.target.value)}
                    className="px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                  />
                  <button
                    onClick={() => {
                      setSearchQuery("");
                      setStartDate("");
                      setEndDate("");
                    }}
                    className="bg-gray-600 hover:bg-gray-700 px-4 py-3 rounded-lg font-semibold text-white"
                  >
                    Clear
                  </button>
                </div>

                {getFilteredRides().length > 0 ? (
                  <>
                    <div className="mb-4 text-gray-300 text-sm">
                      Showing {getFilteredRides().length} ride(s)
                    </div>
                    <div className="bg-[#252d42] rounded-lg overflow-hidden">
                      <table className="w-full text-white text-sm">
                        <thead className="bg-[#1a1f2e]">
                          <tr>
                            <th className="p-3 text-left font-semibold">Date</th>
                            <th className="p-3 text-left font-semibold">Passenger ID/Name</th>
                            <th className="p-3 text-left font-semibold">Fare</th>
                            <th className="p-3 text-left font-semibold">Tricycle No.</th>
                            <th className="p-3 text-left font-semibold">Pickup</th>
                            <th className="p-3 text-left font-semibold">Drop Off</th>
                            <th className="p-3 text-left font-semibold">Payment</th>
                            <th className="p-3 text-left font-semibold">Rating</th>
                          </tr>
                        </thead>
                        <tbody>
                          {getFilteredRides().map((ride, idx) => (
                            <tr key={idx} className="border-b border-gray-700 hover:bg-[#2d3548]">
                              <td className="p-3 text-gray-400">{new Date(ride.date).toLocaleDateString()}</td>
                              <td className="p-3">{ride.passengerId}, {ride.passengerName}</td>
                              <td className="p-3 text-green-400 font-semibold">{ride.fare}</td>
                              <td className="p-3">{ride.tricycleNo}</td>
                              <td className="p-3">{ride.pickup}</td>
                              <td className="p-3">{ride.dropOff}</td>
                              <td className="p-3">
                                <span className={`px-2 py-1 rounded text-xs font-semibold ${
                                  ride.payment === "Cash" ? "bg-green-600" : "bg-blue-600"
                                }`}>
                                  {ride.payment}
                                </span>
                              </td>
                              <td className="p-3">
                                <span className="text-yellow-400">★</span> {ride.rating}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </>
                ) : (
                  <div className="bg-[#252d42] rounded-lg p-12 text-center">
                    <svg className="w-16 h-16 mx-auto mb-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p className="text-gray-400 text-lg">No rides found</p>
                    <p className="text-gray-500 text-sm mt-2">Try adjusting your search filters</p>
                  </div>
                )}

                <div className="flex justify-end mt-6">
                  <button
                    onClick={() => setShowFilterModal(false)}
                    className="bg-red-600 hover:bg-red-700 px-8 py-3 rounded-lg font-semibold text-white"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Edit Passenger Modal */}
          {showEditModal && selectedPassenger && (
            <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50">
              <div className="bg-[#1e2538] rounded-xl shadow-lg p-8 w-[600px] relative">
                <button
                  className="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl font-light"
                  onClick={handleClose}
                >
                  ×
                </button>
                <h3 className="text-2xl font-bold mb-6 text-white">Edit Passenger</h3>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm text-gray-300 mb-2 font-medium">Passenger Name</label>
                    <input
                      type="text"
                      value={selectedPassenger.name}
                      className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none"
                      onChange={(e) =>
                        setSelectedPassenger({ ...selectedPassenger, name: e.target.value })
                      }
                    />
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm text-gray-300 mb-2 font-medium">Email</label>
                      <input
                        type="email"
                        value={selectedPassenger.email}
                        className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none"
                        onChange={(e) => {
                          const val = e.target.value.toString().trim().toLowerCase();
                          setSelectedPassenger({ ...selectedPassenger, email: val });
                          // Only show error if user already typed a domain that's not gmail.com
                          if (val.includes('@')) {
                            const domain = val.split('@')[1] || '';
                            if (domain !== 'gmail.com') setEmailError('Email must be a \"gmail.com\" address');
                            else setEmailError('');
                          } else {
                            setEmailError('');
                          }
                        }}
                      />
                        {emailError && (
                          <p className="text-sm text-red-400 mt-1">{emailError}</p>
                        )}
                    </div>
                    <div>
                      <label className="block text-sm text-gray-300 mb-2 font-medium">Contact Number</label>
                      <input
                        type="text"
                        value={selectedPassenger.phone}
                        className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none"
                        onChange={(e) => {
                          const digits = e.target.value.toString().replace(/\D/g, '').slice(0,11);
                          setSelectedPassenger({ ...selectedPassenger, phone: digits });
                          if (digits.length > 0 && digits.length !== 11) setPhoneError('Contact must be 11 digits');
                          else setPhoneError('');
                        }}
                      />
                        {phoneError && (
                          <p className="text-sm text-red-400 mt-1">{phoneError}</p>
                        )}
                    </div>
                  </div>
                </div>
                <div className="flex justify-between mt-6">
                  <button
                    className="bg-red-600 hover:bg-red-700 px-8 py-3 rounded-lg font-semibold text-white"
                    onClick={handleClose}
                  >
                    Cancel
                  </button>
                  <button
                    className="bg-green-600 hover:bg-green-700 px-8 py-3 rounded-lg font-semibold text-white"
                    onClick={handleSave}
                  >
                    Save Changes
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<PassengerManagement />);
  </script>
</body>
</html>