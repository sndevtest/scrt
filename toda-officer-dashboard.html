<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pasakay - TODA Officer Dashboard</title>
  <link rel="icon" href="tricy.png" type="image/png">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      onValue,
      get,
      query,
      orderByChild,
      equalTo
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBS-g5bFBaJ6a35hWmjvoN-s8FuMEuxtew",
      authDomain: "pasakay-project-ph.firebaseapp.com",
      databaseURL: "https://pasakay-project-ph-default-rtdb.firebaseio.com",
      projectId: "pasakay-project-ph",
      storageBucket: "pasakay-project-ph.firebasestorage.app",
      messagingSenderId: "189297787561",
      appId: "1:189297787561:web:ddad5de3fdf638c6d8dfb8",
      measurementId: "G-2VWQ0C8EZE"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Expose DB helpers to the non-module React script
    window.db = db;
    window.dbRef = ref;
    window.dbOnValue = onValue;
    window.dbGet = get;
    window.dbQuery = query;
    window.dbOrderByChild = orderByChild;
    window.dbEqualTo = equalTo;
    window.firebaseAuth = auth;
    window.firebaseSignOut = signOut;

    // Role check: verify user is TODA Officer (RoleID = 1)
    const checkAccess = async () => {
      const userRole = sessionStorage.getItem('userRole');
      const userUID = sessionStorage.getItem('userUID');
      
      if (userRole !== '1' || !userUID) {
        console.error('❌ Access denied: Not a TODA Officer');
        window.location.href = 'log in.html';
        return;
      }
      console.log('✅ TODA Officer access granted');
    };

    checkAccess();
  </script>

  <!-- React + Babel + Tailwind -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: "Inter", sans-serif;
      background: #0a0e1a;
    }
    
    /* Customized Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: #1a2333;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #fbbf24 0%, #f59e0b 100%);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #fcd34d 0%, #fbbf24 100%);
    }
    
    /* Firefox Scrollbar */
    * {
      scrollbar-color: #2e3c57 #1a2333;
      scrollbar-width: thin;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const TodaOfficerDashboard = () => {
      const [currentPage, setCurrentPage] = React.useState('membership');
      const [userName, setUserName] = React.useState('');
      const [members, setMembers] = React.useState([]);
      const [auditLogs, setAuditLogs] = React.useState([]);
      const [searchTerm, setSearchTerm] = React.useState('');

      // Load user info from sessionStorage
      React.useEffect(() => {
        const storedName = sessionStorage.getItem('userName') || 'TODA Officer';
        setUserName(storedName);
      }, []);

      // Load members (users with RoleID = 2 or 3 - drivers and passengers)
      React.useEffect(() => {
        if (!window.db || !window.dbRef || !window.dbOnValue) return;

        const usersRef = window.dbRef(window.db, 'users');
        const unsubscribe = window.dbOnValue(usersRef, snap => {
          try {
            const usersData = snap.val() || {};
            const memberList = Object.entries(usersData)
              .filter(([_, user]) => {
                const roleId = String(user?.RoleID || '');
                return roleId === '2' || roleId === '3'; // Drivers and Passengers
              })
              .map(([userId, user]) => ({
                id: userId,
                ...user,
                role: String(user?.RoleID) === '2' ? 'Driver' : 'Passenger'
              }))
              .sort((a, b) => (a.Firstname || '').localeCompare(b.Firstname || ''));
            
            setMembers(memberList);
          } catch(err) {
            console.error('Error loading members:', err);
          }
        });

        return () => unsubscribe();
      }, []);

      // Load audit logs (simulated - in real scenario, this would come from a dedicated logs collection)
      React.useEffect(() => {
        if (!window.db || !window.dbRef || !window.dbOnValue) return;

        const logsRef = window.dbRef(window.db, 'audit_logs');
        const unsubscribe = window.dbOnValue(logsRef, snap => {
          try {
            const logsData = snap.val() || {};
            const logList = Object.entries(logsData)
              .map(([logId, log]) => ({
                id: logId,
                ...log
              }))
              .sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0))
              .slice(0, 100); // Last 100 logs
            
            setAuditLogs(logList);
          } catch(err) {
            console.error('Error loading audit logs:', err);
          }
        });

        return () => unsubscribe();
      }, []);

      const handleLogout = async () => {
        try {
          await window.firebaseSignOut(window.firebaseAuth);
          sessionStorage.clear();
          window.location.href = 'log in.html';
        } catch (error) {
          console.error('Logout error:', error);
          alert('Error logging out');
        }
      };

      const filteredMembers = members.filter(member => {
        const searchLower = searchTerm.toLowerCase();
        const fullName = `${member.Firstname || ''} ${member.Middlename || ''} ${member.Lastname || ''}`.toLowerCase();
        return fullName.includes(searchLower) || 
               (member.Email || '').toLowerCase().includes(searchLower) ||
               (member.PhoneNumber || '').includes(searchTerm);
      });

      return (
        <div className="min-h-screen bg-[#0a0e1a]">
          {/* Header */}
          <header className="bg-[#151b28] border-b border-gray-700">
            <div className="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <img src="tricy.png" alt="Logo" className="w-8 h-8" />
                <div>
                  <h1 className="text-xl font-bold text-yellow-500">PASAKAY</h1>
                  <p className="text-xs text-gray-400">TODA Officer Dashboard</p>
                </div>
              </div>
              <div className="text-right">
                <p className="text-gray-300">Welcome, {userName}</p>
                <p className="text-xs text-gray-500">TODA Officer</p>
              </div>
            </div>
          </header>

          {/* Navigation Tabs */}
          <div className="bg-[#0f1419] border-b border-gray-700 sticky top-0 z-10">
            <div className="max-w-7xl mx-auto px-6">
              <div className="flex gap-8">
                <button
                  onClick={() => setCurrentPage('membership')}
                  className={`py-4 px-2 border-b-2 font-medium transition-colors ${
                    currentPage === 'membership'
                      ? 'border-yellow-500 text-yellow-500'
                      : 'border-transparent text-gray-400 hover:text-yellow-400'
                  }`}
                >
                  <svg className="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM9 10a6 6 0 1 1-12 0 6 6 0 0 1 12 0z" />
                  </svg>
                  Membership
                </button>
                <button
                  onClick={() => setCurrentPage('audit')}
                  className={`py-4 px-2 border-b-2 font-medium transition-colors ${
                    currentPage === 'audit'
                      ? 'border-yellow-500 text-yellow-500'
                      : 'border-transparent text-gray-400 hover:text-yellow-400'
                  }`}
                >
                  <svg className="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 5a2 2 0 012-2h12a2 2 0 012 2v2h2a2 2 0 110 4h-2v2a2 2 0 01-2 2H4a2 2 0 01-2-2v-2H0a2 2 0 110-4h2V5z" />
                  </svg>
                  Audit Logs
                </button>
                <button
                  onClick={handleLogout}
                  className="py-4 px-2 border-b-2 border-transparent text-gray-400 hover:text-red-400 font-medium transition-colors ml-auto"
                >
                  <svg className="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clipRule="evenodd" />
                  </svg>
                  Logout
                </button>
              </div>
            </div>
          </div>

          {/* Content */}
          <div className="max-w-7xl mx-auto px-6 py-8">
            {currentPage === 'membership' && (
              <div className="space-y-6">
                <div>
                  <h2 className="text-2xl font-bold text-white mb-4">Membership Management</h2>
                  
                  {/* Search */}
                  <div className="mb-6">
                    <input
                      type="text"
                      placeholder="Search by name, email, or phone..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="w-full px-4 py-2 bg-[#1a2333] text-white border border-gray-700 rounded-lg focus:outline-none focus:border-yellow-500"
                    />
                  </div>

                  {/* Members Table */}
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-[#151b28] border-b border-gray-700">
                        <tr>
                          <th className="px-6 py-3 text-left text-gray-400 font-semibold">Name</th>
                          <th className="px-6 py-3 text-left text-gray-400 font-semibold">Email</th>
                          <th className="px-6 py-3 text-left text-gray-400 font-semibold">Phone</th>
                          <th className="px-6 py-3 text-left text-gray-400 font-semibold">Role</th>
                          <th className="px-6 py-3 text-left text-gray-400 font-semibold">Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {filteredMembers.length > 0 ? (
                          filteredMembers.map((member) => (
                            <tr key={member.id} className="bg-[#151b28] hover:bg-[#1a202e] border-b border-gray-700">
                              <td className="px-6 py-3 text-gray-300">
                                {member.Firstname} {member.Middlename} {member.Lastname}
                              </td>
                              <td className="px-6 py-3 text-gray-400">{member.Email || 'N/A'}</td>
                              <td className="px-6 py-3 text-gray-400">
                                {member.PhoneNumber ? 
                                  (member.PhoneNumber.toString().startsWith('+63') 
                                    ? member.PhoneNumber.toString().slice(3)
                                    : member.PhoneNumber)
                                  : 'N/A'}
                              </td>
                              <td className="px-6 py-3">
                                <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                                  member.role === 'Driver'
                                    ? 'bg-blue-900 text-blue-200'
                                    : 'bg-purple-900 text-purple-200'
                                }`}>
                                  {member.role}
                                </span>
                              </td>
                              <td className="px-6 py-3">
                                <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                                  member.IsActive === true
                                    ? 'bg-green-900 text-green-200'
                                    : 'bg-red-900 text-red-200'
                                }`}>
                                  {member.IsActive === true ? 'Active' : 'Inactive'}
                                </span>
                              </td>
                            </tr>
                          ))
                        ) : (
                          <tr className="bg-[#151b28]">
                            <td colSpan="5" className="px-6 py-8 text-center text-gray-400">
                              No members found matching your search.
                            </td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>

                  <div className="mt-4 text-gray-400 text-sm">
                    Total members: <span className="text-yellow-500 font-bold">{filteredMembers.length}</span>
                  </div>
                </div>
              </div>
            )}

            {currentPage === 'audit' && (
              <div className="space-y-6">
                <div>
                  <h2 className="text-2xl font-bold text-white mb-4">Audit Logs</h2>
                  
                  {/* Logs Table */}
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-[#151b28] border-b border-gray-700">
                        <tr>
                          <th className="px-6 py-3 text-left text-gray-400 font-semibold">Timestamp</th>
                          <th className="px-6 py-3 text-left text-gray-400 font-semibold">User</th>
                          <th className="px-6 py-3 text-left text-gray-400 font-semibold">Action</th>
                          <th className="px-6 py-3 text-left text-gray-400 font-semibold">Details</th>
                        </tr>
                      </thead>
                      <tbody>
                        {auditLogs.length > 0 ? (
                          auditLogs.map((log) => (
                            <tr key={log.id} className="bg-[#151b28] hover:bg-[#1a202e] border-b border-gray-700">
                              <td className="px-6 py-3 text-gray-300">
                                {new Date(log.timestamp || 0).toLocaleString()}
                              </td>
                              <td className="px-6 py-3 text-gray-400">{log.user || 'System'}</td>
                              <td className="px-6 py-3">
                                <span className="px-3 py-1 rounded bg-yellow-900 text-yellow-200 text-xs font-medium">
                                  {log.action || 'Unknown'}
                                </span>
                              </td>
                              <td className="px-6 py-3 text-gray-400">{log.details || 'N/A'}</td>
                            </tr>
                          ))
                        ) : (
                          <tr className="bg-[#151b28]">
                            <td colSpan="4" className="px-6 py-8 text-center text-gray-400">
                              No audit logs available.
                            </td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>

                  <div className="mt-4 text-gray-400 text-sm">
                    Total logs: <span className="text-yellow-500 font-bold">{auditLogs.length}</span>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<TodaOfficerDashboard />);
  </script>
</body>
</html>
