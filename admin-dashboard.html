<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pasakay - Admin Dashboard</title>
  <link rel="icon" href="tricy.png" type="image/png">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      onValue,
      get,
      set,
      push,
      remove,
      update,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
    import {
      getStorage,
      ref as storageRef,
      uploadBytes
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBS-g5bFBaJ6a35hWmjvoN-s8FuMEuxtew",
      authDomain: "pasakay-project-ph.firebaseapp.com",
      databaseURL: "https://pasakay-project-ph-default-rtdb.firebaseio.com",
      projectId: "pasakay-project-ph",
      storageBucket: "pasakay-project-ph.firebasestorage.app",
      messagingSenderId: "189297787561",
      appId: "1:189297787561:web:ddad5de3fdf638c6d8dfb8",
      measurementId: "G-2VWQ0C8EZE"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // Sign in anonymously for Storage/Database operations
    signInAnonymously(auth).catch(err => {
      console.error('Anonymous sign-in failed:', err);
    });

    // Monitor auth state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log('✅ Authenticated as:', user.uid);
        window.currentUser = user;
      } else {
        console.warn('⚠️ Not authenticated');
      }
    });

    // Expose DB helpers to the non-module React script
    window.db = db;
    window.dbRef = ref;
    window.dbOnValue = onValue;
    window.dbGet = get;
    window.dbSet = set;
    window.dbPush = push;
    window.dbRemove = remove;
    window.dbUpdate = update;
    window.dbRunTransaction = runTransaction;

    // Expose Storage helpers
    window.storage = storage;
    window.storageRef = storageRef;
    window.uploadBytes = uploadBytes;
  </script>

  <script src="ui-modals.js"></script>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: "Inter", sans-serif;
      background: #0a0e1a;
      margin: 0;
      overflow-x: hidden;
    }
    
    /* Customized Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: #1a2333;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #fbbf24 0%, #f59e0b 100%);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #fcd34d 0%, #fbbf24 100%);
    }
    
    /* Firefox Scrollbar */
    * {
      scrollbar-color: #2e3c57 #1a2333;
      scrollbar-width: thin;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Helper: format license to pattern A00-00-000000 
    const formatLicense = (value) => {
      if (!value) return '';
      const up = value.toUpperCase();
      const raw = up.replace(/[^A-Z0-9]/g, '');
      const p1 = raw.slice(0, 3);
      const p2 = raw.slice(3, 5);
      const p3 = raw.slice(5, 11);
      let formatted = p1;
      if (p2) formatted += '-' + p2;
      if (p3) formatted += '-' + p3;
      return formatted;
    };

    const isValidLicense = (value) => {
      return /^[A-Z]\d{2}-\d{2}-\d{6}$/.test((value||'').toString());
    };
    const normalizeLicenseForCompare = (value) => {
      return (value||'').toString().toUpperCase().replace(/[^A-Z0-9]/g, '');
    };

    // Helper: normalize booking id into several forms
    const normalizeBookingId = (id) => {
      const raw = (id || '').toString();
      const compact = raw.replace(/-/g, '');
      // Extract only digits for numeric conversion
      const digitsOnly = compact.replace(/[^0-9]/g, '');
      let asNumber = null;
      if (digitsOnly) {
        try {
          asNumber = parseInt(digitsOnly, 10);
          if (!Number.isFinite(asNumber) || asNumber <= 0) asNumber = null;
        } catch (e) { /* ignore */ }
      }
      return { raw, compact, asNumber };
    };

    // Hash function to convert Firebase keys to integers (fallback)
    const hashKeyToInt = (key) => {
      let hash = 0;
      for (let i = 0; i < key.length; i++) {
        const char = key.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32-bit integer
      }
      return Math.abs(hash); // Return positive integer
    };

    // Helper: strip +63 prefix for display
    const stripPhonePrefix = (phone) => {
      if (!phone) return '';
      const str = phone.toString();
      if (str.startsWith('+63')) return str.slice(3);
      return str;
    };

    // Helper: check if franchise expiry date has passed (includes expiry date itself)
    const isDateExpired = (dateString) => {
      if (!dateString) return false;
      try {
        const expiryDate = new Date(dateString);
        const today = new Date();
        // Set today to midnight to compare dates only
        today.setHours(0, 0, 0, 0);
        expiryDate.setHours(0, 0, 0, 0);
        // Return true if expiry date <= today (expired on or after expiry date)
        return expiryDate <= today;
      } catch (e) {
        return false;
      }
    };

    const ImportApprovedModal = ({ onClose, approvedApplications, drivers }) => {
      const [importing, setImporting] = useState({});

      const importApplication = async (appId) => {
        if (importing[appId]) return;
        setImporting(prev => ({ ...prev, [appId]: true }));
        try {
          const approvedApp = approvedApplications.find(a => a.id === appId);
          if (!approvedApp) {
            window.showAlert('Application/Driver not found', 'error');
            return;
          }

          const name = approvedApp.Name || ([approvedApp.Firstname, approvedApp.Middlename, approvedApp.Lastname].filter(Boolean).join(' ')) || 'Unnamed';
          const phone = (approvedApp.MobileNumber || approvedApp.Mobile || approvedApp.Contact || '').toString().replace(/\D/g, '').slice(0, 11);
          const licenseRaw = approvedApp.LicenseNumber || approvedApp.license || approvedApp.License || '';
          const license = formatLicense(licenseRaw);
          if (!isValidLicense(license)) {
            window.showAlert('Application has invalid license format: ' + (licenseRaw || ''), 'error');
            return;
          }

          if (approvedApp._source === 'drivers') {
            const userId = approvedApp.UserID;
            try {
              const userRef = window.dbRef(window.db, `users/${userId}`);
              await window.dbUpdate(userRef, { IsActive: true, Status: 'Active' });
              const driverRef = window.dbRef(window.db, `drivers/${appId}`);
              await window.dbUpdate(driverRef, { Status: 'Active', ApplicationStatus: 'ADDED', IsApplying: false });
            } catch(e) {}
            window.showAlert(`${name} has been imported and added to Driver Management!`, 'success');
            return;
          }

          const norm = normalizeLicenseForCompare(license);
          const existsLicense = Object.values(rawDrivers || {}).some(d => normalizeLicenseForCompare(d.LicenseNumber || d.license || '') === norm);
          if (existsLicense) {
            window.showAlert('A driver with this license already exists in the system.', 'error');
            return;
          }

          let userId = approvedApp.UserID;
          if (!userId || !rawUsers[userId]) {
            userId = await claimSmallestNumericId('users');
            const nameParts = (name || '').trim().split(/\s+/);
            const firstname = nameParts[0] || '';
            const lastname = nameParts.length > 1 ? nameParts[nameParts.length - 1] : '';
            const middlename = nameParts.length > 2 ? nameParts.slice(1, -1).join(' ') : '';
            const userData = {
              Firstname: firstname,
              Middlename: middlename,
              Lastname: lastname,
              MobileNumber: phone,
              CreatedAt: new Date().toISOString(),
              Status: 'Active',
              IsActive: true
            };
            await window.dbSet(window.dbRef(window.db, `users/${userId}`), userData);
          }

          const newDriverId = await claimSmallestNumericId('drivers');
          const driverData = {
            UserID: userId,
            LicenseNumber: license,
            TricyclePlateNumber: approvedApp.TricyclePlateNumber || approvedApp.TricycleNumber || approvedApp.tricycle || approvedApp.Tricycle || '',
            TricycleNumber: approvedApp.TricycleNumber || approvedApp.tricycle || approvedApp.Tricycle || '',
            Status: 'Active',
            ApplicationStatus: 'ADDED',
            IsApplying: false,
            CreatedAt: new Date().toISOString()
          };
          await window.dbSet(window.dbRef(window.db, `drivers/${newDriverId}`), driverData);

          // Link user to driver
          try {
            await window.dbUpdate(window.dbRef(window.db, `users/${userId}`), { DriverID: newDriverId });
          } catch (e) {}

          // Update application to link driver and mark as ADDED
          try {
            await window.dbUpdate(window.dbRef(window.db, `applications/${appId}`), { 
              DriverID: newDriverId,
              ApplicationStatus: 'APPROVED - ADDED',
              ImportedAt: new Date().toISOString()
            });
          } catch (e) {}

          window.showAlert(`Imported ${name || 'applicant'} as driver ID ${newDriverId}`, 'success');
        } catch (err) {
          console.error('Error importing application', err);
          window.showAlert('Error importing application: ' + (err && err.message ? err.message : err), 'error');
        } finally {
          setImporting(prev => { const n = { ...prev }; n[appId] = false; return n; });
        }
      };

      const importAll = async () => {
        for (const app of approvedApplications || []) {
          await importApplication(app.id);
        }
      };

      return (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50 overflow-y-auto py-8">
          <div className="bg-[#1e2538] p-6 rounded-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-2xl font-bold text-white">Driver Approved Applications</h2>
              <div className="flex items-center gap-2">
                <button onClick={importAll} className="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-white">Import All</button>
                <button onClick={onClose} className="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-white">Close</button>
              </div>
            </div>
            <p className="text-gray-300 text-sm mb-4">These are the applications that approved by TODA Officer and are not yet present in Driver Management.</p>
            <div className="space-y-3">
              {(approvedApplications && approvedApplications.length) ? approvedApplications.map((app) => (
                <div key={app.id} className="flex justify-between items-center p-4 rounded-lg bg-[#252d42]">
                  <div>
                    <p className="font-bold text-white">{app.Name || [app.Firstname, app.Middlename, app.Lastname].filter(Boolean).join(' ') || app.ApplicantName || 'Unnamed'}</p>
                    <p className="text-sm text-gray-400">License: {formatLicense(app.LicenseNumber || app.license || app.License || '')} | Phone: {stripPhonePrefix(app.MobileNumber || app.Mobile || app.Contact || '')}</p>
                  </div>
                  <div className="flex items-center gap-3">
                    <button onClick={() => importApplication(app.id)} disabled={importing[app.id]} className={`px-4 py-2 rounded font-semibold ${importing[app.id] ? 'bg-gray-600 text-white cursor-not-allowed' : 'bg-yellow-500 text-gray-900 hover:bg-yellow-600'}`}>
                      {importing[app.id] ? 'Importing…' : 'Import'}
                    </button>
                  </div>
                </div>
              )) : (
                <p className="text-gray-400">No approved applications available for import.</p>
              )}
            </div>
          </div>
        </div>
      );
    };

    const AddDriverModal = ({ onClose, onSave }) => {
      const [newDriver, setNewDriver] = useState({
        name: "",
        tricycle: "",
        contact: "",
        license: "",
        status: "Active"
      });
      const [nameError, setNameError] = useState("");
      const [licenseError, setLicenseError] = useState("");
      const [isSaving, setIsSaving] = useState(false);

      const handleChange = (field, value) => {
        if (field === 'contact') {
          const numericValue = value.replace(/\D/g, '').slice(0, 11);
          setNewDriver(prev => ({
            ...prev,
            [field]: numericValue
          }));
        } else if (field === 'name') {
          const hadDigits = /\d/.test(value);
          if (hadDigits) {
            setNameError('Names cannot contain numbers');
          } else {
            setNameError('');
          }
          const sanitized = value.replace(/[^a-zA-Z\s\-']/g, '');
          setNewDriver(prev => ({
            ...prev,
            [field]: sanitized
          }));
        } else {
          setNewDriver(prev => ({
            ...prev,
            [field]: value
          }));
        }
        
        if (field === 'license') {
          const raw = value.replace(/[^A-Za-z0-9\-]/g, '');
          setNewDriver(prev => ({ ...prev, license: raw }));
          setLicenseError('');
        }
      };

      const handleBlur = (field) => {
        if (field === 'license') {
          const formatted = formatLicense(newDriver.license);
          setNewDriver(prev => ({ ...prev, license: formatted }));
          if (!formatted || formatted.length < 13) {
            setLicenseError('License number seems incomplete.');
            return;
          }
          if (!isValidLicense(formatted)) {
            setLicenseError('License must match format A01-23-456789');
          } else {
            setLicenseError('');
          }
        }
      };

      const handleAddDriver = () => {
        if (isSaving) return;
        if (!newDriver.name || !newDriver.tricycle || !newDriver.contact || !newDriver.license) {
          window.showAlert("Please fill in all fields!", 'error');
          return;
        }
        const formattedLicense = formatLicense(newDriver.license);
        const licenseRegex = /^[A-Z]\d{2}-\d{2}-\d{6}$/;
        if (!licenseRegex.test(formattedLicense)) {
          window.showAlert('License number must match format like A01-23-456789', 'error');
          return;
        }
        if (/\d/.test(newDriver.name)) {
          window.showAlert('Full name cannot contain numbers. Please remove any digits.', 'error');
          return;
        }
        if (newDriver.contact.length !== 11) {
          window.showAlert("Phone number must be exactly 11 digits!", 'error');
          return;
        }
        const duplicateTricycle = window.drivers && window.drivers.some(d => d.tricycle === newDriver.tricycle);
        if (duplicateTricycle) {
          window.showAlert("Error: Plate number already exists! Please use a unique plate number.", 'error');
          return;
        }
        try {
          const normNew = normalizeLicenseForCompare(newDriver.license);
          const dup = window.drivers && window.drivers.some(d => normalizeLicenseForCompare(d.license) === normNew);
          if (dup) {
            window.showAlert('License number already exists. Please provide a unique license number.', 'error');
            return;
          }
        } catch(e) {}
        try {
          setIsSaving(true);
          const res = onSave(newDriver);
          if (res && typeof res.then === 'function') {
            res.then(() => setIsSaving(false)).catch(() => setIsSaving(false));
          } else {
            setIsSaving(false);
          }
        } catch (e) {
          setIsSaving(false);
          throw e;
        }
      };

      return (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50">
          <div className="bg-[#1e2538] p-8 rounded-xl w-full max-w-md">
            <h2 className="text-2xl font-bold mb-6 text-white">Add New Driver</h2>
            <div className="grid grid-cols-2 gap-4">
              <input 
                className="col-span-1 px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                placeholder="Full Name" 
                value={newDriver.name}
                onChange={(e) => handleChange('name', e.target.value)}
              />
              {nameError && (
                <p className="col-span-2 text-sm text-red-400 mt-1">{nameError}</p>
              )}
              <input 
                className="col-span-1 px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                placeholder="Tricycle Plate Number" 
                value={newDriver.tricycle}
                onChange={(e) => handleChange('tricycle', e.target.value)}
              />
              <input 
                className="col-span-1 px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                placeholder="Phone Number (11 digits)" 
                value={newDriver.contact}
                onChange={(e) => handleChange('contact', e.target.value)}
                maxLength={11}
              />
              <input 
                className="col-span-1 px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                placeholder="License Number (e.g. A01-23-456789)" 
                value={newDriver.license}
                onChange={(e) => handleChange('license', e.target.value)}
                onBlur={() => handleBlur('license')}
                maxLength={13}
              />
              {licenseError && (
                <p className="col-span-2 text-sm text-red-400 mt-1">{licenseError}</p>
              )}
            </div>
            <p className="text-xs text-gray-400 mt-2">Phone number: {newDriver.contact.length}/11 digits</p>
            <div className="flex justify-between mt-6">
              <button onClick={onClose} className="bg-red-600 hover:bg-red-700 px-8 py-3 rounded-lg font-semibold text-white">Cancel</button>
              <button onClick={handleAddDriver} disabled={isSaving} className={`px-8 py-3 rounded-lg font-semibold text-white ${isSaving ? 'bg-gray-600 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'}`}>
                {isSaving ? 'Adding…' : 'Add Driver'}
              </button>
            </div>
          </div>
        </div>
      );
    };

    const ExportDataModal = ({ drivers, onClose }) => {
      const [selectedDrivers, setSelectedDrivers] = useState([]);

      const toggleDriver = (index) => {
        setSelectedDrivers(prev => 
          prev.includes(index) 
            ? prev.filter(i => i !== index)
            : [...prev, index]
        );
      };

      const exportToCSV = (driversToExport, filename) => {
        const headers = ["Name", "Plate #", "License", "Contact", "Status", "Registered Date", "Franchise Expiry"];
        const csvContent = [
          headers.join(","),
          ...driversToExport.map(driver => 
            `"${driver.name}","${driver.tricycle}","${driver.license}","${driver.contact}","${driver.status}","Jan 15, 2024","Jan 15, 2025"`
          )
        ].join("\n");

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      const handleExportSelected = () => {
        if (selectedDrivers.length === 0) {
          window.showAlert("Please select at least one driver to export!", 'error');
          return;
        }
        const driversToExport = selectedDrivers.map(index => drivers[index]);
        exportToCSV(driversToExport, 'selected_drivers.csv');
        window.showAlert(`Exported ${selectedDrivers.length} driver(s) successfully!`, 'success');
      };

      const handleExportAll = () => {
        exportToCSV(drivers, 'all_drivers.csv');
        window.showAlert(`Exported all ${drivers.length} drivers successfully!`, 'success');
      };

      return (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50 overflow-y-auto py-8">
          <div className="bg-[#1e2538] p-8 rounded-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-white">Export Data</h2>
            <p className="text-gray-300 mb-4 text-sm">Select drivers to export or export all data</p>
            <div className="space-y-3">
              {drivers.map((driver, idx) => (
                <div 
                  key={idx} 
                  onClick={() => toggleDriver(idx)}
                  className={`flex justify-between items-center p-4 rounded-lg cursor-pointer transition-all ${
                    selectedDrivers.includes(idx) 
                      ? 'bg-yellow-500 bg-opacity-20 border-2 border-yellow-500' 
                      : 'bg-[#252d42] border-2 border-transparent hover:border-gray-600'
                  }`}
                >
                  <div className="flex items-center gap-3">
                    <input 
                      type="checkbox" 
                      checked={selectedDrivers.includes(idx)}
                      onChange={() => toggleDriver(idx)}
                      className="w-5 h-5 cursor-pointer"
                    />
                    <div>
                      <p className="font-bold text-white">{driver.name}</p>
                      <p className="text-sm text-gray-400">
                        Plate #{driver.tricycle} | License: {driver.license} | Phone: {stripPhonePrefix(driver.contact)}
                      </p>
                    </div>
                  </div>
                  <span className={`inline-flex items-center justify-center h-9 min-w-[88px] px-4 rounded-lg text-sm font-bold text-white ${driver.status === "Active" ? "bg-green-500" : "bg-gray-500"}`}>
                    {driver.status === "Active" ? "ONLINE" : "OFFLINE"}
                  </span>
                </div>
              ))}
            </div>
            <div className="flex justify-between mt-6">
              <button onClick={onClose} className="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold text-white">Close</button>
              <div className="flex gap-3">
                <button 
                  onClick={handleExportSelected}
                  className="bg-yellow-500 hover:bg-yellow-600 px-6 py-3 rounded-lg font-semibold text-gray-900 flex items-center gap-2"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  Export Selected ({selectedDrivers.length})
                </button>
                <button 
                  onClick={handleExportAll}
                  className="bg-yellow-500 hover:bg-yellow-600 px-6 py-3 rounded-lg font-semibold text-gray-900 flex items-center gap-2"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  Export All ({drivers.length})
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const EditDriverModal = ({ driver, driverIndex, onClose, onSave }) => {
      const formatDateForInput = (iso) => {
        if (!iso) return '';
        try {
          const d = new Date(iso);
          const yyyy = d.getUTCFullYear();
          const mm = String(d.getUTCMonth() + 1).padStart(2, '0');
          const dd = String(d.getUTCDate()).padStart(2, '0');
          return `${yyyy}-${mm}-${dd}`;
        } catch (e) { return ''; }
      };

      const [editedDriver, setEditedDriver] = useState({
        name: driver.name,
        contact: stripPhonePrefix(driver.contact),
        registeredDate: formatDateForInput(driver.registeredDate || ''),
        license: driver.license,
        tricycle: driver.tricycle,
        franchiseExpiry: driver.franchiseExpiry || ''
      });
      const [editedLicenseError, setEditedLicenseError] = useState("");

      const handleChange = (field, value) => {
        if (field === 'contact') {
          const numericValue = value.replace(/\D/g, '').slice(0, 11);
          setEditedDriver(prev => ({
            ...prev,
            [field]: numericValue
          }));
        } else if (field === 'license') {
          const raw = value.replace(/[^A-Za-z0-9\-]/g, '');
          setEditedDriver(prev => ({ ...prev, license: raw }));
          setEditedLicenseError('');
        } else {
          setEditedDriver(prev => ({
            ...prev,
            [field]: value
          }));
        }
      };

      const handleEditBlur = (field) => {
        if (field === 'license') {
          const formatted = formatLicense(editedDriver.license);
          setEditedDriver(prev => ({ ...prev, license: formatted }));
          if (!formatted || formatted.length < 13) {
            setEditedLicenseError('License number seems incomplete.');
            return;
          }
          if (!isValidLicense(formatted)) {
            setEditedLicenseError('License must match format A01-23-456789');
          } else {
            setEditedLicenseError('');
          }
        }
      };

      const handleSave = async () => {
        const contactDigits = editedDriver.contact.toString().replace(/\D/g, '');
        if (contactDigits.length !== 11) {
          window.showAlert("Phone number must be exactly 11 digits!", 'error');
          return;
        }
        if (!isValidLicense(editedDriver.license)) {
          window.showAlert('License number must match format like A01-23-456789', 'error');
          return;
        }
        try {
          const normEdited = normalizeLicenseForCompare(editedDriver.license);
          const dup = window.drivers && window.drivers.some(d => normalizeLicenseForCompare(d.license) === normEdited && d.id !== driver.id);
          if (dup) {
            window.showAlert('License number already exists for another driver. Please use a unique license number.', 'error');
            return;
          }
        } catch(e) {}

        const contactWithPrefix = '+63' + contactDigits;

        try {
          const driverToUpdate = driver || {};
          const driverId = driverToUpdate.driverId || null;
          const userId = driverToUpdate.userId;

          if (userId) {
            const nameParts = (editedDriver.name || '').trim().split(/\s+/);
            const firstname = nameParts[0] || '';
            const lastname = nameParts.length > 1 ? nameParts[nameParts.length - 1] : '';
            const middlename = nameParts.length > 2 ? nameParts.slice(1, -1).join(' ') : '';
            const userRef = window.dbRef(window.db, `users/${userId}`);
            const userSnap = await window.dbGet(userRef);
            const userObj = userSnap.exists() ? userSnap.val() : {};
            userObj.Firstname = firstname;
            userObj.Middlename = middlename;
            userObj.Lastname = lastname;
            userObj.MobileNumber = contactWithPrefix;
            await window.dbSet(userRef, userObj);
          }

          if (driverId) {
            const driverRef = window.dbRef(window.db, `drivers/${driverId}`);
            await window.dbUpdate(driverRef, {
              LicenseNumber: editedDriver.license,
              TricyclePlateNumber: editedDriver.tricycle,
              TricycleNumber: editedDriver.tricycle,
              FranchiseExpiry: editedDriver.franchiseExpiry || ''
            });
          }

          onSave(driverIndex, { ...editedDriver, contact: contactWithPrefix });
          window.showAlert('Driver information updated successfully!', 'success');
          onClose();
        } catch (err) {
          console.error('Error saving driver edits:', err);
          window.showAlert('Error saving changes: ' + (err && err.message ? err.message : err), 'error');
        }
      };

      if (!driver) return null;
      return (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50 p-4">
          <div className="bg-[#1e2538] p-8 rounded-xl w-full max-w-md sm:max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 className="font-bold mb-6 text-white text-2xl">Edit Driver Information</h2>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div className="col-span-2">
                <label className="block text-gray-300 mb-2 font-medium">Driver Name</label>
                <input 
                  className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                  value={editedDriver.name}
                  onChange={(e) => handleChange('name', e.target.value)}
                />
              </div>
              <div>
                <label className="block text-gray-300 mb-2 font-medium">Contact Number (11 digits)</label>
                <div className="flex">
                  <div className="inline-flex items-center px-3 rounded-l-lg bg-[#1b2333] text-white border border-r-0 border-gray-700">+63</div>
                  <input 
                    className="w-full px-4 py-3 rounded-r-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                    value={editedDriver.contact}
                    onChange={(e) => handleChange('contact', e.target.value)}
                    maxLength={11}
                  />
                </div>
                <p className="text-xs text-gray-400 mt-1">{editedDriver.contact.replace(/\D/g, '').length}/11 digits</p>
              </div>
              <div>
                <label className="block text-gray-300 mb-2 font-medium">Registration Date</label>
                <input 
                  type="date" 
                  className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                  value={editedDriver.registeredDate}
                  onChange={(e) => handleChange('registeredDate', e.target.value)}
                />
              </div>
              <div>
                <label className="block text-gray-300 mb-2 font-medium">License Number</label>
                <input 
                  className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                  value={editedDriver.license}
                  onChange={(e) => handleChange('license', e.target.value)}
                  onBlur={() => handleEditBlur('license')}
                />
                {editedLicenseError && (
                  <p className="text-sm text-red-400 mt-1">{editedLicenseError}</p>
                )}
              </div>
              <div>
                <label className="block text-gray-300 mb-2 font-medium">Plate Number</label>
                <input 
                  className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                  value={editedDriver.tricycle}
                  onChange={(e) => handleChange('tricycle', e.target.value)}
                />
              </div>
              <div>
                <label className="block text-gray-300 mb-2 font-medium">Franchise Expiry</label>
                <input 
                  type="date" 
                  className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                  value={editedDriver.franchiseExpiry}
                  onChange={(e) => handleChange('franchiseExpiry', e.target.value)}
                />
              </div>
            </div>
            <div className="flex flex-col sm:flex-row sm:justify-between gap-3 mt-6">
              <button onClick={onClose} className="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold text-white w-full sm:w-auto">Cancel</button>
              <button onClick={handleSave} className="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold text-white w-full sm:w-auto">Save Changes</button>
            </div>
          </div>
        </div>
      );
    };

    const claimSmallestNumericId = async (baseNode) => {
      if (!window.dbGet || !window.dbRef || !window.dbRunTransaction) throw new Error('DB helpers missing');
      const nodeRef = window.dbRef(window.db, baseNode);
      const snap = await window.dbGet(nodeRef);
      const keys = snap && snap.val() ? Object.keys(snap.val()) : [];
      const numericKeys = keys.map(k => parseInt(k, 10)).filter(n => Number.isInteger(n) && n > 0);
      const max = numericKeys.length ? Math.max(...numericKeys) : 0;

      for (let candidate = 1; candidate <= max; candidate++) {
        if (!numericKeys.includes(candidate)) {
          const allocRef = window.dbRef(window.db, `allocations/${baseNode}/${candidate}`);
          try {
            const tx = await window.dbRunTransaction(allocRef, (current) => {
              if (current) return;
              return { reservedAt: Date.now() };
            });
            if (tx && tx.committed) {
              return candidate;
            }
          } catch (e) {}
        }
      }

      const newId = max + 1;
      const allocRef2 = window.dbRef(window.db, `allocations/${baseNode}/${newId}`);
      await window.dbRunTransaction(allocRef2, (current) => {
        if (current) return;
        return { reservedAt: Date.now() };
      });
      return newId;
    };

    const AdminDashboard = () => {
      const [currentTab, setCurrentTab] = useState('overview');
      const [selectedDriver, setSelectedDriver] = useState(null);
      const [selectedDriverIndex, setSelectedDriverIndex] = useState(null);
      const [selectedBooking, setSelectedBooking] = useState(null);
      const [showExportModal, setShowExportModal] = useState(false);
      const [showAddModal, setShowAddModal] = useState(false);
      const [confirmDelete, setConfirmDelete] = useState({ open: false, index: null });

      const [rawUsers, setRawUsers] = useState({});
      const [rawDrivers, setRawDrivers] = useState({});
      const [rawApplications, setRawApplications] = useState({});
      const [rawBookings, setRawBookings] = useState({});
      const [rawPassengers, setRawPassengers] = useState({});
      const [rawFeedback, setRawFeedback] = useState({});
      const [rawAuditLogs, setRawAuditLogs] = useState({});
      const [drivers, setDrivers] = useState([]);
      const [bookings, setBookings] = useState([]);
      const [passengers, setPassengers] = useState([]);
      const [rideHistory, setRideHistory] = useState([]);
      const [auditLogs, setAuditLogs] = useState([]);
      const [showImportModal, setShowImportModal] = useState(false);
      
      // Booking filtering states
      const [dateFromBooking, setDateFromBooking] = useState("");
      const [dateToBooking, setDateToBooking] = useState("");
      const [selectedDriverBooking, setSelectedDriverBooking] = useState("All Drivers");
      const [statusFiltersBooking, setStatusFiltersBooking] = useState({ Completed: true, Pending: true, Cancelled: true });
      const [showBookingFilterModal, setShowBookingFilterModal] = useState(false);
      const [filteredBookings, setFilteredBookings] = useState([]);
      
      // Passenger filtering states
      const [searchQuery, setSearchQuery] = useState("");
      const [startDate, setStartDate] = useState("");
      const [endDate, setEndDate] = useState("");
      const [showPassengerFilterModal, setShowPassengerFilterModal] = useState(false);
      const [selectedPassenger, setSelectedPassenger] = useState(null);
      const [selectedPassengerIndex, setSelectedPassengerIndex] = useState(null);
      
      // Overview search state
      const [overviewSearchQuery, setOverviewSearchQuery] = useState("");
      const [showEditPassengerModal, setShowEditPassengerModal] = useState(false);
      const [emailError, setEmailError] = useState("");
      const [phoneError, setPhoneError] = useState("");
      
      // Logs search state
      const [logsSearchTerm, setLogsSearchTerm] = useState("");
      const [filteredLogs, setFilteredLogs] = useState([]);
      
      // Driver filtering states
      const [showDriverFilterModal, setShowDriverFilterModal] = useState(false);
      const [driverStatusFilters, setDriverStatusFilters] = useState({ Active: true, Inactive: false });
      const [driverOnlineFilters, setDriverOnlineFilters] = useState({ Online: true, Offline: false });
      const [filteredDrivers, setFilteredDrivers] = useState([]);

      useEffect(() => {
        if (!window.db || !window.dbRef || !window.dbOnValue) return;

        const usersRef = window.dbRef(window.db, 'users');
        const driversRef = window.dbRef(window.db, 'drivers');
        const applicationsRef = window.dbRef(window.db, 'applications');
        const bookingsRef = window.dbRef(window.db, 'bookings');
        const passengersRef = window.dbRef(window.db, 'passengers');
        const feedbackRef = window.dbRef(window.db, 'feedback');
        const auditLogsRef = window.dbRef(window.db, 'auditLogs');

        const unsubUsers = window.dbOnValue(usersRef, snap => setRawUsers(snap.val() || {}));
        const unsubDrivers = window.dbOnValue(driversRef, snap => setRawDrivers(snap.val() || {}));
        const unsubApplications = window.dbOnValue(applicationsRef, snap => setRawApplications(snap.val() || {}));
        const unsubBookings = window.dbOnValue(bookingsRef, snap => setRawBookings(snap.val() || {}));
        const unsubPassengers = window.dbOnValue(passengersRef, snap => setRawPassengers(snap.val() || {}));
        const unsubFeedback = window.dbOnValue(feedbackRef, snap => setRawFeedback(snap.val() || {}));
        const unsubAuditLogs = window.dbOnValue(auditLogsRef, snap => setRawAuditLogs(snap.val() || {}));

        return () => {
          try { unsubUsers(); } catch(e) {}
          try { unsubDrivers(); } catch(e) {}
          try { unsubApplications(); } catch(e) {}
          try { unsubBookings(); } catch(e) {}
          try { unsubPassengers(); } catch(e) {}
          try { unsubFeedback(); } catch(e) {}
          try { unsubAuditLogs(); } catch(e) {}
        };
      }, []);

      // Derived list: approved drivers/applications available for import (similar to Driver Management page)
      const approvedApplications = (() => {
        try {
          const drvs = rawDrivers || {};
          const allDriversFromDb = Object.entries(drvs).map(([id, d]) => {
            if (!d || !d.UserID) return null;
            const user = rawUsers && rawUsers[d.UserID];
            if (!user || user.DeletedAt) return null;
            const name = user ? [user.Firstname, user.Middlename, user.Lastname].filter(Boolean).join(' ') : 'Unnamed';
            const phone = user ? user.MobileNumber : '';
            const status = (d.ApplicationStatus || d.Status || '').toString().toUpperCase().trim();
            return {
              id,
              UserID: d.UserID,
              LicenseNumber: d.LicenseNumber || '',
              TricycleNumber: d.TricycleNumber || d.TricyclePlateNumber || '',
              TricyclePlateNumber: d.TricyclePlateNumber || d.TricycleNumber || '',
              ApplicationStatus: status,
              Name: name,
              MobileNumber: phone,
              Firstname: user ? user.Firstname : '',
              Middlename: user ? user.Middlename : '',
              Lastname: user ? user.Lastname : '',
              _source: 'drivers',
              _status: status
            };
          }).filter(Boolean);

          const apps = rawApplications || {};
          const appsArr = Object.entries(apps).map(([id, a]) => {
            if (a.DriverID) return null;
            const userId = a.UserID;
            const user = userId && rawUsers && rawUsers[userId];
            if (!user || user.DeletedAt) return null;
            const name = user ? [user.Firstname, user.Middlename, user.Lastname].filter(Boolean).join(' ') : (a.Name || a.ApplicantName || 'Unnamed');
            const phone = user ? user.MobileNumber : (a.MobileNumber || a.Contact || a.Mobile || '');
            const status = (a.ApplicationStatus || a.Status || '').toString().toUpperCase().trim();
            return {
              id,
              ...a,
              Name: name,
              Firstname: user ? user.Firstname : a.Firstname,
              Middlename: user ? user.Middlename : a.Middlename,
              Lastname: user ? user.Lastname : a.Lastname,
              MobileNumber: phone,
              UserID: userId,
              _source: 'applications',
              _status: status
            };
          }).filter(Boolean);

          const allApproved = [...allDriversFromDb, ...appsArr].filter(a => {
            const status = a._status || '';
            return status.includes('APPROVED');
          });

          const filtered = allApproved.filter(a => {
            const alreadyExists = drivers.some(d => {
              if (a.LicenseNumber) {
                const match = normalizeLicenseForCompare(d.license) === normalizeLicenseForCompare(a.LicenseNumber);
                if (match) return true;
              }
              if (a.UserID) {
                const match = d.userId === a.UserID;
                if (match) return true;
              }
              return false;
            });
            return !alreadyExists;
          });

          return filtered;
        } catch (e) { return []; }
      })();

      useEffect(() => {
        const makeFullName = (u) => {
          if (!u) return 'Unknown';
          return [u.Firstname, u.Middlename, u.Lastname].filter(Boolean).join(' ');
        };

        const usersVal = rawUsers || {};
        const drvsVal = rawDrivers || {};
        const driversArr = Object.entries(usersVal)
          .map(([userId, u]) => {
            if (!u) return null;
            if (String(u.RoleID) !== '2') return null;
            // Only include drivers whose linked user record is active
            if (!u.IsActive) return null;
            if (u.DeletedAt) return null;

            let drvKey = null;
            let drvRec = null;
            for (const [k, drv] of Object.entries(drvsVal)) {
              if (!drv) continue;
              if (String(drv.UserID) === String(userId)) { drvKey = k; drvRec = drv; break; }
            }

            const name = makeFullName(u);
            const tricycle = drvRec ? (drvRec.TricyclePlateNumber || drvRec.TricycleNumber || '') : '';
            const license = drvRec ? (drvRec.LicenseNumber || '') : '';
            const contact = u ? u.MobileNumber : '';
            const franchiseExpiry = drvRec ? (drvRec.FranchiseExpiry || '') : '';
            
            // Determine status primarily from the user record; fall back to driver application status and franchise expiry
            const franchiseHasExpired = isDateExpired(franchiseExpiry);
            const appStatus = (drvRec ? (drvRec.ApplicationStatus || drvRec.Status || '') : '').toString().toUpperCase();
            const userStatusRaw = (u.Status || '').toString().toUpperCase();

            const isAppStatusExpired = appStatus.includes('EXPIRED');
            const isAppStatusRejected = appStatus.includes('REJECTED');
            const isUserStatusExpired = userStatusRaw.includes('EXPIRED');
            const isUserStatusRejected = userStatusRaw.includes('REJECTED');

            let status = 'Inactive';
            if (isUserStatusExpired || isUserStatusRejected || isAppStatusExpired || isAppStatusRejected || franchiseHasExpired) {
              status = 'Inactive';
            } else if (userStatusRaw.includes('ACTIVE') || appStatus.includes('ADDED') || (drvRec && drvRec.Status === 'Active')) {
              status = 'Active';
            } else {
              status = u.IsActive ? 'Active' : 'Inactive';
            }

            return {
              id: drvKey || `user-${userId}`,
              driverId: drvKey || null,
              userId: userId,
              name,
              tricycle,
              license,
              contact,
              status,
              isActiveUser: !!u.IsActive,
              registeredDate: u.CreatedAt || '' ,
              franchiseExpiry: franchiseExpiry,
              isExpired: franchiseHasExpired || isAppStatusExpired || isAppStatusRejected || isUserStatusExpired || isUserStatusRejected
            };
          })
          .filter(Boolean);

        setDrivers(driversArr);
        window.drivers = driversArr;
      }, [rawUsers, rawDrivers]);

      // Auto-expire/reject drivers when franchise expiry date has passed or status is REJECTED
      useEffect(() => {
        if (!window.db || !window.dbRef || !window.dbUpdate) return;
        
        drivers.forEach(driver => {
          if (driver.isExpired && driver.driverId && driver.status === 'Active') {
            // Driver's franchise has expired or is rejected but status is still Active - update it
            const driverRef = window.dbRef(window.db, `drivers/${driver.driverId}`);
            const driverRec = rawDrivers && rawDrivers[driver.driverId];
            const currentAppStatus = (driverRec ? (driverRec.ApplicationStatus || driverRec.Status || '') : '').toString().toUpperCase();
            
            // If already REJECTED, don't overwrite it. Otherwise, set to EXPIRED if franchise expired
            let newStatus = 'EXPIRED';
            if (currentAppStatus.includes('REJECTED')) {
              newStatus = 'REJECTED';
            }
            
            // Update the driver application status and mark the linked user as inactive (Status moved to users/)
            window.dbUpdate(driverRef, {
              ApplicationStatus: newStatus
            }).catch(err => console.error('Error updating driver ApplicationStatus:', err));

            // Also update the user's Status and IsActive
            if (driver.userId) {
              const userRef = window.dbRef(window.db, `users/${driver.userId}`);
              window.dbUpdate(userRef, {
                Status: newStatus,
                IsActive: false
              }).catch(err => console.error('Error updating user Status/IsActive:', err));
            }
          }
        });
      }, [drivers, rawDrivers]);

      // Derive bookings array for stats calculation
      useEffect(() => {
        try {
          const bookingsVal = rawBookings || {};
          const makeFullName = (u) => {
            if (!u) return 'Unknown';
            return [u.Firstname, u.Middlename, u.Lastname].filter(Boolean).join(' ');
          };

          const bookingsArr = Object.entries(rawBookings || {}).map(([key, b]) => {
            if (!b) return null;

            // Resolve passenger -> try several mappings (passenger record, booking.UserID, or users list)
            let passengerUser = null;
            let passengerUserId = null;
            try {
              // Prefer booking.userId first
              if (b.userId && rawUsers && rawUsers[b.userId]) {
                passengerUserId = String(b.userId);
                passengerUser = rawUsers[b.userId];
              } 
              // Then try PassengerID -> rawPassengers -> UserID
              else if (b.PassengerID) {
                const passengerRec = rawPassengers && rawPassengers[b.PassengerID];
                if (passengerRec && passengerRec.UserID && rawUsers && rawUsers[passengerRec.UserID]) {
                  passengerUserId = String(passengerRec.UserID);
                  passengerUser = rawUsers[passengerUserId];
                } else {
                  // Fallback: search users for matching PassengerID
                  Object.entries(rawUsers || {}).some(([uId, u]) => {
                    if (u && u.PassengerID && String(u.PassengerID) === String(b.PassengerID)) {
                      passengerUserId = uId;
                      passengerUser = u;
                      return true;
                    }
                    return false;
                  });
                }
              }
            } catch (e) {
              passengerUser = null;
              passengerUserId = null;
            }

            // Get driver info using driverId from bookings path - try multiple field names
            let driverId = b.driverId || b.DriverID || null;
            let driverRec = null;
            let driverUser = null;
            
            if (driverId) {
              driverRec = rawDrivers && rawDrivers[driverId];
              if (driverRec && driverRec.UserID) {
                driverUser = rawUsers && rawUsers[driverRec.UserID];
              }
            }
            
            // If driver not found by ID, try to search drivers by matching user
            if (!driverRec && b.DriverID) {
              for (const [k, d] of Object.entries(rawDrivers || {})) {
                if (String(d.UserID) === String(b.DriverID)) {
                  driverId = k;
                  driverRec = d;
                  driverUser = rawUsers && rawUsers[d.UserID];
                  break;
                }
              }
            }

            // Format date/time and compute timestamp
            const requested = b.RequestedAt || '';
            let dateOnly = '';
            let timeOnly = '';
            let requestedTs = null;
            if (requested) {
              const dateObj = new Date(requested);
              const ts = dateObj.getTime();
              if (!isNaN(ts)) {
                requestedTs = ts;
                dateOnly = dateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                timeOnly = dateObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
              }
            }
            const date = dateOnly;
            const time = timeOnly;

            // Prefer a driverSnapshot stored on the booking (backfilled or captured at assignment time)
            const dSnap = b.driverSnapshot || null;
            let driverName = 'Driver';
            let driverTricycle = 'N/A';
            let driverLicense = 'N/A';
            if (dSnap && dSnap.name) {
              driverName = dSnap.name;
              driverTricycle = dSnap.tricycle || 'N/A';
              driverLicense = dSnap.license || 'N/A';
            } else if (driverUser) {
              driverName = makeFullName(driverUser);
              driverTricycle = driverRec ? (driverRec.TricycleNumber || 'N/A') : 'N/A';
              driverLicense = driverRec ? (driverRec.LicenseNumber || 'N/A') : 'N/A';
            }

            const makeFullNameLocal = (u) => {
              if (!u) return null;
              const name = [u.Firstname, u.Middlename, u.Lastname].filter(Boolean).join(' ');
              return name || null;
            };
            // Try to get passenger name from user record first, fall back to userName field
            const passengerName = passengerUser ? makeFullNameLocal(passengerUser) : null;
            const finalPassengerName = passengerName || b.userName || b.PassengerName || 'Unknown';
            const passengerDisplayId = passengerUserId || b.PassengerID || '';

            const statusNormalized = (b.Status || 'Unknown').charAt(0).toUpperCase() + (b.Status || 'Unknown').slice(1).toLowerCase();
            
            // Only include valid statuses: Completed, Pending, Cancelled
            const validStatuses = ['Completed', 'Pending', 'Cancelled'];
            if (!validStatuses.includes(statusNormalized)) {
              return null;
            }

            return {
              id: parseInt(key) || hashKeyToInt(key),
              bookingIdNumeric: parseInt(key) || hashKeyToInt(key),
              raw: b,
              passengerUserId: passengerUserId,
              passengerId: passengerDisplayId,
              passengerName: finalPassengerName,
              passenger: finalPassengerName,
              driverName: driverName,
              driver: driverName,
              driverTricycle: driverTricycle,
              driverLicense: driverLicense,
              pickup: b.PickupLocation || b.PickUpLocation || '',
              destination: b.DropoffLocation || b.DropOffLocation || '',
              fare: b.TotalFare || b.TotalFare || 0,
              distance: b.distanceKm ? `${b.distanceKm}km` : '',
              status: statusNormalized,
              statusNormalized: statusNormalized,
              requestedAt: b.RequestedAt || '',
              requestedTs,
              date: date,
              time: time
            };
          }).filter(Boolean);
          
          setBookings(bookingsArr);
          setFilteredBookings(bookingsArr);
        } catch (e) {
          console.error('Error deriving bookings:', e);
        }
      }, [rawBookings, rawUsers, rawDrivers, rawPassengers]);

      // Derive passengers array - MATCHING passenger management.html logic
      useEffect(() => {
        try {
          const makeFullName = (u) => {
            if (!u) return 'Unknown';
            return [u.Firstname, u.Middlename, u.Lastname].filter(Boolean).join(' ');
          };

          // Build passengers from users node - filter by RoleID = 3 (Passenger)
          const passengersArr = [];
          Object.entries(rawUsers || {}).forEach(([userId, userObj]) => {
            try {
              // Filter: RoleID must be 3 (Passenger) - strict check
              const roleId = userObj.RoleID ? String(userObj.RoleID).trim() : '';
              if (roleId !== '3') return;

              // Ensure PassengerID exists
              const passengerID = userObj.PassengerID ? String(userObj.PassengerID).trim() : '';
              if (!passengerID) return;

              const name = makeFullName(userObj);
              const initials = name.split(" ").map(n => n[0]).join("").slice(0, 2).toUpperCase();
              
              // Count total rides for this passenger using multiple possible mappings
              const totalRides = Object.values(rawBookings || {}).filter(b => {
                if (!b) return false;
                try {
                  if (b.PassengerID && String(b.PassengerID) === passengerID) return true;
                  if (b.userId && String(b.userId) === String(userId)) return true;
                  if (b.PassengerUserID && String(b.PassengerUserID) === String(userId)) return true;
                } catch (e) {
                  return false;
                }
                return false;
              }).length;
              
              // Normalize phone for display: if stored as +63XXXXXXXXXX or
              // XXXXXXXXXX (10 digits), show as 0XXXXXXXXXX. Otherwise keep digits as-is.
              let rawPhone = userObj.MobileNumber || '';
              let displayPhone = '';
              if (rawPhone) {
                const s = rawPhone.toString();
                // If it starts with +63, strip it first
                let stripped = s.startsWith('+63') ? s.slice(3) : s;
                // Keep only digits
                const digits = stripped.replace(/\D/g, '');
                if (digits.length === 10) displayPhone = '0' + digits;
                else displayPhone = digits;
              }

              passengersArr.push({
                id: passengerID,
                userId,
                initials,
                name,
                phone: displayPhone,
                email: userObj.Email || '',
                rides: totalRides,
                status: userObj.IsActive ? 'ACTIVE' : 'INACTIVE'
              });
            } catch (e) {
              // ignore parsing errors for malformed user objects
              console.warn('Error processing user:', userId, e);
            }
          });

          // Build ride history
          const historyArr = [];
          Object.entries(rawBookings || {}).forEach(([bookingId, b]) => {
            // Resolve passenger for history: prefer booking.userId, then PassengerID -> users mapping
            let passengerUser = null;
            let passengerIdDisplay = b.PassengerID || b.userId || '';

            if (b.userId && rawUsers && rawUsers[b.userId]) {
              passengerUser = rawUsers[b.userId];
              passengerIdDisplay = b.userId;
            } else if (b.PassengerID) {
              // If passengers node links to a user, prefer that
              const passengerRec = rawPassengers && rawPassengers[b.PassengerID];
              if (passengerRec && passengerRec.UserID && rawUsers && rawUsers[passengerRec.UserID]) {
                passengerUser = rawUsers[passengerRec.UserID];
                passengerIdDisplay = passengerRec.UserID;
              } else {
                // Fallback: search users for matching PassengerID
                Object.entries(rawUsers || {}).some(([userId, u]) => {
                  if (u && u.PassengerID && String(u.PassengerID) === String(b.PassengerID)) {
                    passengerUser = u;
                    passengerIdDisplay = userId;
                    return true;
                  }
                  return false;
                });
              }
            }
            
            const driverRec = rawDrivers && rawDrivers[b.DriverID];
            const driverUser = driverRec ? rawUsers[driverRec.UserID] : null;
            const passengerName = passengerUser ? makeFullName(passengerUser) : 'Passenger';
            const driverName = driverUser ? makeFullName(driverUser) : 'Driver';
            
            // Get feedback/rating for this booking
            const feedback = Object.values(rawFeedback || {}).find(f => String(f.BookingID) === String(bookingId));
            const rating = feedback ? `${feedback.Rating}/5` : 'No rating';
            
            let historyFormattedDate = '';
            if (b.RequestedAt) {
              const dObj = new Date(b.RequestedAt);
              const monthN = dObj.toLocaleString('en-US', { month: 'long' });
              const dayN = dObj.getDate();
              const yearN = dObj.getFullYear();
              const timeN = dObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
              historyFormattedDate = `${monthN} ${dayN}, ${yearN} ${timeN}`;
            }

            // Only include completed, cancelled, and pending rides in history
            // Pending rides are shown temporarily but should be cleared when status changes
            const bookingStatus = (b.Status || b.status || '').toString().toUpperCase();
            const isCompleted = bookingStatus.includes('COMPLETED');
            const isCancelled = bookingStatus.includes('CANCELLED') || bookingStatus.includes('CANCELED');
            const isPending = bookingStatus.includes('PENDING') || bookingStatus === '';
            
            if (isCompleted || isCancelled || isPending) {
              historyArr.push({
                passengerId: passengerIdDisplay,
                passengerName,
                driverName,
                fare: `₱ ${Number(b.TotalFare || 0).toFixed(2)}`,
                tricycleNo: driverRec ? driverRec.TricycleNumber : 'Unknown',
                pickup: b.PickUpLocation || '',
                dropOff: b.DropOffLocation || '',
                payment: 'Cash', // TODO: get from payment table if available
                rating,
                date: historyFormattedDate,
                status: bookingStatus,
                isPending: isPending
              });
            }
          });

          setPassengers(passengersArr);
          setRideHistory(historyArr);
        } catch (e) {
          console.error('Error deriving passengers:', e);
        }
      }, [rawUsers, rawPassengers, rawDrivers, rawBookings, rawFeedback]);

      // Derive audit logs - MATCHING Logs.html logic
      useEffect(() => {
        try {
          const logsVal = rawAuditLogs || {};
          const logsArr = Object.entries(logsVal).map(([key, log], index) => {
            if (!log) return null;
            const driverId = log.DriverID || '';
            
            // Prefer live lookup (driver -> user) when available, otherwise fall back to stored name in log
            let driverName = '';
            try {
              const drv = rawDrivers && rawDrivers[driverId];
              // If driver exists and has a linked user, prefer the canonical user's full name
              if (drv && drv.UserID && rawUsers && rawUsers[drv.UserID]) {
                const u = rawUsers[drv.UserID];
                driverName = [u.Firstname, u.Middlename, u.Lastname].filter(Boolean).join(' ');
              }

              // If no linked user, use driver record's name if present
              if (!driverName && drv) {
                driverName = drv.Name || drv.name || drv.FullName || '';
              }

              // Fallback to stored name on the log or the id
              if (!driverName) driverName = log.DriverName || log.driver || driverId || 'Unknown Driver';
            } catch (e) {
              driverName = log.DriverName || log.driver || driverId || 'Unknown Driver';
            }
            
            // Format timestamp to yyyy-mm-dd
            const formatDate = (timestamp) => {
              if (!timestamp) return '';
              const date = new Date(timestamp);
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const day = String(date.getDate()).padStart(2, '0');
              return `${year}-${month}-${day}`;
            };
            
            return {
              id: `LOG${String(index + 1).padStart(3, '0')}`,
              dbKey: key,
              bookingId: log.BookingID || log.rideId || '',
              driver: driverName,
              driverId: driverId,
              event: log.ViolationType || log.event || '',
              location: log.Location || log.location || '',
              timestamp: formatDate(log.ViolationTimestamp || log.timestamp || ''),
              status: log.IsFlaggedForReview ? 'Flagged' : (log.status || 'Reviewed')
            };
          }).filter(Boolean);
          
          setAuditLogs(logsArr);
          setFilteredLogs(logsArr);
        } catch (e) {
          console.error('Error deriving audit logs:', e);
        }
      }, [rawAuditLogs, rawDrivers, rawUsers]);

      // Apply booking filters - MATCHING booking management.html logic
      const applyBookingFilters = () => {
        let filtered = [...bookings];

        // Filter by date range (use numeric timestamps when available)
        if (dateFromBooking) {
          const fromTs = new Date(dateFromBooking + 'T00:00:00').getTime();
          filtered = filtered.filter(b => b.requestedTs && b.requestedTs >= fromTs);
        }
        if (dateToBooking) {
          const toTs = new Date(dateToBooking + 'T23:59:59.999').getTime();
          filtered = filtered.filter(b => b.requestedTs && b.requestedTs <= toTs);
        }

        // Filter by driver
        if (selectedDriverBooking !== "All Drivers") {
          filtered = filtered.filter(b => b.driver === selectedDriverBooking);
        }

        // Filter by status
        filtered = filtered.filter(b => statusFiltersBooking[b.status]);

        setFilteredBookings(filtered);
        setShowBookingFilterModal(false);
      };

      // Apply driver filters with independent filter logic
      const applyDriverFilters = () => {
        let filtered = [...drivers];

        // Determine which filter categories have selections
        const accountStatusChecked = driverStatusFilters.Active || driverStatusFilters.Inactive;
        const onlineStatusChecked = driverOnlineFilters.Online || driverOnlineFilters.Offline;

        // If at least one filter is active, apply filtering
        if (accountStatusChecked || onlineStatusChecked) {
          filtered = filtered.filter(d => {
            const isActive = d.isActiveUser;
            const isOnline = d.status === 'Active';

            // Check account status condition
            const matchesAccountStatus = !accountStatusChecked || 
              (isActive && driverStatusFilters.Active) || 
              (!isActive && driverStatusFilters.Inactive);

            // Check online status condition
            const matchesOnlineStatus = !onlineStatusChecked || 
              (isOnline && driverOnlineFilters.Online) || 
              (!isOnline && driverOnlineFilters.Offline);

            // Both conditions must be true (or be inactive/not checked)
            return matchesAccountStatus && matchesOnlineStatus;
          });
        }

        setFilteredDrivers(filtered);
        setShowDriverFilterModal(false);
      };

      // Initialize filtered drivers on mount and when drivers change
      useEffect(() => {
        setFilteredDrivers(drivers);
      }, [drivers]);

      // Filter rides based on search query and date range - MATCHING passenger management.html logic
      const getFilteredRides = () => {
        let filtered = [...rideHistory];

        // Filter by passenger ID, passenger name, driver name, tricycle number, or pickup/dropoff location
        if (searchQuery && searchQuery.trim()) {
          const query = searchQuery.toLowerCase();
          filtered = filtered.filter(ride => {
            const passengerId = (ride.passengerId || '').toLowerCase();
            const passengerName = (ride.passengerName || '').toLowerCase();
            const driverName = (ride.driverName || '').toLowerCase();
            const tricycleNo = (ride.tricycleNo || '').toLowerCase();
            const pickup = (ride.pickup || '').toLowerCase();
            const dropOff = (ride.dropOff || '').toLowerCase();
            
            return passengerId.includes(query) || 
                   passengerName.includes(query) ||
                   driverName.includes(query) ||
                   tricycleNo.includes(query) ||
                   pickup.includes(query) ||
                   dropOff.includes(query);
          });
        }

        // Filter by date range - using string comparison for consistency
        if (startDate && startDate.trim()) {
          filtered = filtered.filter(ride => {
            return ride.date >= startDate;
          });
        }
        if (endDate && endDate.trim()) {
          filtered = filtered.filter(ride => {
            return ride.date <= endDate;
          });
        }

        return filtered;
      };

      // Passenger edit handlers - MATCHING passenger management.html logic
      const handleEditPassenger = (passenger, index) => {
        // Display a leading 0 whenever the stripped phone has 10 digits.
        // This handles values that come either as +63XXXXXXXXX or as
        // XXXXXXXXXX (10 digits) by showing 0XXXXXXXXXX in the input.
        let displayPhone = stripPhonePrefix(passenger.phone);
        const digits = displayPhone.toString().replace(/\D/g, '');
        if (digits.length === 10) {
          if (!displayPhone.startsWith('0')) displayPhone = '0' + digits;
        }
        setSelectedPassenger({ ...passenger, phone: displayPhone });
        setSelectedPassengerIndex(index);
        setShowEditPassengerModal(true);
      };

      const handleClosePassengerModal = () => {
        setShowEditPassengerModal(false);
        setSelectedPassenger(null);
        setSelectedPassengerIndex(null);
        setEmailError("");
        setPhoneError("");
      };

      const handleSavePassenger = async () => {
        if (selectedPassengerIndex !== null) {
          try {
            const passengerToUpdate = passengers[selectedPassengerIndex];
            const passengerId = passengerToUpdate.id;
            const userId = passengerToUpdate.userId;

            // Split the name into first, middle, last
            const nameParts = selectedPassenger.name.trim().split(/\s+/);
            const firstname = nameParts[0] || '';
            const lastname = nameParts.length > 1 ? nameParts[nameParts.length - 1] : '';
            const middlename = nameParts.length > 2 ? nameParts.slice(1, -1).join(' ') : (nameParts.length === 2 ? '' : '');

            // Validate contact number: extract digits only and ensure exactly 11 digits.
            // For display we show leading 0, but save without it to database.
            const phoneInput = (selectedPassenger.phone || '').toString();
            const phoneDigits = phoneInput.replace(/\D/g, '');

            if (phoneDigits.length !== 11) {
              window.showAlert('Contact number must be exactly 11 digits', 'error');
              return;
            }

            // Save phone without the leading 0 (strip if present)
            let phoneRaw = phoneDigits;
            if (phoneRaw.startsWith('0')) {
              phoneRaw = phoneRaw.slice(1);
            }

            // Prepare email: enforce gmail.com domain. If user didn't include domain, append @gmail.com
            let emailRaw = (selectedPassenger.email || '').toString().trim().toLowerCase();
            if (!emailRaw.includes('@')) {
              emailRaw = emailRaw + '@gmail.com';
            }
            const emailDomain = emailRaw.split('@')[1] || '';
            if (emailDomain !== 'gmail.com') {
              window.showAlert('Email must be on \"gmail.com\" format', 'error');
              return;
            }

            // Update user record in Firebase
            const userRef = window.dbRef(window.db, `users/${userId}`);
            await window.dbUpdate(userRef, {
              Firstname: firstname,
              Middlename: middlename,
              Lastname: lastname,
              MobileNumber: phoneRaw,
              Email: emailRaw
            });

            // Update local state (will also be updated by realtime listener)
            const updatedPassengers = [...passengers];
            updatedPassengers[selectedPassengerIndex] = {
              ...updatedPassengers[selectedPassengerIndex],
              name: selectedPassenger.name,
              email: emailRaw,
              phone: phoneRaw
            };
            setPassengers(updatedPassengers);
            window.showAlert("Changes saved for " + selectedPassenger.name, 'success');
            handleClosePassengerModal();
          } catch (error) {
            console.error('Error saving passenger:', error);
            window.showAlert('Error saving changes: ' + error.message, 'error');
          }
        }
      };

      // Filter logs by search term - MATCHING Logs.html logic
      useEffect(() => {
        const term = (logsSearchTerm || '').toString().toLowerCase();
        const filtered = auditLogs.filter(log =>
          (log.id || '').toString().toLowerCase().includes(term) ||
          (log.bookingId || '').toString().toLowerCase().includes(term) ||
          (log.driver || '').toString().toLowerCase().includes(term) ||
          (log.event || '').toString().toLowerCase().includes(term) ||
          (log.location || '').toString().toLowerCase().includes(term) ||
          (log.status || '').toString().toLowerCase().includes(term)
        );
        setFilteredLogs(filtered);
      }, [logsSearchTerm, auditLogs]);

      // Status badge color helper - MATCHING dashboard.html
      const statusBadgeClass = (status) => {
        const s = (status || '').toString().toLowerCase();
        if (s === 'completed') return 'bg-green-500 text-white';
        if (s === 'pending') return 'bg-yellow-400 text-black';
        if (s === 'cancelled' || s === 'canceled') return 'bg-red-600 text-white';
        if (s.includes('progress')) return 'bg-gray-500 text-white';
        return 'bg-gray-500 text-white';
      };

      // Handle audit log status change - MATCHING Logs.html logic
      const handleLogStatusChange = (dbKey, currentStatus) => {
        if (!window.db || !window.dbRef || !window.dbUpdate) return;
        const newStatus = currentStatus === 'Flagged' ? false : true;
        const logRef = window.dbRef(window.db, `auditLogs/${dbKey}`);
        window.dbUpdate(logRef, { IsFlaggedForReview: newStatus })
          .catch(err => console.error('Error updating status:', err));
      };

      const handleEditDriver = (index) => {
        setSelectedDriver(drivers[index]);
        setSelectedDriverIndex(index);
      };

      const handleSaveDriver = async (index, editedDriver) => {
        try {
          const driverToUpdate = drivers[index];
          const driverId = driverToUpdate.id;
          const userId = driverToUpdate.userId;

          const nameParts = editedDriver.name.trim().split(/\s+/);
          const firstname = nameParts[0] || '';
          const lastname = nameParts.length > 1 ? nameParts[nameParts.length - 1] : '';
          const middlename = nameParts.length > 2 ? nameParts.slice(1, -1).join(' ') : '';

          const userRef = window.dbRef(window.db, `users/${userId}`);
          const userSnap = await window.dbGet(userRef);
          const userObj = userSnap.exists() ? userSnap.val() : {};
          userObj.Firstname = firstname;
          userObj.Middlename = middlename;
          userObj.Lastname = lastname;
          userObj.MobileNumber = editedDriver.contact;
          await window.dbSet(userRef, userObj);

          const driverRef = window.dbRef(window.db, `drivers/${driverId}`);
          await window.dbUpdate(driverRef, {
            LicenseNumber: editedDriver.license,
            TricyclePlateNumber: editedDriver.tricycle,
            TricycleNumber: editedDriver.tricycle,
            FranchiseExpiry: editedDriver.franchiseExpiry || ''
          });

          const updatedDrivers = [...drivers];
          updatedDrivers[index] = {
            ...updatedDrivers[index],
            name: editedDriver.name,
            contact: editedDriver.contact,
            license: editedDriver.license,
            tricycle: editedDriver.tricycle,
            franchiseExpiry: editedDriver.franchiseExpiry
          };
          setDrivers(updatedDrivers);
          setSelectedDriver(null);
          setSelectedDriverIndex(null);
          window.showAlert("Driver information updated successfully!", 'success');
        } catch (error) {
          console.error('Error updating driver:', error);
          window.showAlert('Error updating driver: ' + error.message, 'error');
        }
      };

      const handleAddNewDriver = async (newDriver) => {
        try {
          const newUserId = await claimSmallestNumericId('users');

          const nameParts = newDriver.name.trim().split(/\s+/);
          const firstname = nameParts[0] || '';
          const lastname = nameParts.length > 1 ? nameParts[nameParts.length - 1] : '';
          const middlename = nameParts.length > 2 ? nameParts.slice(1, -1).join(' ') : '';

          const userData = {
            Firstname: firstname,
            Middlename: middlename,
            Lastname: lastname,
            MobileNumber: newDriver.contact,
            Role: 'Driver',
            RoleID: 2,
            CreatedAt: new Date().toISOString(),
            IsActive: true,
            Status: 'Active'
          };

          const userRef = window.dbRef(window.db, `users/${newUserId}`);
          await window.dbSet(userRef, userData);

          const newDriverId = await claimSmallestNumericId('drivers');
          const formattedLicense = formatLicense(newDriver.license);

          const driverData = {
            UserID: newUserId,
            LicenseNumber: formattedLicense,
            TricyclePlateNumber: newDriver.tricycle,
            TricycleNumber: newDriver.tricycle,
            Status: 'Active',
            ApplicationStatus: 'ADDED',
            IsApplying: false,
            CreatedAt: new Date().toISOString()
          };

          const driverRef = window.dbRef(window.db, `drivers/${newDriverId}`);
          await window.dbSet(driverRef, driverData);

          // Link the created driver id back to the user record so other pages can find the mapping
          try {
            await window.dbUpdate(window.dbRef(window.db, `users/${newUserId}`), { DriverID: newDriverId });
          } catch (e) { /* non-fatal */ }

          setShowAddModal(false);
          window.showAlert(`Driver ${newDriver.name} added successfully (ID: ${newDriverId}) to Firebase!`, 'success');
        } catch (error) {
          console.error('Error adding driver:', error);
          window.showAlert('Error adding driver to database: ' + (error && error.message ? error.message : error), 'error');
        }
      };

      const handleDeleteDriver = (index) => {
        setConfirmDelete({ open: true, index });
      };

      const performDeleteDriver = async (index) => {
        const driverToDelete = drivers[index];
        if (!driverToDelete) return;
        try {
          const driverKey = driverToDelete.id;
          const driverRecord = rawDrivers && rawDrivers[driverKey];
          const userIdToDelete = driverRecord ? driverRecord.UserID : null;

          const driverRef = window.dbRef(window.db, `drivers/${driverKey}`);
          await window.dbUpdate(driverRef, {
            Status: 'Inactive',
            DeletedAt: new Date().toISOString()
          });

          if (userIdToDelete) {
            const userRef = window.dbRef(window.db, `users/${userIdToDelete}`);
            await window.dbUpdate(userRef, {
              IsActive: false,
              Status: 'Inactive',
              DeletedAt: new Date().toISOString()
            });
          }

          setConfirmDelete({ open: false, index: null });
          window.showAlert(`Driver ${driverToDelete.name} has been deactivated (soft-deleted).`, 'success');
        } catch (error) {
          console.error('Error deleting driver:', error);
          window.showAlert('Error deleting driver: ' + (error && error.message ? error.message : error), 'error');
          setConfirmDelete({ open: false, index: null });
        }
      };

      return (
        <div className="min-h-screen bg-[#0a0e1a]">
          {/* Header */}
          <header className="bg-[#151b28] border-b border-gray-700">
            <div className="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <img src="tricy.png" alt="Logo" className="w-8 h-8" />
                <div>
                  <h1 className="text-xl font-bold text-yellow-500">PASAKAY</h1>
                  <p className="text-xs text-gray-400">Admin Dashboard</p>
                </div>
              </div>
              <div className="flex items-center gap-6">
                <div className="text-right">
                  <p className="text-gray-300">Administrator</p>
                  <p className="text-xs text-gray-500">System Admin</p>
                </div>
                <a 
                  href="log out.html"
                  className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors flex items-center gap-2"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                  </svg>
                  Logout
                </a>
              </div>
            </div>
          </header>

          {/* Navigation Tabs */}
          <div className="bg-[#0f1419] border-b border-gray-700 sticky top-0 z-10">
            <div className="max-w-7xl mx-auto px-6">
              <div className="flex gap-8 overflow-x-auto">
                <button
                  onClick={() => setCurrentTab('overview')}
                  className={`py-4 px-2 border-b-2 font-medium transition-colors whitespace-nowrap ${
                    currentTab === 'overview'
                      ? 'border-yellow-500 text-yellow-500'
                      : 'border-transparent text-gray-400 hover:text-yellow-400'
                  }`}
                >
                  <svg className="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                  </svg>
                  Overview
                </button>
                <button
                  onClick={() => setCurrentTab('drivers')}
                  className={`py-4 px-2 border-b-2 font-medium transition-colors whitespace-nowrap ${
                    currentTab === 'drivers'
                      ? 'border-yellow-500 text-yellow-500'
                      : 'border-transparent text-gray-400 hover:text-yellow-400'
                  }`}
                >
                  <svg className="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM9 10a6 6 0 1 1-12 0 6 6 0 0 1 12 0z" />
                  </svg>
                  Drivers
                </button>
                <button
                  onClick={() => setCurrentTab('bookings')}
                  className={`py-4 px-2 border-b-2 font-medium transition-colors whitespace-nowrap ${
                    currentTab === 'bookings'
                      ? 'border-yellow-500 text-yellow-500'
                      : 'border-transparent text-gray-400 hover:text-yellow-400'
                  }`}
                >
                  <svg className="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                  </svg>
                  Bookings
                </button>
                <button
                  onClick={() => setCurrentTab('passengers')}
                  className={`py-4 px-2 border-b-2 font-medium transition-colors whitespace-nowrap ${
                    currentTab === 'passengers'
                      ? 'border-yellow-500 text-yellow-500'
                      : 'border-transparent text-gray-400 hover:text-yellow-400'
                  }`}
                >
                  <svg className="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                  Passengers
                </button>
                <button
                  onClick={() => setCurrentTab('logs')}
                  className={`py-4 px-2 border-b-2 font-medium transition-colors whitespace-nowrap ${
                    currentTab === 'logs'
                      ? 'border-yellow-500 text-yellow-500'
                      : 'border-transparent text-gray-400 hover:text-yellow-400'
                  }`}
                >
                  <svg className="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  Logs
                </button>
                <button
                  onClick={() => setCurrentTab('fareMatrix')}
                  className={`py-4 px-2 border-b-2 font-medium transition-colors whitespace-nowrap ${
                    currentTab === 'fareMatrix'
                      ? 'border-yellow-500 text-yellow-500'
                      : 'border-transparent text-gray-400 hover:text-yellow-400'
                  }`}
                >
                  <svg className="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  Fare Matrix
                </button>
              </div>
            </div>
          </div>

          {/* Search Bar Section */}
          {currentTab === 'overview' && (
            <div className="bg-[#1a1f2e] border-b border-gray-700 sticky top-[57px] z-9">
              <div className="max-w-7xl mx-auto px-6 py-4">
                <div className="relative">
                  <svg className="absolute left-4 top-3.5 w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg>
                  <input
                    type="text"
                    placeholder="Search bookings, drivers, passengers, and more..."
                    value={overviewSearchQuery}
                    onChange={(e) => setOverviewSearchQuery(e.target.value)}
                    className="w-full bg-[#252d42] text-white pl-12 pr-4 py-2.5 rounded-lg border border-gray-600 focus:border-yellow-500 focus:outline-none placeholder-gray-500 text-sm"
                  />
                </div>
              </div>
            </div>
          )}

          {/* Content */}
          <div className="max-w-7xl mx-auto px-6 py-8">
            {currentTab === 'overview' && (
              <div className="space-y-6">
                {/* Top 3 Stats */}
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                  <div className="bg-gradient-to-br from-[#1e2538] to-[#0a0e1a] rounded-lg p-6 border border-purple-900">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-gray-400 text-sm mb-2">TODAY'S RIDES</p>
                        <h3 className="text-4xl font-bold text-white">{bookings.filter(b => {
                          const today = new Date();
                          const bookingDate = b.requestedTs ? new Date(b.requestedTs) : new Date(b.RequestedAt);
                          return bookingDate.toDateString() === today.toDateString();
                        }).length}</h3>
                        <p className="text-gray-400 text-xs mt-2">Live count from DB</p>
                      </div>
                      <svg className="w-12 h-12 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                      </svg>
                    </div>
                  </div>
                  <div className="bg-gradient-to-br from-[#1e2538] to-[#0a0e1a] rounded-lg p-6 border border-green-900">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-gray-400 text-sm mb-2">ACTIVE DRIVERS</p>
                        <h3 className="text-4xl font-bold text-green-400">{drivers.filter(d => d.isActiveUser && d.status === 'Active').length}</h3>
                        <p className="text-gray-400 text-xs mt-2">Online drivers (live)</p>
                      </div>
                      <svg className="w-12 h-12 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </div>
                  </div>
                  <div className="bg-gradient-to-br from-[#1e2538] to-[#0a0e1a] rounded-lg p-6 border border-yellow-900">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-gray-400 text-sm mb-2">TOTAL BOOKINGS</p>
                        <h3 className="text-4xl font-bold text-yellow-400">{bookings.length}</h3>
                        <p className="text-gray-400 text-xs mt-2">Total bookings (live)</p>
                      </div>
                      <svg className="w-12 h-12 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                    </div>
                  </div>
                </div>

                {/* Driver Management Stats */}
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                  <div className="bg-gradient-to-br from-[#1e2538] to-[#0a0e1a] rounded-lg p-4 border border-green-900">
                    <p className="text-gray-400 text-sm mb-1">ACTIVE DRIVERS</p>
                    <h3 className="text-2xl font-bold text-green-400">{drivers.filter(d => d.status === 'Active').length}</h3>
                    <p className="text-gray-500 text-xs mt-1">Ready to accept rides</p>
                  </div>
                  <div className="bg-gradient-to-br from-[#1e2538] to-[#0a0e1a] rounded-lg p-4 border border-blue-900">
                    <p className="text-gray-400 text-sm mb-1">VERIFIED DRIVERS</p>
                    <h3 className="text-2xl font-bold text-blue-400">{drivers.filter(d => d.status === 'Active' && d.isActiveUser).length}</h3>
                    <p className="text-gray-500 text-xs mt-1">With Verified Documents</p>
                  </div>
                  <div className="bg-gradient-to-br from-[#1e2538] to-[#0a0e1a] rounded-lg p-4 border border-red-900">
                    <p className="text-gray-400 text-sm mb-1">INACTIVE DRIVERS</p>
                    <h3 className="text-2xl font-bold text-red-400">{drivers.filter(d => d.status !== 'Active' || !d.isActiveUser).length}</h3>
                    <p className="text-gray-500 text-xs mt-1">Not available</p>
                  </div>
                  <div className="bg-gradient-to-br from-[#1e2538] to-[#0a0e1a] rounded-lg p-4 border border-yellow-900">
                    <p className="text-gray-400 text-sm mb-1">COMPLETION RATE</p>
                    <h3 className="text-2xl font-bold text-yellow-400">{bookings.length > 0 ? Math.round((bookings.filter(b => b.status === 'Completed').length / bookings.length) * 100) : 0}%</h3>
                    <p className="text-gray-500 text-xs mt-1">Of all bookings</p>
                  </div>
                </div>

                {/* Search Results */}

                {overviewSearchQuery.trim() !== '' && (
                  <div className="space-y-4">
                    {/* Bookings Results */}
                    {bookings.filter(b => {
                      const query = overviewSearchQuery.toLowerCase();
                      const queryTrimmed = query.trim();
                      const bookingIdStr = String(b.id || b.bookingIdNumeric || '');
                      // If query is numeric, try exact ID match first
                      if (/^\d+$/.test(queryTrimmed)) {
                        return bookingIdStr === queryTrimmed;
                      }
                      // Otherwise, search by passenger, driver, pickup, destination
                      return b.passengerName.toLowerCase().includes(query) || b.driverName.toLowerCase().includes(query) || b.pickup?.toLowerCase().includes(query) || b.destination?.toLowerCase().includes(query);
                    }).length > 0 && (
                      <div className="bg-[#1e2538] rounded-lg p-6 border border-gray-700">
                        <h3 className="text-xl font-bold text-white mb-4">Bookings ({bookings.filter(b => {
                          const query = overviewSearchQuery.toLowerCase();
                          const queryTrimmed = query.trim();
                          const bookingIdStr = String(b.id || b.bookingIdNumeric || '');
                          if (/^\d+$/.test(queryTrimmed)) {
                            return bookingIdStr === queryTrimmed;
                          }
                          return b.passengerName.toLowerCase().includes(query) || b.driverName.toLowerCase().includes(query) || b.pickup?.toLowerCase().includes(query) || b.destination?.toLowerCase().includes(query);
                        }).length})</h3>
                        <div className="space-y-2 max-h-64 overflow-y-auto">
                          {bookings.filter(b => {
                            const query = overviewSearchQuery.toLowerCase();
                            const queryTrimmed = query.trim();
                            const bookingIdStr = String(b.id || b.bookingIdNumeric || '');
                            if (/^\d+$/.test(queryTrimmed)) {
                              return bookingIdStr === queryTrimmed;
                            }
                            return b.passengerName.toLowerCase().includes(query) || b.driverName.toLowerCase().includes(query) || b.pickup?.toLowerCase().includes(query) || b.destination?.toLowerCase().includes(query);
                          }).map((b, idx) => {
                            return (
                              <div key={idx} onClick={() => setSelectedBooking(b)} className="bg-[#252d42] p-3 rounded border border-gray-600 cursor-pointer hover:border-yellow-500 transition-colors">
                                <p className="text-gray-200 text-sm"><span className="text-yellow-400">Passenger:</span> {b.passengerName}</p>
                                <p className="text-gray-200 text-sm"><span className="text-green-400">Driver:</span> {b.driverName}</p>
                                <p className="text-gray-300 text-sm"><span className="text-blue-400">{b.pickup}</span> → <span className="text-blue-400">{b.destination}</span></p>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    )}

                    {/* Drivers Results */}
                    {drivers.filter(d => {
                      const query = overviewSearchQuery.toLowerCase();
                      const driverName = (d.name || '').toLowerCase();
                      const driverContact = (d.contact || '').toLowerCase();
                      // Exact match on driver name OR partial match on contact
                      return driverName === query || driverContact.includes(query);
                    }).length > 0 && (
                      <div className="bg-[#1e2538] rounded-lg p-6 border border-gray-700">
                        <h3 className="text-xl font-bold text-white mb-4">Drivers ({drivers.filter(d => {
                          const query = overviewSearchQuery.toLowerCase();
                          const driverName = (d.name || '').toLowerCase();
                          const driverContact = (d.contact || '').toLowerCase();
                          return driverName === query || driverContact.includes(query);
                        }).length})</h3>
                        <div className="space-y-2 max-h-64 overflow-y-auto">
                          {drivers.filter(d => {
                            const query = overviewSearchQuery.toLowerCase();
                            const driverName = (d.name || '').toLowerCase();
                            const driverContact = (d.contact || '').toLowerCase();
                            return driverName === query || driverContact.includes(query);
                          }).map((d, idx) => (
                            <div key={idx} onClick={() => setSelectedDriver(d)} className="bg-[#252d42] p-3 rounded border border-gray-600 cursor-pointer hover:border-yellow-500 transition-colors">
                              <p className="text-gray-200 text-sm"><span className="font-semibold">{d.name}</span></p>
                              <p className="text-gray-300 text-xs">Phone: {stripPhonePrefix(d.contact)}</p>
                              <p className="text-gray-300 text-xs">Status: <span className={d.status === 'Active' ? 'text-green-400' : 'text-gray-400'}>{d.status}</span></p>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Passengers Results */}
                    {passengers.filter(p => {
                      const user = rawUsers[p.UserID];
                      const fullName = user ? [user.Firstname, user.Middlename, user.Lastname].filter(Boolean).join(' ') : 'Unknown';
                      return fullName.toLowerCase().includes(overviewSearchQuery.toLowerCase()) || p.Phone?.toLowerCase().includes(overviewSearchQuery.toLowerCase());
                    }).length > 0 && (
                      <div className="bg-[#1e2538] rounded-lg p-6 border border-gray-700">
                        <h3 className="text-xl font-bold text-white mb-4">Passengers ({passengers.filter(p => {
                          const user = rawUsers[p.UserID];
                          const fullName = user ? [user.Firstname, user.Middlename, user.Lastname].filter(Boolean).join(' ') : 'Unknown';
                          return fullName.toLowerCase().includes(overviewSearchQuery.toLowerCase()) || p.Phone?.toLowerCase().includes(overviewSearchQuery.toLowerCase());
                        }).length})</h3>
                        <div className="space-y-2 max-h-64 overflow-y-auto">
                          {passengers.filter(p => {
                            const user = rawUsers[p.UserID];
                            const fullName = user ? [user.Firstname, user.Middlename, user.Lastname].filter(Boolean).join(' ') : 'Unknown';
                            return fullName.toLowerCase().includes(overviewSearchQuery.toLowerCase()) || p.Phone?.toLowerCase().includes(overviewSearchQuery.toLowerCase());
                          }).map((p, idx) => {
                            const user = rawUsers[p.UserID];
                            const fullName = user ? [user.Firstname, user.Middlename, user.Lastname].filter(Boolean).join(' ') : 'Unknown';
                            return (
                              <div key={idx} className="bg-[#252d42] p-3 rounded border border-gray-600">
                                <p className="text-gray-200 text-sm"><span className="font-semibold">{fullName}</span></p>
                                <p className="text-gray-300 text-xs">Phone: {stripPhonePrefix(p.Phone)}</p>
                                <p className="text-gray-300 text-xs">Rides: {bookings.filter(b => b.userId === p.UserID || b.PassengerID === p.PassengerID || b.PassengerUserID === p.UserID).length}</p>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}

            {currentTab === 'drivers' && (
              <div className="space-y-6">
                {/* Driver Management Section */}
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                  <h2 className="text-2xl font-bold text-white">Driver Management ({filteredDrivers.length} drivers)</h2>
                  <div className="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                    <button 
                      onClick={() => setShowDriverFilterModal(true)}
                      className="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-lg text-gray-900 font-semibold flex items-center justify-center gap-2"
                    >
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                      </svg>
                      FILTER
                    </button>
                    <button 
                      onClick={() => setShowExportModal(true)}
                      className="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-lg text-gray-900 font-semibold flex items-center justify-center gap-2"
                    >
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                      EXPORT DATA
                    </button>
                    <button 
                      onClick={() => setShowImportModal(true)}
                      className="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-lg text-gray-900 font-semibold flex items-center justify-center gap-2"
                    >
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                      </svg>
                      ADD APPROVED DRIVERS
                    </button>
                  </div>
                </div>

                <div className="bg-[#1e2538] rounded-lg overflow-hidden p-6">
                  <div className="space-y-4">
                    {filteredDrivers.length > 0 ? filteredDrivers.map((driver, index) => {
                      const originalIndex = drivers.findIndex(d => d.id === driver.id);
                      return (
                      <div key={index} className="bg-[#252d42] rounded-lg p-6 flex flex-col sm:flex-row items-start sm:items-center gap-4 hover:shadow-lg transition-shadow">
                        <div className="flex items-center gap-4 flex-shrink-0">
                          <div className={`w-14 h-14 rounded-full flex items-center justify-center font-bold text-white text-base ${driver.status === 'Active' ? 'bg-green-500' : 'bg-gray-500'}`}>{(driver.name||'').split(' ').map(s=>s[0]).slice(0,2).join('')}</div>
                        </div>

                        <div className="flex-1 min-w-0 pr-4">
                          <div className="text-white font-semibold text-base md:text-lg">{driver.name}</div>
                          <div className="text-gray-200 text-sm md:text-base mt-2 space-y-1">
                            <div className="leading-tight">Plate: <span className="font-semibold text-gray-100">{driver.tricycle || '—'}</span></div>
                            <div className="leading-tight">License: <span className="font-semibold text-gray-100">{driver.license || '—'}</span></div>
                            <div className="leading-tight">Phone: <span className="font-semibold text-gray-100">{stripPhonePrefix(driver.contact) || '—'}</span></div>
                          </div>
                        </div>

                        <div className="flex-shrink-0 w-full sm:w-auto flex flex-col sm:items-end sm:flex-row sm:gap-4 gap-3 items-start">
                          <div className="flex gap-2 items-center">
                            <span className={`inline-flex items-center justify-center h-9 min-w-[88px] px-4 rounded-lg text-sm font-semibold ${driver.isActiveUser ? 'bg-blue-500 text-white' : 'bg-gray-500 text-white'}`}>
                              {driver.isActiveUser ? 'Active' : 'Inactive'}
                            </span>
                            <span className={`inline-flex items-center justify-center h-9 min-w-[88px] px-4 rounded-lg text-sm font-semibold ${driver.status === 'Active' ? 'bg-green-500 text-white' : 'bg-gray-500 text-white'}`}>
                              {driver.status === 'Active' ? 'Online' : 'Offline'}
                            </span>
                          </div>

                          <div className="flex gap-3 mt-3 sm:mt-0">
                            <button 
                              onClick={() => handleEditDriver(originalIndex)}
                              className="bg-yellow-500 hover:bg-yellow-600 h-9 min-w-[88px] px-4 rounded-lg font-semibold text-gray-900 flex items-center justify-center"
                            >
                              Edit
                            </button>
                            <button 
                              onClick={() => handleDeleteDriver(originalIndex)}
                              className="bg-red-600 hover:bg-red-700 h-9 min-w-[88px] px-4 rounded-lg font-semibold text-white flex items-center justify-center"
                            >
                              Delete
                            </button>
                          </div>
                        </div>
                      </div>
                    );
                    }) : (
                      <div className="text-center text-gray-400 py-8">No drivers match the selected filters</div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {currentTab === 'bookings' && (
              <div className="space-y-6">
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                  <h2 className="text-2xl font-bold text-white">Booking Management ({filteredBookings.length} bookings)</h2>
                  <button
                    className="bg-yellow-500 hover:bg-yellow-600 px-6 py-3 rounded-lg font-semibold text-gray-900 flex items-center gap-2"
                    onClick={() => setShowBookingFilterModal(true)}
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                    </svg>
                    FILTER
                  </button>
                </div>

                <div className="bg-[#1e2538] p-6 rounded-lg space-y-4">
                  {filteredBookings.length > 0 ? (
                    filteredBookings.map(booking => (
                      <div key={booking.id} onClick={() => setSelectedBooking(booking)} className="bg-[#252d42] p-6 rounded-lg hover:bg-[#2d3548] transition-colors cursor-pointer">
                        <div className="flex justify-between items-start">
                          <div className="flex-1">
                            <h4 className="font-bold text-white text-lg mb-2">Booking #{booking.id}</h4>
                            <p className="text-sm text-gray-400 mb-1"><span className="font-medium text-gray-300">Passenger:</span> {booking.passengerName}</p>
                            <p className="text-sm text-gray-400 mb-1"><span className="font-medium text-gray-300">Route:</span> {booking.pickup} → {booking.destination}</p>
                            <p className="text-sm text-gray-400 mb-1"><span className="font-medium text-gray-300">Driver:</span> {booking.driverName} • <span className="font-medium text-gray-300">Distance:</span> {booking.distance}</p>
                            <p className="text-sm text-gray-400"><span className="font-medium text-gray-300">Date:</span> {booking.date || ''} {booking.time || ''}</p>
                          </div>
                          <div className="flex flex-col items-end gap-2">
                            <span className={`px-4 py-2 rounded-lg text-sm font-bold ${statusBadgeClass(booking.status)}`}>
                              {booking.status}
                            </span>
                            <span className="text-xl font-bold text-yellow-500">₱{booking.fare}</span>
                          </div>
                        </div>
                      </div>
                    ))
                  ) : (
                    <div className="text-center text-gray-400 py-8">No bookings found</div>
                  )}
                </div>
              </div>
            )}

            {currentTab === 'passengers' && (
              <div className="space-y-6">
                <div className="flex justify-between items-center">
                  <h2 className="text-2xl font-bold text-white">Passenger Management ({passengers.length} passengers)</h2>
                  <button
                    onClick={() => setShowPassengerFilterModal(true)}
                    className="bg-yellow-500 hover:bg-yellow-600 px-6 py-3 rounded-lg font-semibold text-gray-900 flex items-center gap-2"
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                    </svg>
                    FILTER PASSENGER
                  </button>
                </div>

                <div className="bg-[#1e2538] p-6 rounded-lg">
                  <div className="space-y-4">
                    {passengers.length > 0 ? (
                      passengers.map((p, index) => (
                        <div key={index} className="flex justify-between items-center bg-[#252d42] p-6 rounded-lg hover:bg-[#2d3548] transition-colors">
                          <div className="flex items-center gap-4">
                            <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-white text-lg ${
                              p.status === "ACTIVE" ? "bg-green-500" : "bg-gray-500"
                            }`}>
                              {p.initials}
                            </div>
                            <div>
                              <h4 className="font-bold text-white text-lg">{p.name}</h4>
                              <p className="text-sm text-gray-400">
                                Passenger ID: {p.id} | Phone: {stripPhonePrefix(p.phone)} | {p.rides} rides total
                              </p>
                            </div>
                          </div>
                          <div className="flex items-center gap-3">
                            <span className={`px-4 py-2 rounded-lg text-sm font-bold text-white ${
                              p.status === "ACTIVE" ? "bg-green-500" : "bg-gray-500"
                            }`}>
                              {p.status}
                            </span>
                            <button
                              onClick={() => handleEditPassenger(p, index)}
                              className="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-lg text-sm font-semibold text-gray-900 flex items-center gap-2"
                            >
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                              </svg>
                              Edit
                            </button>
                          </div>
                        </div>
                      ))
                    ) : (
                      <div className="text-center text-gray-400 py-8">No passengers found</div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {currentTab === 'logs' && (
              <div className="space-y-6">
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                  <h2 className="text-2xl font-bold text-white">System Violation Reports ({filteredLogs.length} logs)</h2>
                  <div className="relative w-full sm:w-80">
                    <svg className="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input
                      type="text"
                      placeholder="Search logs..."
                      value={logsSearchTerm}
                      onChange={(e) => setLogsSearchTerm(e.target.value)}
                      className="pl-10 pr-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none w-full"
                    />
                  </div>
                </div>

                <div className="bg-[#1e2538] p-6 rounded-lg">
                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="bg-[#252d42]">
                          <th className="px-6 py-4 text-left text-white font-semibold">Log ID</th>
                          <th className="px-6 py-4 text-left text-white font-semibold">BookingID</th>
                          <th className="px-6 py-4 text-left text-white font-semibold">Driver</th>
                          <th className="px-6 py-4 text-left text-white font-semibold">Event</th>
                          <th className="px-6 py-4 text-left text-white font-semibold">Location</th>
                          <th className="px-6 py-4 text-left text-white font-semibold">Timestamp</th>
                          <th className="px-6 py-4 text-left text-white font-semibold">Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {filteredLogs.length > 0 ? (
                          filteredLogs.map((log, index) => (
                            <tr key={index} className="bg-[#151b28] hover:bg-[#1a202e] border-b border-gray-700">
                              <td className="px-6 py-4 text-gray-300 font-medium">{log.id}</td>
                              <td className="px-6 py-4 text-gray-300">{log.bookingId}</td>
                              <td className="px-6 py-4 text-gray-300">{log.driver}</td>
                              <td className="px-6 py-4 text-yellow-400 font-medium">{log.event}</td>
                              <td className="px-6 py-4 text-gray-400">{log.location}</td>
                              <td className="px-6 py-4 text-gray-400">{log.timestamp}</td>
                              <td className="px-6 py-4">
                                <span 
                                  onClick={() => handleLogStatusChange(log.dbKey, log.status)}
                                  className={`
                                    px-3 py-1 rounded-lg text-sm font-bold text-white cursor-pointer transition-opacity hover:opacity-80
                                    ${log.status === "Flagged"
                                      ? "bg-red-600"
                                      : "bg-green-600"
                                    }
                                  `}
                                >
                                  {log.status}
                                </span>
                              </td>
                            </tr>
                          ))
                        ) : (
                          <tr>
                            <td colSpan="7" className="text-center text-gray-400 py-8 bg-[#252d42]">
                              No logs found matching your search.
                            </td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            )}

            {currentTab === 'fareMatrix' && (
              <div className="space-y-6">
                {/* Fare Matrix Section */}
                <div className="bg-[#1e2538] p-8 rounded-xl">
                  <h2 className="text-2xl font-bold mb-6 text-white">Fare Matrix Settings</h2>

                  {/* Settings Cards */}
                  <div className="grid gap-6">
                    {/* Base Fare Rate */}
                    <div className="bg-[#252d42] p-6 rounded-lg border border-gray-700 hover:bg-[#2d3548] transition-colors">
                      <div className="flex items-center gap-3 mb-3">
                        <svg className="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h4 className="text-xl font-bold text-white">Base Fare Rate</h4>
                      </div>
                      <div className="space-y-2">
                        <p className="text-gray-300">
                          <span className="font-semibold text-yellow-400">Special Trip:</span> ₱30 for the first km (3-4 Passengers)
                        </p>
                        <p className="text-gray-300">
                          <span className="font-semibold text-yellow-400">Additional:</span> ₱5 for every kilometer
                        </p>
                      </div>
                    </div>

                    {/* Service Area */}
                    <div className="bg-[#252d42] p-6 rounded-lg border border-gray-700 hover:bg-[#2d3548] transition-colors">
                      <div className="flex items-center gap-3 mb-3">
                        <svg className="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <h4 className="text-xl font-bold text-white">Service Area</h4>
                      </div>
                      <div className="space-y-2">
                        <p className="text-gray-300">
                          <span className="font-semibold text-green-400">Current Area:</span> Bagong Silangan, Quezon City
                        </p>
                        <p className="text-gray-400 text-sm">
                          Defines the operational boundary for tricycle services
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Modals */}
          {showAddModal && (
            <AddDriverModal onClose={() => setShowAddModal(false)} onSave={handleAddNewDriver} />
          )}
          {showImportModal && <ImportApprovedModal onClose={() => setShowImportModal(false)} approvedApplications={approvedApplications} drivers={drivers} />}
          {selectedDriver && (
            <EditDriverModal 
              driver={selectedDriver} 
              driverIndex={selectedDriverIndex}
              onClose={() => {
                setSelectedDriver(null);
                setSelectedDriverIndex(null);
              }} 
              onSave={handleSaveDriver}
            />
          )}
          {showExportModal && <ExportDataModal drivers={drivers} onClose={() => setShowExportModal(false)} />}
          
          {/* Booking Filter Modal */}
          {showBookingFilterModal && (
            <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50">
              <div className="bg-[#1e2538] p-8 rounded-xl w-full max-w-md">
                <h2 className="text-2xl font-bold mb-6 text-white">Filter Bookings</h2>
                <div className="space-y-4">
                  <div>
                    <label className="block text-gray-300 mb-2 font-medium">Date From</label>
                    <input 
                      type="date" 
                      value={dateFromBooking}
                      onChange={(e) => setDateFromBooking(e.target.value)}
                      className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none"
                    />
                  </div>
                  <div>
                    <label className="block text-gray-300 mb-2 font-medium">Date To</label>
                    <input 
                      type="date" 
                      value={dateToBooking}
                      onChange={(e) => setDateToBooking(e.target.value)}
                      className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none"
                    />
                  </div>
                  <div>
                    <label className="block text-gray-300 mb-2 font-medium">Status</label>
                    <div className="space-y-2">
                      {['Completed', 'Pending', 'Cancelled'].map(status => (
                        <label key={status} className="flex items-center gap-2 text-gray-300 cursor-pointer">
                          <input 
                            type="checkbox"
                            checked={statusFiltersBooking[status]}
                            onChange={() => setStatusFiltersBooking(prev => ({ ...prev, [status]: !prev[status] }))}
                            className="w-4 h-4"
                          />
                          {status}
                        </label>
                      ))}
                    </div>
                  </div>
                </div>
                <div className="flex justify-between gap-3 mt-6">
                  <button onClick={() => setShowBookingFilterModal(false)} className="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-semibold text-white">Cancel</button>
                  <button onClick={applyBookingFilters} className="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg font-semibold text-white">Apply</button>
                </div>
              </div>
            </div>
          )}
          
          {/* Passenger Filter Modal */}
          {showPassengerFilterModal && (
            <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50 overflow-y-auto py-8">
              <div className="bg-[#1e2538] rounded-xl shadow-lg p-8 w-full max-w-3xl max-h-[90vh] overflow-y-auto relative">
                <button
                  className="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl font-light"
                  onClick={() => setShowPassengerFilterModal(false)}
                >
                  ×
                </button>
                <h3 className="text-2xl font-bold mb-6 text-white">Filter Passenger Ride History</h3>
                
                <div className="flex items-center gap-4 mb-6 flex-wrap">
                  <input
                    type="text"
                    placeholder="Search by Passenger, Driver, Tricycle #, Location..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="flex-1 min-w-[250px] px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none placeholder-gray-500"
                  />
                  <input 
                    type="date" 
                    value={startDate}
                    onChange={(e) => setStartDate(e.target.value)}
                    className="px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                  />
                  <span className="text-gray-300">to</span>
                  <input 
                    type="date" 
                    value={endDate}
                    onChange={(e) => setEndDate(e.target.value)}
                    className="px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                  />
                  <button
                    onClick={() => {
                      setSearchQuery("");
                      setStartDate("");
                      setEndDate("");
                    }}
                    className="bg-gray-600 hover:bg-gray-700 px-4 py-3 rounded-lg font-semibold text-white"
                  >
                    Clear
                  </button>
                </div>

                {getFilteredRides().length > 0 ? (
                  <>
                    <div className="mb-4 text-gray-300 text-sm">
                      Showing {getFilteredRides().length} ride(s)
                    </div>
                    <div className="bg-[#252d42] rounded-lg overflow-x-auto">
                      <table className="w-full text-white text-sm">
                        <thead className="bg-[#1a1f2e]">
                          <tr>
                            <th className="p-3 text-left font-semibold">Date</th>
                            <th className="p-3 text-left font-semibold">Passenger ID/Name</th>
                            <th className="p-3 text-left font-semibold">Fare</th>
                            <th className="p-3 text-left font-semibold">Tricycle No.</th>
                            <th className="p-3 text-left font-semibold">Pickup</th>
                            <th className="p-3 text-left font-semibold">Drop Off</th>
                            <th className="p-3 text-left font-semibold">Payment</th>
                            <th className="p-3 text-left font-semibold">Rating</th>
                          </tr>
                        </thead>
                        <tbody>
                          {getFilteredRides().map((ride, idx) => (
                            <tr key={idx} className="border-b border-gray-700 hover:bg-[#2d3548]">
                              <td className="p-3 text-gray-400">{new Date(ride.date).toLocaleDateString()}</td>
                              <td className="p-3">{ride.passengerId}, {ride.passengerName}</td>
                              <td className="p-3 text-green-400 font-semibold">{ride.fare}</td>
                              <td className="p-3">{ride.tricycleNo}</td>
                              <td className="p-3">{ride.pickup}</td>
                              <td className="p-3">{ride.dropOff}</td>
                              <td className="p-3">
                                <span className={`px-2 py-1 rounded text-xs font-semibold ${
                                  ride.payment === "Cash" ? "bg-green-600" : "bg-blue-600"
                                }`}>
                                  {ride.payment}
                                </span>
                              </td>
                              <td className="p-3">
                                <span className="text-yellow-400">★</span> {ride.rating}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </>
                ) : (
                  <div className="bg-[#252d42] rounded-lg p-12 text-center">
                    <svg className="w-16 h-16 mx-auto mb-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p className="text-gray-400 text-lg">No rides found</p>
                    <p className="text-gray-500 text-sm mt-2">Try adjusting your search filters</p>
                  </div>
                )}

                <div className="flex justify-end mt-6">
                  <button
                    onClick={() => setShowPassengerFilterModal(false)}
                    className="bg-red-600 hover:bg-red-700 px-8 py-3 rounded-lg font-semibold text-white"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Edit Passenger Modal */}
          {showEditPassengerModal && selectedPassenger && (
            <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50">
              <div className="bg-[#1e2538] rounded-xl shadow-lg p-8 w-[600px] relative">
                <button
                  className="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl font-light"
                  onClick={handleClosePassengerModal}
                >
                  ×
                </button>
                <h3 className="text-2xl font-bold mb-6 text-white">Edit Passenger</h3>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm text-gray-300 mb-2 font-medium">Passenger Name</label>
                    <input
                      type="text"
                      value={selectedPassenger.name}
                      className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none"
                      onChange={(e) =>
                        setSelectedPassenger({ ...selectedPassenger, name: e.target.value })
                      }
                    />
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm text-gray-300 mb-2 font-medium">Email</label>
                      <input
                        type="email"
                        value={selectedPassenger.email}
                        className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none"
                        onChange={(e) => {
                          const val = e.target.value.toString().trim().toLowerCase();
                          setSelectedPassenger({ ...selectedPassenger, email: val });
                          // Only show error if user already typed a domain that's not gmail.com
                          if (val.includes('@')) {
                            const domain = val.split('@')[1] || '';
                            if (domain !== 'gmail.com') setEmailError('Email must be a \"gmail.com\" address');
                            else setEmailError('');
                          } else {
                            setEmailError('');
                          }
                        }}
                      />
                        {emailError && (
                          <p className="text-sm text-red-400 mt-1">{emailError}</p>
                        )}
                    </div>
                    <div>
                      <label className="block text-sm text-gray-300 mb-2 font-medium">Contact Number</label>
                      <div className="inline-flex items-stretch min-w-0">
                        <div className="inline-flex items-center justify-center px-3 py-3 bg-[#111827] text-white border border-gray-700 border-r-0 rounded-l-lg">
                          +63
                        </div>
                        <input
                          type="text"
                          value={selectedPassenger.phone}
                          className="flex-1 min-w-0 px-4 py-3 bg-[#252d42] text-white border border-gray-700 border-l-0 rounded-r-lg focus:border-yellow-500 focus:outline-none"
                          onChange={(e) => {
                            let input = e.target.value.toString();
                            // If it starts with 0, keep the 0 and allow only 10 more digits
                            if (input.startsWith('0')) {
                              const trailing = input.slice(1).replace(/\D/g, '').slice(0, 10);
                              const digits = '0' + trailing;
                              setSelectedPassenger({ ...selectedPassenger, phone: digits });
                              if (digits.length > 0 && digits.length !== 11) setPhoneError('Contact must be 11 digits');
                              else setPhoneError('');
                            } else {
                              // If somehow it doesn't start with 0, extract digits and prepend 0
                              const allDigits = input.replace(/\D/g, '').slice(0, 10);
                              const digits = '0' + allDigits;
                              setSelectedPassenger({ ...selectedPassenger, phone: digits });
                              if (digits.length > 0 && digits.length !== 11) setPhoneError('Contact must be 11 digits');
                              else setPhoneError('');
                            }
                          }}
                        />
                      </div>
                        {phoneError && (
                          <p className="text-sm text-red-400 mt-1">{phoneError}</p>
                        )}
                    </div>
                  </div>
                </div>
                <div className="flex justify-between mt-6">
                  <button
                    className="bg-red-600 hover:bg-red-700 px-8 py-3 rounded-lg font-semibold text-white"
                    onClick={handleClosePassengerModal}
                  >
                    Cancel
                  </button>
                  <button
                    className="bg-green-600 hover:bg-green-700 px-8 py-3 rounded-lg font-semibold text-white"
                    onClick={handleSavePassenger}
                  >
                    Save Changes
                  </button>
                </div>
              </div>
            </div>
          )}
          
          
          {/* Booking Details Modal */}
          {selectedBooking && (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-20">
              <div className="bg-[#1a1f2e] p-6 rounded-2xl shadow-xl w-full max-w-5xl relative flex flex-col md:flex-row gap-6">
                <button
                  onClick={() => setSelectedBooking(null)}
                  className="absolute top-3 right-4 text-gray-400 hover:text-white text-xl"
                >
                  ✕
                </button>

                {/* Booking Info */}
                <div className="flex-1 flex flex-col justify-between">
                  <div className="text-center md:text-left mb-4">
                    <h3 className="text-2xl font-bold text-yellow-400">Booking #{selectedBooking.id}</h3>
                    <span className={`inline-block mt-2 px-2 py-1 rounded text-sm font-bold ${statusBadgeClass(selectedBooking.status)}`}>
                      {selectedBooking.status.toUpperCase()}
                    </span>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-300">
                    <div className="bg-[#2a3244] p-4 rounded-lg">
                      <p className="text-gray-400 text-sm mb-1">PASSENGER</p>
                      <p className="text-lg font-bold">{selectedBooking.passengerName || 'Unknown'}</p>
                    </div>
                    <div className="bg-[#2a3244] p-4 rounded-lg">
                      <p className="text-gray-400 text-sm mb-1">DRIVER</p>
                      <p className="text-lg font-bold">{selectedBooking.driverName || 'Unknown'}</p>
                    </div>
                    <div className="bg-[#2a3244] p-4 rounded-lg">
                      <p className="text-gray-400 text-sm mb-1">PICKUP</p>
                      <p className="text-lg">{selectedBooking.pickup || ''}</p>
                    </div>
                    <div className="bg-[#2a3244] p-4 rounded-lg">
                      <p className="text-gray-400 text-sm mb-1">DROPOFF</p>
                      <p className="text-lg">{selectedBooking.destination || ''}</p>
                    </div>
                    <div className="bg-[#2a3244] p-4 rounded-lg">
                      <p className="text-gray-400 text-sm mb-1">FARE</p>
                      <p className="text-xl font-bold text-yellow-400">₱{selectedBooking.fare ? selectedBooking.fare.toFixed(2) : '0.00'}</p>
                    </div>
                    <div className="bg-[#2a3244] p-4 rounded-lg">
                      <p className="text-gray-400 text-sm mb-1">DISTANCE</p>
                      <p className="text-xl font-bold">{selectedBooking.distance || 'N/A'}</p>
                    </div>
                    <div className="bg-[#2a3244] p-4 rounded-lg">
                      <p className="text-gray-400 text-sm mb-1">DATE & TIME</p>
                      <p className="text-sm">{selectedBooking.date || ''}</p>
                      <p className="text-sm">{selectedBooking.time || ''}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}
          
          {confirmDelete.open && (
            <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50">
              <div className="bg-[#1e2538] p-8 rounded-xl w-full max-w-md">
                <h2 className="text-2xl font-bold mb-4 text-white">Confirm Delete</h2>
                <p className="text-gray-300 mb-6">Are you sure you want to delete <span className="font-semibold text-white">{drivers[confirmDelete.index] ? drivers[confirmDelete.index].name : ''}</span>?</p>
                <div className="flex justify-end gap-3">
                  <button onClick={() => setConfirmDelete({ open: false, index: null })} className="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-semibold text-white">Cancel</button>
                  <button onClick={() => performDeleteDriver(confirmDelete.index)} className="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-semibold text-white">Delete</button>
                </div>
              </div>
            </div>
          )}

          {/* Driver Filter Modal */}
          {showDriverFilterModal && (
            <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50">
              <div className="bg-[#1e2538] p-8 rounded-xl w-full max-w-md">
                <h2 className="text-2xl font-bold mb-6 text-white">Filter Drivers</h2>
                
                <div className="space-y-6">
                  {/* Active/Inactive Filter */}
                  <div>
                    <h3 className="text-lg font-semibold text-white mb-3">Account Status</h3>
                    <div className="space-y-2">
                      <label className="flex items-center gap-3 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={driverStatusFilters.Active}
                          onChange={(e) => setDriverStatusFilters({...driverStatusFilters, Active: e.target.checked})}
                          className="w-4 h-4"
                        />
                        <span className="text-gray-300">Active</span>
                      </label>
                      <label className="flex items-center gap-3 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={driverStatusFilters.Inactive}
                          onChange={(e) => setDriverStatusFilters({...driverStatusFilters, Inactive: e.target.checked})}
                          className="w-4 h-4"
                        />
                        <span className="text-gray-300">Inactive</span>
                      </label>
                    </div>
                  </div>

                  {/* Online/Offline Filter */}
                  <div>
                    <h3 className="text-lg font-semibold text-white mb-3">Online Status</h3>
                    <div className="space-y-2">
                      <label className="flex items-center gap-3 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={driverOnlineFilters.Online}
                          onChange={(e) => setDriverOnlineFilters({...driverOnlineFilters, Online: e.target.checked})}
                          className="w-4 h-4"
                        />
                        <span className="text-gray-300">Online</span>
                      </label>
                      <label className="flex items-center gap-3 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={driverOnlineFilters.Offline}
                          onChange={(e) => setDriverOnlineFilters({...driverOnlineFilters, Offline: e.target.checked})}
                          className="w-4 h-4"
                        />
                        <span className="text-gray-300">Offline</span>
                      </label>
                    </div>
                  </div>
                </div>

                <div className="flex justify-between gap-3 mt-8">
                  <button
                    onClick={() => {
                      setDriverStatusFilters({ Active: true, Inactive: false });
                      setDriverOnlineFilters({ Online: true, Offline: false });
                      setShowDriverFilterModal(false);
                    }}
                    className="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg font-semibold text-white flex-1"
                  >
                    Reset
                  </button>
                  <button
                    onClick={() => setShowDriverFilterModal(false)}
                    className="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold text-white flex-1"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={applyDriverFilters}
                    className="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold text-white flex-1"
                  >
                    Apply
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<AdminDashboard />);
  </script>
</body>
</html>
