<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pasakay - Admin Dashboard</title>
  <link rel="icon" href="tricy.png" type="image/png">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      onValue,
      get,
      set,
      push,
      remove,
      update,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
    import {
      getStorage,
      ref as storageRef,
      uploadBytes
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBS-g5bFBaJ6a35hWmjvoN-s8FuMEuxtew",
      authDomain: "pasakay-project-ph.firebaseapp.com",
      databaseURL: "https://pasakay-project-ph-default-rtdb.firebaseio.com",
      projectId: "pasakay-project-ph",
      storageBucket: "pasakay-project-ph.firebasestorage.app",
      messagingSenderId: "189297787561",
      appId: "1:189297787561:web:ddad5de3fdf638c6d8dfb8",
      measurementId: "G-2VWQ0C8EZE"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // Sign in anonymously for Storage/Database operations
    signInAnonymously(auth).catch(err => {
      console.error('Anonymous sign-in failed:', err);
    });

    // Monitor auth state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log('✅ Authenticated as:', user.uid);
        window.currentUser = user;
      } else {
        console.warn('⚠️ Not authenticated');
      }
    });

    // Expose DB helpers to the non-module React script
    window.db = db;
    window.dbRef = ref;
    window.dbOnValue = onValue;
    window.dbGet = get;
    window.dbSet = set;
    window.dbPush = push;
    window.dbRemove = remove;
    window.dbUpdate = update;
    window.dbRunTransaction = runTransaction;

    // Expose Storage helpers
    window.storage = storage;
    window.storageRef = storageRef;
    window.uploadBytes = uploadBytes;
  </script>

  <script src="ui-modals.js"></script>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: "Inter", sans-serif;
      background: #0a0e1a;
      margin: 0;
      overflow-x: hidden;
    }
    
    /* Customized Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: #1a2333;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #fbbf24 0%, #f59e0b 100%);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #fcd34d 0%, #fbbf24 100%);
    }
    
    /* Firefox Scrollbar */
    * {
      scrollbar-color: #2e3c57 #1a2333;
      scrollbar-width: thin;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Helper: format license to pattern A00-00-000000 
    const formatLicense = (value) => {
      if (!value) return '';
      const up = value.toUpperCase();
      const raw = up.replace(/[^A-Z0-9]/g, '');
      const p1 = raw.slice(0, 3);
      const p2 = raw.slice(3, 5);
      const p3 = raw.slice(5, 11);
      let formatted = p1;
      if (p2) formatted += '-' + p2;
      if (p3) formatted += '-' + p3;
      return formatted;
    };

    const isValidLicense = (value) => {
      return /^[A-Z]\d{2}-\d{2}-\d{6}$/.test((value||'').toString());
    };
    const normalizeLicenseForCompare = (value) => {
      return (value||'').toString().toUpperCase().replace(/[^A-Z0-9]/g, '');
    };

    // Helper: strip +63 prefix for display
    const stripPhonePrefix = (phone) => {
      if (!phone) return '';
      const str = phone.toString();
      if (str.startsWith('+63')) return str.slice(3);
      return str;
    };

    const ImportApprovedModal = ({ onClose, approvedApplications, drivers }) => {
      const [importing, setImporting] = useState({});

      const importApplication = async (appId) => {
        if (importing[appId]) return;
        setImporting(prev => ({ ...prev, [appId]: true }));
        try {
          const approvedApp = approvedApplications.find(a => a.id === appId);
          if (!approvedApp) {
            window.showAlert('Application/Driver not found', 'error');
            return;
          }

          const name = approvedApp.Name || ([approvedApp.Firstname, approvedApp.Middlename, approvedApp.Lastname].filter(Boolean).join(' ')) || 'Unnamed';
          const phone = (approvedApp.MobileNumber || approvedApp.Mobile || approvedApp.Contact || '').toString().replace(/\D/g, '').slice(0, 11);
          const licenseRaw = approvedApp.LicenseNumber || approvedApp.license || approvedApp.License || '';
          const license = formatLicense(licenseRaw);
          if (!isValidLicense(license)) {
            window.showAlert('Application has invalid license format: ' + (licenseRaw || ''), 'error');
            return;
          }

          if (approvedApp._source === 'drivers') {
            const userId = approvedApp.UserID;
            try {
              const userRef = window.dbRef(window.db, `users/${userId}`);
              await window.dbUpdate(userRef, { IsActive: true, Status: 'Active' });
              const driverRef = window.dbRef(window.db, `drivers/${appId}`);
              await window.dbUpdate(driverRef, { Status: 'Active', ApplicationStatus: 'ADDED', IsApplying: false });
            } catch(e) {}
            window.showAlert(`${name} has been imported and added to Driver Management!`, 'success');
            return;
          }

          const norm = normalizeLicenseForCompare(license);
          const existsLicense = Object.values(rawDrivers || {}).some(d => normalizeLicenseForCompare(d.LicenseNumber || d.license || '') === norm);
          if (existsLicense) {
            window.showAlert('A driver with this license already exists in the system.', 'error');
            return;
          }

          let userId = approvedApp.UserID;
          if (!userId || !rawUsers[userId]) {
            userId = await claimSmallestNumericId('users');
            const nameParts = (name || '').trim().split(/\s+/);
            const firstname = nameParts[0] || '';
            const lastname = nameParts.length > 1 ? nameParts[nameParts.length - 1] : '';
            const middlename = nameParts.length > 2 ? nameParts.slice(1, -1).join(' ') : '';
            const userData = {
              Firstname: firstname,
              Middlename: middlename,
              Lastname: lastname,
              MobileNumber: phone,
              CreatedAt: new Date().toISOString(),
              Status: 'Active',
              IsActive: true
            };
            await window.dbSet(window.dbRef(window.db, `users/${userId}`), userData);
          }

          const newDriverId = await claimSmallestNumericId('drivers');
          const driverData = {
            UserID: userId,
            LicenseNumber: license,
            TricyclePlateNumber: approvedApp.TricyclePlateNumber || approvedApp.TricycleNumber || approvedApp.tricycle || approvedApp.Tricycle || '',
            TricycleNumber: approvedApp.TricycleNumber || approvedApp.tricycle || approvedApp.Tricycle || '',
            Status: 'Active',
            ApplicationStatus: 'ADDED',
            IsApplying: false,
            CreatedAt: new Date().toISOString()
          };
          await window.dbSet(window.dbRef(window.db, `drivers/${newDriverId}`), driverData);

          // Link user to driver
          try {
            await window.dbUpdate(window.dbRef(window.db, `users/${userId}`), { DriverID: newDriverId });
          } catch (e) {}

          // Update application to link driver and mark as ADDED
          try {
            await window.dbUpdate(window.dbRef(window.db, `applications/${appId}`), { 
              DriverID: newDriverId,
              ApplicationStatus: 'APPROVED - ADDED',
              ImportedAt: new Date().toISOString()
            });
          } catch (e) {}

          window.showAlert(`Imported ${name || 'applicant'} as driver ID ${newDriverId}`, 'success');
        } catch (err) {
          console.error('Error importing application', err);
          window.showAlert('Error importing application: ' + (err && err.message ? err.message : err), 'error');
        } finally {
          setImporting(prev => { const n = { ...prev }; n[appId] = false; return n; });
        }
      };

      const importAll = async () => {
        for (const app of approvedApplications || []) {
          await importApplication(app.id);
        }
      };

      return (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50 overflow-y-auto py-8">
          <div className="bg-[#1e2538] p-6 rounded-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-2xl font-bold text-white">Driver Approved Applications</h2>
              <div className="flex items-center gap-2">
                <button onClick={importAll} className="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-white">Import All</button>
                <button onClick={onClose} className="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-white">Close</button>
              </div>
            </div>
            <p className="text-gray-300 text-sm mb-4">These are the applications that approved by TODA Officer and are not yet present in Driver Management.</p>
            <div className="space-y-3">
              {(approvedApplications && approvedApplications.length) ? approvedApplications.map((app) => (
                <div key={app.id} className="flex justify-between items-center p-4 rounded-lg bg-[#252d42]">
                  <div>
                    <p className="font-bold text-white">{app.Name || [app.Firstname, app.Middlename, app.Lastname].filter(Boolean).join(' ') || app.ApplicantName || 'Unnamed'}</p>
                    <p className="text-sm text-gray-400">License: {formatLicense(app.LicenseNumber || app.license || app.License || '')} | Phone: {stripPhonePrefix(app.MobileNumber || app.Mobile || app.Contact || '')}</p>
                  </div>
                  <div className="flex items-center gap-3">
                    <button onClick={() => importApplication(app.id)} disabled={importing[app.id]} className={`px-4 py-2 rounded font-semibold ${importing[app.id] ? 'bg-gray-600 text-white cursor-not-allowed' : 'bg-yellow-500 text-gray-900 hover:bg-yellow-600'}`}>
                      {importing[app.id] ? 'Importing…' : 'Import'}
                    </button>
                  </div>
                </div>
              )) : (
                <p className="text-gray-400">No approved applications available for import.</p>
              )}
            </div>
          </div>
        </div>
      );
    };

    const AddDriverModal = ({ onClose, onSave }) => {
      const [newDriver, setNewDriver] = useState({
        name: "",
        tricycle: "",
        contact: "",
        license: "",
        status: "Active"
      });
      const [nameError, setNameError] = useState("");
      const [licenseError, setLicenseError] = useState("");
      const [isSaving, setIsSaving] = useState(false);

      const handleChange = (field, value) => {
        if (field === 'contact') {
          const numericValue = value.replace(/\D/g, '').slice(0, 11);
          setNewDriver(prev => ({
            ...prev,
            [field]: numericValue
          }));
        } else if (field === 'name') {
          const hadDigits = /\d/.test(value);
          if (hadDigits) {
            setNameError('Names cannot contain numbers');
          } else {
            setNameError('');
          }
          const sanitized = value.replace(/[^a-zA-Z\s\-']/g, '');
          setNewDriver(prev => ({
            ...prev,
            [field]: sanitized
          }));
        } else {
          setNewDriver(prev => ({
            ...prev,
            [field]: value
          }));
        }
        
        if (field === 'license') {
          const raw = value.replace(/[^A-Za-z0-9\-]/g, '');
          setNewDriver(prev => ({ ...prev, license: raw }));
          setLicenseError('');
        }
      };

      const handleBlur = (field) => {
        if (field === 'license') {
          const formatted = formatLicense(newDriver.license);
          setNewDriver(prev => ({ ...prev, license: formatted }));
          if (!formatted || formatted.length < 13) {
            setLicenseError('License number seems incomplete.');
            return;
          }
          if (!isValidLicense(formatted)) {
            setLicenseError('License must match format A01-23-456789');
          } else {
            setLicenseError('');
          }
        }
      };

      const handleAddDriver = () => {
        if (isSaving) return;
        if (!newDriver.name || !newDriver.tricycle || !newDriver.contact || !newDriver.license) {
          window.showAlert("Please fill in all fields!", 'error');
          return;
        }
        const formattedLicense = formatLicense(newDriver.license);
        const licenseRegex = /^[A-Z]\d{2}-\d{2}-\d{6}$/;
        if (!licenseRegex.test(formattedLicense)) {
          window.showAlert('License number must match format like A01-23-456789', 'error');
          return;
        }
        if (/\d/.test(newDriver.name)) {
          window.showAlert('Full name cannot contain numbers. Please remove any digits.', 'error');
          return;
        }
        if (newDriver.contact.length !== 11) {
          window.showAlert("Phone number must be exactly 11 digits!", 'error');
          return;
        }
        const duplicateTricycle = window.drivers && window.drivers.some(d => d.tricycle === newDriver.tricycle);
        if (duplicateTricycle) {
          window.showAlert("Error: Plate number already exists! Please use a unique plate number.", 'error');
          return;
        }
        try {
          const normNew = normalizeLicenseForCompare(newDriver.license);
          const dup = window.drivers && window.drivers.some(d => normalizeLicenseForCompare(d.license) === normNew);
          if (dup) {
            window.showAlert('License number already exists. Please provide a unique license number.', 'error');
            return;
          }
        } catch(e) {}
        try {
          setIsSaving(true);
          const res = onSave(newDriver);
          if (res && typeof res.then === 'function') {
            res.then(() => setIsSaving(false)).catch(() => setIsSaving(false));
          } else {
            setIsSaving(false);
          }
        } catch (e) {
          setIsSaving(false);
          throw e;
        }
      };

      return (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50">
          <div className="bg-[#1e2538] p-8 rounded-xl w-full max-w-md">
            <h2 className="text-2xl font-bold mb-6 text-white">Add New Driver</h2>
            <div className="grid grid-cols-2 gap-4">
              <input 
                className="col-span-1 px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                placeholder="Full Name" 
                value={newDriver.name}
                onChange={(e) => handleChange('name', e.target.value)}
              />
              {nameError && (
                <p className="col-span-2 text-sm text-red-400 mt-1">{nameError}</p>
              )}
              <input 
                className="col-span-1 px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                placeholder="Tricycle Plate Number" 
                value={newDriver.tricycle}
                onChange={(e) => handleChange('tricycle', e.target.value)}
              />
              <input 
                className="col-span-1 px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                placeholder="Phone Number (11 digits)" 
                value={newDriver.contact}
                onChange={(e) => handleChange('contact', e.target.value)}
                maxLength={11}
              />
              <input 
                className="col-span-1 px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                placeholder="License Number (e.g. A01-23-456789)" 
                value={newDriver.license}
                onChange={(e) => handleChange('license', e.target.value)}
                onBlur={() => handleBlur('license')}
                maxLength={13}
              />
              {licenseError && (
                <p className="col-span-2 text-sm text-red-400 mt-1">{licenseError}</p>
              )}
            </div>
            <p className="text-xs text-gray-400 mt-2">Phone number: {newDriver.contact.length}/11 digits</p>
            <div className="flex justify-between mt-6">
              <button onClick={onClose} className="bg-red-600 hover:bg-red-700 px-8 py-3 rounded-lg font-semibold text-white">Cancel</button>
              <button onClick={handleAddDriver} disabled={isSaving} className={`px-8 py-3 rounded-lg font-semibold text-white ${isSaving ? 'bg-gray-600 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'}`}>
                {isSaving ? 'Adding…' : 'Add Driver'}
              </button>
            </div>
          </div>
        </div>
      );
    };

    const ExportDataModal = ({ drivers, onClose }) => {
      const [selectedDrivers, setSelectedDrivers] = useState([]);

      const toggleDriver = (index) => {
        setSelectedDrivers(prev => 
          prev.includes(index) 
            ? prev.filter(i => i !== index)
            : [...prev, index]
        );
      };

      const exportToCSV = (driversToExport, filename) => {
        const headers = ["Name", "Plate #", "License", "Contact", "Status", "Registered Date", "Franchise Expiry"];
        const csvContent = [
          headers.join(","),
          ...driversToExport.map(driver => 
            `"${driver.name}","${driver.tricycle}","${driver.license}","${driver.contact}","${driver.status}","Jan 15, 2024","Jan 15, 2025"`
          )
        ].join("\n");

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      const handleExportSelected = () => {
        if (selectedDrivers.length === 0) {
          window.showAlert("Please select at least one driver to export!", 'error');
          return;
        }
        const driversToExport = selectedDrivers.map(index => drivers[index]);
        exportToCSV(driversToExport, 'selected_drivers.csv');
        window.showAlert(`Exported ${selectedDrivers.length} driver(s) successfully!`, 'success');
      };

      const handleExportAll = () => {
        exportToCSV(drivers, 'all_drivers.csv');
        window.showAlert(`Exported all ${drivers.length} drivers successfully!`, 'success');
      };

      return (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50 overflow-y-auto py-8">
          <div className="bg-[#1e2538] p-8 rounded-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-white">Export Data</h2>
            <p className="text-gray-300 mb-4 text-sm">Select drivers to export or export all data</p>
            <div className="space-y-3">
              {drivers.map((driver, idx) => (
                <div 
                  key={idx} 
                  onClick={() => toggleDriver(idx)}
                  className={`flex justify-between items-center p-4 rounded-lg cursor-pointer transition-all ${
                    selectedDrivers.includes(idx) 
                      ? 'bg-yellow-500 bg-opacity-20 border-2 border-yellow-500' 
                      : 'bg-[#252d42] border-2 border-transparent hover:border-gray-600'
                  }`}
                >
                  <div className="flex items-center gap-3">
                    <input 
                      type="checkbox" 
                      checked={selectedDrivers.includes(idx)}
                      onChange={() => toggleDriver(idx)}
                      className="w-5 h-5 cursor-pointer"
                    />
                    <div>
                      <p className="font-bold text-white">{driver.name}</p>
                      <p className="text-sm text-gray-400">
                        Plate #{driver.tricycle} | License: {driver.license} | Phone: {stripPhonePrefix(driver.contact)}
                      </p>
                    </div>
                  </div>
                  <span className={`inline-flex items-center justify-center h-9 min-w-[88px] px-4 rounded-lg text-sm font-bold text-white ${driver.status === "Active" ? "bg-green-500" : "bg-gray-500"}`}>
                    {driver.status === "Active" ? "ONLINE" : "OFFLINE"}
                  </span>
                </div>
              ))}
            </div>
            <div className="flex justify-between mt-6">
              <button onClick={onClose} className="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold text-white">Close</button>
              <div className="flex gap-3">
                <button 
                  onClick={handleExportSelected}
                  className="bg-yellow-500 hover:bg-yellow-600 px-6 py-3 rounded-lg font-semibold text-gray-900 flex items-center gap-2"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  Export Selected ({selectedDrivers.length})
                </button>
                <button 
                  onClick={handleExportAll}
                  className="bg-yellow-500 hover:bg-yellow-600 px-6 py-3 rounded-lg font-semibold text-gray-900 flex items-center gap-2"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  Export All ({drivers.length})
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const EditDriverModal = ({ driver, driverIndex, onClose, onSave }) => {
      const formatDateForInput = (iso) => {
        if (!iso) return '';
        try {
          const d = new Date(iso);
          const yyyy = d.getUTCFullYear();
          const mm = String(d.getUTCMonth() + 1).padStart(2, '0');
          const dd = String(d.getUTCDate()).padStart(2, '0');
          return `${yyyy}-${mm}-${dd}`;
        } catch (e) { return ''; }
      };

      const [editedDriver, setEditedDriver] = useState({
        name: driver.name,
        contact: stripPhonePrefix(driver.contact),
        registeredDate: formatDateForInput(driver.registeredDate || ''),
        license: driver.license,
        tricycle: driver.tricycle,
        franchiseExpiry: driver.franchiseExpiry || ''
      });
      const [editedLicenseError, setEditedLicenseError] = useState("");

      const handleChange = (field, value) => {
        if (field === 'contact') {
          const numericValue = value.replace(/\D/g, '').slice(0, 11);
          setEditedDriver(prev => ({
            ...prev,
            [field]: numericValue
          }));
        } else if (field === 'license') {
          const raw = value.replace(/[^A-Za-z0-9\-]/g, '');
          setEditedDriver(prev => ({ ...prev, license: raw }));
          setEditedLicenseError('');
        } else {
          setEditedDriver(prev => ({
            ...prev,
            [field]: value
          }));
        }
      };

      const handleEditBlur = (field) => {
        if (field === 'license') {
          const formatted = formatLicense(editedDriver.license);
          setEditedDriver(prev => ({ ...prev, license: formatted }));
          if (!formatted || formatted.length < 13) {
            setEditedLicenseError('License number seems incomplete.');
            return;
          }
          if (!isValidLicense(formatted)) {
            setEditedLicenseError('License must match format A01-23-456789');
          } else {
            setEditedLicenseError('');
          }
        }
      };

      const handleSave = async () => {
        const contactDigits = editedDriver.contact.toString().replace(/\D/g, '');
        if (contactDigits.length !== 11) {
          window.showAlert("Phone number must be exactly 11 digits!", 'error');
          return;
        }
        if (!isValidLicense(editedDriver.license)) {
          window.showAlert('License number must match format like A01-23-456789', 'error');
          return;
        }
        try {
          const normEdited = normalizeLicenseForCompare(editedDriver.license);
          const dup = window.drivers && window.drivers.some(d => normalizeLicenseForCompare(d.license) === normEdited && d.id !== driver.id);
          if (dup) {
            window.showAlert('License number already exists for another driver. Please use a unique license number.', 'error');
            return;
          }
        } catch(e) {}

        const contactWithPrefix = '+63' + contactDigits;

        try {
          const driverToUpdate = driver || {};
          const driverId = driverToUpdate.driverId || null;
          const userId = driverToUpdate.userId;

          if (userId) {
            const nameParts = (editedDriver.name || '').trim().split(/\s+/);
            const firstname = nameParts[0] || '';
            const lastname = nameParts.length > 1 ? nameParts[nameParts.length - 1] : '';
            const middlename = nameParts.length > 2 ? nameParts.slice(1, -1).join(' ') : '';
            const userRef = window.dbRef(window.db, `users/${userId}`);
            const userSnap = await window.dbGet(userRef);
            const userObj = userSnap.exists() ? userSnap.val() : {};
            userObj.Firstname = firstname;
            userObj.Middlename = middlename;
            userObj.Lastname = lastname;
            userObj.MobileNumber = contactWithPrefix;
            await window.dbSet(userRef, userObj);
          }

          if (driverId) {
            const driverRef = window.dbRef(window.db, `drivers/${driverId}`);
            await window.dbUpdate(driverRef, {
              LicenseNumber: editedDriver.license,
              TricyclePlateNumber: editedDriver.tricycle,
              TricycleNumber: editedDriver.tricycle,
              FranchiseExpiry: editedDriver.franchiseExpiry || ''
            });
          }

          onSave(driverIndex, { ...editedDriver, contact: contactWithPrefix });
          window.showAlert('Driver information updated successfully!', 'success');
          onClose();
        } catch (err) {
          console.error('Error saving driver edits:', err);
          window.showAlert('Error saving changes: ' + (err && err.message ? err.message : err), 'error');
        }
      };

      if (!driver) return null;
      return (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50 p-4">
          <div className="bg-[#1e2538] p-8 rounded-xl w-full max-w-md sm:max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 className="font-bold mb-6 text-white text-2xl">Edit Driver Information</h2>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div className="col-span-2">
                <label className="block text-gray-300 mb-2 font-medium">Driver Name</label>
                <input 
                  className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                  value={editedDriver.name}
                  onChange={(e) => handleChange('name', e.target.value)}
                />
              </div>
              <div>
                <label className="block text-gray-300 mb-2 font-medium">Contact Number (11 digits)</label>
                <div className="flex">
                  <div className="inline-flex items-center px-3 rounded-l-lg bg-[#1b2333] text-white border border-r-0 border-gray-700">+63</div>
                  <input 
                    className="w-full px-4 py-3 rounded-r-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                    value={editedDriver.contact}
                    onChange={(e) => handleChange('contact', e.target.value)}
                    maxLength={11}
                  />
                </div>
                <p className="text-xs text-gray-400 mt-1">{editedDriver.contact.replace(/\D/g, '').length}/11 digits</p>
              </div>
              <div>
                <label className="block text-gray-300 mb-2 font-medium">Registration Date</label>
                <input 
                  type="date" 
                  className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                  value={editedDriver.registeredDate}
                  onChange={(e) => handleChange('registeredDate', e.target.value)}
                />
              </div>
              <div>
                <label className="block text-gray-300 mb-2 font-medium">License Number</label>
                <input 
                  className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                  value={editedDriver.license}
                  onChange={(e) => handleChange('license', e.target.value)}
                  onBlur={() => handleEditBlur('license')}
                />
                {editedLicenseError && (
                  <p className="text-sm text-red-400 mt-1">{editedLicenseError}</p>
                )}
              </div>
              <div>
                <label className="block text-gray-300 mb-2 font-medium">Plate Number</label>
                <input 
                  className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                  value={editedDriver.tricycle}
                  onChange={(e) => handleChange('tricycle', e.target.value)}
                />
              </div>
              <div>
                <label className="block text-gray-300 mb-2 font-medium">Franchise Expiry</label>
                <input 
                  type="date" 
                  className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                  value={editedDriver.franchiseExpiry}
                  onChange={(e) => handleChange('franchiseExpiry', e.target.value)}
                />
              </div>
            </div>
            <div className="flex flex-col sm:flex-row sm:justify-between gap-3 mt-6">
              <button onClick={onClose} className="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold text-white w-full sm:w-auto">Cancel</button>
              <button onClick={handleSave} className="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold text-white w-full sm:w-auto">Save Changes</button>
            </div>
          </div>
        </div>
      );
    };

    const claimSmallestNumericId = async (baseNode) => {
      if (!window.dbGet || !window.dbRef || !window.dbRunTransaction) throw new Error('DB helpers missing');
      const nodeRef = window.dbRef(window.db, baseNode);
      const snap = await window.dbGet(nodeRef);
      const keys = snap && snap.val() ? Object.keys(snap.val()) : [];
      const numericKeys = keys.map(k => parseInt(k, 10)).filter(n => Number.isInteger(n) && n > 0);
      const max = numericKeys.length ? Math.max(...numericKeys) : 0;

      for (let candidate = 1; candidate <= max; candidate++) {
        if (!numericKeys.includes(candidate)) {
          const allocRef = window.dbRef(window.db, `allocations/${baseNode}/${candidate}`);
          try {
            const tx = await window.dbRunTransaction(allocRef, (current) => {
              if (current) return;
              return { reservedAt: Date.now() };
            });
            if (tx && tx.committed) {
              return candidate;
            }
          } catch (e) {}
        }
      }

      const newId = max + 1;
      const allocRef2 = window.dbRef(window.db, `allocations/${baseNode}/${newId}`);
      await window.dbRunTransaction(allocRef2, (current) => {
        if (current) return;
        return { reservedAt: Date.now() };
      });
      return newId;
    };

    const AdminDashboard = () => {
      const [currentTab, setCurrentTab] = useState('drivers');
      const [selectedDriver, setSelectedDriver] = useState(null);
      const [selectedDriverIndex, setSelectedDriverIndex] = useState(null);
      const [showExportModal, setShowExportModal] = useState(false);
      const [showAddModal, setShowAddModal] = useState(false);
      const [confirmDelete, setConfirmDelete] = useState({ open: false, index: null });

      const [rawUsers, setRawUsers] = useState({});
      const [rawDrivers, setRawDrivers] = useState({});
      const [rawApplications, setRawApplications] = useState({});
      const [rawBookings, setRawBookings] = useState({});
      const [rawPassengers, setRawPassengers] = useState({});
      const [rawFeedback, setRawFeedback] = useState({});
      const [rawAuditLogs, setRawAuditLogs] = useState({});
      const [drivers, setDrivers] = useState([]);
      const [bookings, setBookings] = useState([]);
      const [passengers, setPassengers] = useState([]);
      const [auditLogs, setAuditLogs] = useState([]);
      const [showImportModal, setShowImportModal] = useState(false);
      
      // Booking filtering states
      const [dateFromBooking, setDateFromBooking] = useState("");
      const [dateToBooking, setDateToBooking] = useState("");
      const [selectedDriverBooking, setSelectedDriverBooking] = useState("All Drivers");
      const [statusFiltersBooking, setStatusFiltersBooking] = useState({ Completed: true, Pending: true, Cancelled: true });
      const [showBookingFilterModal, setShowBookingFilterModal] = useState(false);
      const [filteredBookings, setFilteredBookings] = useState([]);
      
      // Logs search state
      const [logsSearchTerm, setLogsSearchTerm] = useState("");
      const [filteredLogs, setFilteredLogs] = useState([]);

      useEffect(() => {
        if (!window.db || !window.dbRef || !window.dbOnValue) return;

        const usersRef = window.dbRef(window.db, 'users');
        const driversRef = window.dbRef(window.db, 'drivers');
        const applicationsRef = window.dbRef(window.db, 'applications');
        const bookingsRef = window.dbRef(window.db, 'bookings');
        const passengersRef = window.dbRef(window.db, 'passengers');
        const feedbackRef = window.dbRef(window.db, 'feedback');
        const auditLogsRef = window.dbRef(window.db, 'auditLogs');

        const unsubUsers = window.dbOnValue(usersRef, snap => setRawUsers(snap.val() || {}));
        const unsubDrivers = window.dbOnValue(driversRef, snap => setRawDrivers(snap.val() || {}));
        const unsubApplications = window.dbOnValue(applicationsRef, snap => setRawApplications(snap.val() || {}));
        const unsubBookings = window.dbOnValue(bookingsRef, snap => setRawBookings(snap.val() || {}));
        const unsubPassengers = window.dbOnValue(passengersRef, snap => setRawPassengers(snap.val() || {}));
        const unsubFeedback = window.dbOnValue(feedbackRef, snap => setRawFeedback(snap.val() || {}));
        const unsubAuditLogs = window.dbOnValue(auditLogsRef, snap => setRawAuditLogs(snap.val() || {}));

        return () => {
          try { unsubUsers(); } catch(e) {}
          try { unsubDrivers(); } catch(e) {}
          try { unsubApplications(); } catch(e) {}
          try { unsubBookings(); } catch(e) {}
          try { unsubPassengers(); } catch(e) {}
          try { unsubFeedback(); } catch(e) {}
          try { unsubAuditLogs(); } catch(e) {}
        };
      }, []);

      // Derived list: approved drivers/applications available for import (similar to Driver Management page)
      const approvedApplications = (() => {
        try {
          const drvs = rawDrivers || {};
          const allDriversFromDb = Object.entries(drvs).map(([id, d]) => {
            if (!d || !d.UserID) return null;
            const user = rawUsers && rawUsers[d.UserID];
            if (!user || user.DeletedAt) return null;
            const name = user ? [user.Firstname, user.Middlename, user.Lastname].filter(Boolean).join(' ') : 'Unnamed';
            const phone = user ? user.MobileNumber : '';
            const status = (d.ApplicationStatus || d.Status || '').toString().toUpperCase().trim();
            return {
              id,
              UserID: d.UserID,
              LicenseNumber: d.LicenseNumber || '',
              TricycleNumber: d.TricycleNumber || d.TricyclePlateNumber || '',
              TricyclePlateNumber: d.TricyclePlateNumber || d.TricycleNumber || '',
              ApplicationStatus: status,
              Name: name,
              MobileNumber: phone,
              Firstname: user ? user.Firstname : '',
              Middlename: user ? user.Middlename : '',
              Lastname: user ? user.Lastname : '',
              _source: 'drivers',
              _status: status
            };
          }).filter(Boolean);

          const apps = rawApplications || {};
          const appsArr = Object.entries(apps).map(([id, a]) => {
            if (a.DriverID) return null;
            const userId = a.UserID;
            const user = userId && rawUsers && rawUsers[userId];
            if (!user || user.DeletedAt) return null;
            const name = user ? [user.Firstname, user.Middlename, user.Lastname].filter(Boolean).join(' ') : (a.Name || a.ApplicantName || 'Unnamed');
            const phone = user ? user.MobileNumber : (a.MobileNumber || a.Contact || a.Mobile || '');
            const status = (a.ApplicationStatus || a.Status || '').toString().toUpperCase().trim();
            return {
              id,
              ...a,
              Name: name,
              Firstname: user ? user.Firstname : a.Firstname,
              Middlename: user ? user.Middlename : a.Middlename,
              Lastname: user ? user.Lastname : a.Lastname,
              MobileNumber: phone,
              UserID: userId,
              _source: 'applications',
              _status: status
            };
          }).filter(Boolean);

          const allApproved = [...allDriversFromDb, ...appsArr].filter(a => {
            const status = a._status || '';
            return status.includes('APPROVED');
          });

          const filtered = allApproved.filter(a => {
            const alreadyExists = drivers.some(d => {
              if (a.LicenseNumber) {
                const match = normalizeLicenseForCompare(d.license) === normalizeLicenseForCompare(a.LicenseNumber);
                if (match) return true;
              }
              if (a.UserID) {
                const match = d.userId === a.UserID;
                if (match) return true;
              }
              return false;
            });
            return !alreadyExists;
          });

          return filtered;
        } catch (e) { return []; }
      })();

      useEffect(() => {
        const makeFullName = (u) => {
          if (!u) return 'Unknown';
          return [u.Firstname, u.Middlename, u.Lastname].filter(Boolean).join(' ');
        };

        const usersVal = rawUsers || {};
        const drvsVal = rawDrivers || {};
        const driversArr = Object.entries(usersVal)
          .map(([userId, u]) => {
            if (!u) return null;
            if (String(u.RoleID) !== '2') return null;
            if (!u.IsActive) return null;
            if (u.DeletedAt) return null;

            let drvKey = null;
            let drvRec = null;
            for (const [k, drv] of Object.entries(drvsVal)) {
              if (!drv) continue;
              if (String(drv.UserID) === String(userId)) { drvKey = k; drvRec = drv; break; }
            }

            const name = makeFullName(u);
            const tricycle = drvRec ? (drvRec.TricyclePlateNumber || drvRec.TricycleNumber || '') : '';
            const license = drvRec ? (drvRec.LicenseNumber || '') : '';
            const contact = u ? u.MobileNumber : '';
            const status = drvRec && (drvRec.Status === 'Active' || (drvRec.ApplicationStatus || '').toString().toUpperCase().includes('ADDED')) ? 'Active' : 'Inactive';

            return {
              id: drvKey || `user-${userId}`,
              driverId: drvKey || null,
              userId: userId,
              name,
              tricycle,
              license,
              contact,
              status,
              isActiveUser: !!u.IsActive,
              registeredDate: u.CreatedAt || '' ,
              franchiseExpiry: drvRec ? (drvRec.FranchiseExpiry || '') : ''
            };
          })
          .filter(Boolean);

        setDrivers(driversArr);
        window.drivers = driversArr;
      }, [rawUsers, rawDrivers]);

      // Derive bookings array for stats calculation
      useEffect(() => {
        try {
          const bookingsVal = rawBookings || {};
          const bookingsArr = Object.entries(bookingsVal)
            .map(([bookingId, booking]) => {
              if (!booking) return null;
              const passengerId = booking.PassengerID;
              const driverId = booking.DriverID;
              const passenger = passengerId && rawUsers && rawUsers[passengerId];
              const driver = driverId && rawUsers && rawUsers[driverId];
              
              return {
                id: bookingId,
                raw: booking,
                passengerName: passenger ? [passenger.Firstname, passenger.Middlename, passenger.Lastname].filter(Boolean).join(' ') : 'Unknown Passenger',
                driverName: driver ? [driver.Firstname, driver.Middlename, driver.Lastname].filter(Boolean).join(' ') : 'Unknown Driver',
                status: booking.Status || 'Pending',
                requestedAt: booking.RequestedAt || '',
                pickup: booking.PickupLocation || '',
                destination: booking.DropoffLocation || '',
                fare: booking.TotalFare || 0,
                distance: booking.distanceKm ? `${booking.distanceKm}km` : ''
              };
            })
            .filter(Boolean);
          
          setBookings(bookingsArr);
          setFilteredBookings(bookingsArr);
        } catch (e) {
          console.error('Error deriving bookings:', e);
        }
      }, [rawBookings, rawUsers]);

      // Derive passengers array
      useEffect(() => {
        try {
          const passengersVal = rawPassengers || {};
          const passengersArr = Object.entries(passengersVal)
            .map(([passengerId, passenger]) => {
              if (!passenger) return null;
              const user = passenger.UserID && rawUsers && rawUsers[passenger.UserID];
              if (!user) return null;
              const name = [user.Firstname, user.Middlename, user.Lastname].filter(Boolean).join(' ');
              const email = user.Email || '';
              const phone = user.MobileNumber || '';
              const totalRides = Object.values(rawBookings || {}).filter(b => b.PassengerID === passenger.UserID).length;
              
              return {
                id: passengerId,
                userId: passenger.UserID,
                name,
                email,
                phone,
                totalRides,
                joinedDate: user.CreatedAt || ''
              };
            })
            .filter(Boolean)
            .sort((a, b) => b.totalRides - a.totalRides);
          
          setPassengers(passengersArr);
        } catch (e) {
          console.error('Error deriving passengers:', e);
        }
      }, [rawPassengers, rawUsers, rawBookings]);

      // Derive audit logs
      useEffect(() => {
        try {
          const logsVal = rawAuditLogs || {};
          const logsArr = Object.entries(logsVal)
            .map(([logKey, log]) => {
              if (!log) return null;
              const driverId = log.DriverID || '';
              let driverName = 'Unknown Driver';
              try {
                const drv = rawDrivers && rawDrivers[driverId];
                if (drv && drv.UserID && rawUsers && rawUsers[drv.UserID]) {
                  const u = rawUsers[drv.UserID];
                  driverName = [u.Firstname, u.Middlename, u.Lastname].filter(Boolean).join(' ');
                } else if (drv) {
                  driverName = drv.Name || drv.name || 'Unknown';
                }
              } catch (e) {}
              
              const formatDate = (timestamp) => {
                if (!timestamp) return '';
                const date = new Date(timestamp);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
              };
              
              return {
                id: logKey,
                bookingId: log.BookingID || '',
                driver: driverName,
                driverId: driverId,
                event: log.ViolationType || log.event || '',
                location: log.Location || log.location || '',
                timestamp: formatDate(log.ViolationTimestamp || log.timestamp || ''),
                status: log.IsFlaggedForReview ? 'Flagged' : (log.status || 'Reviewed')
              };
            })
            .filter(Boolean)
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          
          setAuditLogs(logsArr);
          setFilteredLogs(logsArr);
        } catch (e) {
          console.error('Error deriving audit logs:', e);
        }
      }, [rawAuditLogs, rawDrivers, rawUsers]);

      // Apply booking filters
      const applyBookingFilters = () => {
        let filtered = [...bookings];
        if (dateFromBooking) filtered = filtered.filter(b => b.requestedAt.slice(0, 10) >= dateFromBooking);
        if (dateToBooking) filtered = filtered.filter(b => b.requestedAt.slice(0, 10) <= dateToBooking);
        if (selectedDriverBooking !== "All Drivers") filtered = filtered.filter(b => b.driverName === selectedDriverBooking);
        filtered = filtered.filter(b => {
          const status = (b.status || 'Pending').charAt(0).toUpperCase() + (b.status || 'Pending').slice(1).toLowerCase();
          return statusFiltersBooking[status];
        });
        setFilteredBookings(filtered);
        setShowBookingFilterModal(false);
      };

      // Filter logs by search term
      useEffect(() => {
        const filtered = auditLogs.filter(log =>
          log.bookingId.toLowerCase().includes(logsSearchTerm.toLowerCase()) ||
          log.driver.toLowerCase().includes(logsSearchTerm.toLowerCase()) ||
          log.event.toLowerCase().includes(logsSearchTerm.toLowerCase()) ||
          log.location.toLowerCase().includes(logsSearchTerm.toLowerCase()) ||
          log.timestamp.includes(logsSearchTerm)
        );
        setFilteredLogs(filtered);
      }, [logsSearchTerm, auditLogs]);

      const handleEditDriver = (index) => {
        setSelectedDriver(drivers[index]);
        setSelectedDriverIndex(index);
      };

      const handleSaveDriver = async (index, editedDriver) => {
        try {
          const driverToUpdate = drivers[index];
          const driverId = driverToUpdate.id;
          const userId = driverToUpdate.userId;

          const nameParts = editedDriver.name.trim().split(/\s+/);
          const firstname = nameParts[0] || '';
          const lastname = nameParts.length > 1 ? nameParts[nameParts.length - 1] : '';
          const middlename = nameParts.length > 2 ? nameParts.slice(1, -1).join(' ') : '';

          const userRef = window.dbRef(window.db, `users/${userId}`);
          const userSnap = await window.dbGet(userRef);
          const userObj = userSnap.exists() ? userSnap.val() : {};
          userObj.Firstname = firstname;
          userObj.Middlename = middlename;
          userObj.Lastname = lastname;
          userObj.MobileNumber = editedDriver.contact;
          await window.dbSet(userRef, userObj);

          const driverRef = window.dbRef(window.db, `drivers/${driverId}`);
          await window.dbUpdate(driverRef, {
            LicenseNumber: editedDriver.license,
            TricyclePlateNumber: editedDriver.tricycle,
            TricycleNumber: editedDriver.tricycle,
            FranchiseExpiry: editedDriver.franchiseExpiry || ''
          });

          const updatedDrivers = [...drivers];
          updatedDrivers[index] = {
            ...updatedDrivers[index],
            name: editedDriver.name,
            contact: editedDriver.contact,
            license: editedDriver.license,
            tricycle: editedDriver.tricycle
          };
          setDrivers(updatedDrivers);
          setSelectedDriver(null);
          setSelectedDriverIndex(null);
          window.showAlert("Driver information updated successfully!", 'success');
        } catch (error) {
          console.error('Error updating driver:', error);
          window.showAlert('Error updating driver: ' + error.message, 'error');
        }
      };

      const handleAddNewDriver = async (newDriver) => {
        try {
          const newUserId = await claimSmallestNumericId('users');

          const nameParts = newDriver.name.trim().split(/\s+/);
          const firstname = nameParts[0] || '';
          const lastname = nameParts.length > 1 ? nameParts[nameParts.length - 1] : '';
          const middlename = nameParts.length > 2 ? nameParts.slice(1, -1).join(' ') : '';

          const userData = {
            Firstname: firstname,
            Middlename: middlename,
            Lastname: lastname,
            MobileNumber: newDriver.contact,
            Role: 'Driver',
            RoleID: 2,
            CreatedAt: new Date().toISOString(),
            IsActive: true,
            Status: 'Active'
          };

          const userRef = window.dbRef(window.db, `users/${newUserId}`);
          await window.dbSet(userRef, userData);

          const newDriverId = await claimSmallestNumericId('drivers');
          const formattedLicense = formatLicense(newDriver.license);

          const driverData = {
            UserID: newUserId,
            LicenseNumber: formattedLicense,
            TricyclePlateNumber: newDriver.tricycle,
            TricycleNumber: newDriver.tricycle,
            Status: 'Active',
            ApplicationStatus: 'ADDED',
            IsApplying: false,
            CreatedAt: new Date().toISOString()
          };

          const driverRef = window.dbRef(window.db, `drivers/${newDriverId}`);
          await window.dbSet(driverRef, driverData);

          // Link the created driver id back to the user record so other pages can find the mapping
          try {
            await window.dbUpdate(window.dbRef(window.db, `users/${newUserId}`), { DriverID: newDriverId });
          } catch (e) { /* non-fatal */ }

          setShowAddModal(false);
          window.showAlert(`Driver ${newDriver.name} added successfully (ID: ${newDriverId}) to Firebase!`, 'success');
        } catch (error) {
          console.error('Error adding driver:', error);
          window.showAlert('Error adding driver to database: ' + (error && error.message ? error.message : error), 'error');
        }
      };

      const handleDeleteDriver = (index) => {
        setConfirmDelete({ open: true, index });
      };

      const performDeleteDriver = async (index) => {
        const driverToDelete = drivers[index];
        if (!driverToDelete) return;
        try {
          const driverKey = driverToDelete.id;
          const driverRecord = rawDrivers && rawDrivers[driverKey];
          const userIdToDelete = driverRecord ? driverRecord.UserID : null;

          const driverRef = window.dbRef(window.db, `drivers/${driverKey}`);
          await window.dbUpdate(driverRef, {
            Status: 'Inactive',
            DeletedAt: new Date().toISOString()
          });

          if (userIdToDelete) {
            const userRef = window.dbRef(window.db, `users/${userIdToDelete}`);
            await window.dbUpdate(userRef, {
              IsActive: false,
              Status: 'Inactive',
              DeletedAt: new Date().toISOString()
            });
          }

          setConfirmDelete({ open: false, index: null });
          window.showAlert(`Driver ${driverToDelete.name} has been deactivated (soft-deleted).`, 'success');
        } catch (error) {
          console.error('Error deleting driver:', error);
          window.showAlert('Error deleting driver: ' + (error && error.message ? error.message : error), 'error');
          setConfirmDelete({ open: false, index: null });
        }
      };

      return (
        <div className="min-h-screen bg-[#0a0e1a]">
          {/* Header */}
          <header className="bg-[#151b28] border-b border-gray-700">
            <div className="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <img src="tricy.png" alt="Logo" className="w-8 h-8" />
                <div>
                  <h1 className="text-xl font-bold text-yellow-500">PASAKAY</h1>
                  <p className="text-xs text-gray-400">Admin Dashboard</p>
                </div>
              </div>
              <div className="text-right">
                <p className="text-gray-300">Administrator</p>
                <p className="text-xs text-gray-500">System Admin</p>
              </div>
            </div>
          </header>

          {/* Navigation Tabs */}
          <div className="bg-[#0f1419] border-b border-gray-700 sticky top-0 z-10">
            <div className="max-w-7xl mx-auto px-6">
              <div className="flex gap-8 overflow-x-auto">
                <button
                  onClick={() => setCurrentTab('overview')}
                  className={`py-4 px-2 border-b-2 font-medium transition-colors whitespace-nowrap ${
                    currentTab === 'overview'
                      ? 'border-yellow-500 text-yellow-500'
                      : 'border-transparent text-gray-400 hover:text-yellow-400'
                  }`}
                >
                  <svg className="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                  </svg>
                  Overview
                </button>
                <button
                  onClick={() => setCurrentTab('drivers')}
                  className={`py-4 px-2 border-b-2 font-medium transition-colors whitespace-nowrap ${
                    currentTab === 'drivers'
                      ? 'border-yellow-500 text-yellow-500'
                      : 'border-transparent text-gray-400 hover:text-yellow-400'
                  }`}
                >
                  <svg className="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM9 10a6 6 0 1 1-12 0 6 6 0 0 1 12 0z" />
                  </svg>
                  Drivers
                </button>
                <button
                  onClick={() => setCurrentTab('bookings')}
                  className={`py-4 px-2 border-b-2 font-medium transition-colors whitespace-nowrap ${
                    currentTab === 'bookings'
                      ? 'border-yellow-500 text-yellow-500'
                      : 'border-transparent text-gray-400 hover:text-yellow-400'
                  }`}
                >
                  <svg className="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                  </svg>
                  Bookings
                </button>
                <button
                  onClick={() => setCurrentTab('passengers')}
                  className={`py-4 px-2 border-b-2 font-medium transition-colors whitespace-nowrap ${
                    currentTab === 'passengers'
                      ? 'border-yellow-500 text-yellow-500'
                      : 'border-transparent text-gray-400 hover:text-yellow-400'
                  }`}
                >
                  <svg className="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                  Passengers
                </button>
                <button
                  onClick={() => setCurrentTab('logs')}
                  className={`py-4 px-2 border-b-2 font-medium transition-colors whitespace-nowrap ${
                    currentTab === 'logs'
                      ? 'border-yellow-500 text-yellow-500'
                      : 'border-transparent text-gray-400 hover:text-yellow-400'
                  }`}
                >
                  <svg className="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  Logs
                </button>
              </div>
            </div>
          </div>

          {/* Content */}
          <div className="max-w-7xl mx-auto px-6 py-8">
            {currentTab === 'overview' && (
              <div className="space-y-6">
                {/* Dashboard Stats Cards */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                  <div className="bg-[#1e2538] p-6 rounded-xl shadow flex justify-between items-center">
                    <div>
                      <p className="text-gray-400">TODAY'S RIDES</p>
                      <h3 className="text-3xl font-bold">{(() => {
                        try {
                          const today = new Date().toISOString().slice(0,10);
                          return bookings.filter(b => (b.raw && b.raw.RequestedAt && b.raw.RequestedAt.slice(0,10) === today)).length || 0;
                        } catch(e) { return 0; }
                      })()}</h3>
                      <p className="text-green-400">Live count from DB</p>
                    </div>
                    <img src="today's rides.png" className="w-16 h-16" alt="Rides" />
                  </div>

                  <div className="bg-[#1e2538] p-6 rounded-xl shadow flex justify-between items-center">
                    <div>
                      <p className="text-gray-400">ACTIVE DRIVERS</p>
                      <h3 className="text-3xl font-bold">{drivers.filter(d => d.status === 'Active').length}</h3>
                      <p className="text-green-400">Online drivers (live)</p>
                    </div>
                    <img src="tricy.png" className="w-16 h-16" alt="Drivers" />
                  </div>

                  <div className="bg-[#1e2538] p-6 rounded-xl shadow flex justify-between items-center">
                    <div>
                      <p className="text-gray-400">TOTAL BOOKINGS</p>
                      <h3 className="text-3xl font-bold">{bookings.length}</h3>
                      <p className="text-green-400">Total bookings (live)</p>
                    </div>
                    <img src="booking.png" className="w-16 h-16" alt="Bookings" />
                  </div>
                </div>

                {/* Stats Breakdown */}
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                  <div className="bg-gradient-to-br from-[#1e2538] to-[#0a0e1a] rounded-lg p-4 border border-green-900">
                    <p className="text-gray-400 text-sm mb-1">ACTIVE DRIVERS</p>
                    <h3 className="text-2xl font-bold text-green-400">{drivers.filter(d => d.isActiveUser && d.status === 'Active').length}</h3>
                    <p className="text-gray-500 text-xs mt-1">Ready to accept rides</p>
                  </div>
                  <div className="bg-gradient-to-br from-[#1e2538] to-[#0a0e1a] rounded-lg p-4 border border-blue-900">
                    <p className="text-gray-400 text-sm mb-1">PASSENGERS</p>
                    <h3 className="text-2xl font-bold text-blue-400">{passengers.length}</h3>
                    <p className="text-gray-500 text-xs mt-1">Registered users</p>
                  </div>
                  <div className="bg-gradient-to-br from-[#1e2538] to-[#0a0e1a] rounded-lg p-4 border border-yellow-900">
                    <p className="text-gray-400 text-sm mb-1">FLAGGED LOGS</p>
                    <h3 className="text-2xl font-bold text-yellow-400">{auditLogs.filter(l => l.status === 'Flagged').length}</h3>
                    <p className="text-gray-500 text-xs mt-1">Need review</p>
                  </div>
                  <div className="bg-gradient-to-br from-[#1e2538] to-[#0a0e1a] rounded-lg p-4 border border-red-900">
                    <p className="text-gray-400 text-sm mb-1">COMPLETION RATE</p>
                    <h3 className="text-2xl font-bold text-red-400">{bookings.length > 0 ? Math.round((bookings.filter(b => b.status === 'Completed').length / bookings.length) * 100) : 0}%</h3>
                    <p className="text-gray-500 text-xs mt-1">Of all bookings</p>
                  </div>
                </div>
              </div>
            )}

            {currentTab === 'drivers' && (
              <div className="space-y-6">
                {/* Dashboard Stats Cards */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                  <div className="bg-[#1e2538] p-6 rounded-xl shadow flex justify-between items-center">
                    <div>
                      <p className="text-gray-400">TODAY'S RIDES</p>
                      <h3 className="text-3xl font-bold">{(() => {
                        try {
                          const today = new Date().toISOString().slice(0,10);
                          return bookings.filter(b => (b.raw && b.raw.RequestedAt && b.raw.RequestedAt.slice(0,10) === today)).length || 0;
                        } catch(e) { return 0; }
                      })()}</h3>
                      <p className="text-green-400">Live count from DB</p>
                    </div>
                    <img src="today's rides.png" className="w-16 h-16" alt="Rides" />
                  </div>

                  <div className="bg-[#1e2538] p-6 rounded-xl shadow flex justify-between items-center">
                    <div>
                      <p className="text-gray-400">ACTIVE DRIVERS</p>
                      <h3 className="text-3xl font-bold">{drivers.filter(d => d.status === 'Active').length}</h3>
                      <p className="text-green-400">Online drivers (live)</p>
                    </div>
                    <img src="tricy.png" className="w-16 h-16" alt="Drivers" />
                  </div>

                  <div className="bg-[#1e2538] p-6 rounded-xl shadow flex justify-between items-center">
                    <div>
                      <p className="text-gray-400">TOTAL BOOKINGS</p>
                      <h3 className="text-3xl font-bold">{bookings.length}</h3>
                      <p className="text-green-400">Total bookings (live)</p>
                    </div>
                    <img src="booking.png" className="w-16 h-16" alt="Bookings" />
                  </div>
                </div>

                {/* Driver Management Section */}
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                  <h2 className="text-2xl font-bold text-white">Driver Management ({drivers.length} drivers)</h2>
                  <div className="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                    <button 
                      onClick={() => setShowAddModal(true)}
                      className="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-white font-semibold flex items-center justify-center gap-2"
                    >
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                      </svg>
                      ADD NEW DRIVER
                    </button>
                    <button 
                      onClick={() => setShowExportModal(true)}
                      className="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-lg text-gray-900 font-semibold flex items-center justify-center gap-2"
                    >
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                      EXPORT DATA
                    </button>
                    <button 
                      onClick={() => setShowImportModal(true)}
                      className="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-lg text-gray-900 font-semibold flex items-center justify-center gap-2"
                    >
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                      </svg>
                      ADD APPROVED DRIVERS
                    </button>
                  </div>
                </div>

                {/* Driver Status Summary */}
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                  <div className="bg-gradient-to-br from-[#1e2538] to-[#0a0e1a] rounded-lg p-4 border border-green-900">
                    <p className="text-gray-400 text-sm mb-1">ACTIVE DRIVERS</p>
                    <h3 className="text-2xl font-bold text-green-400">{drivers.filter(d => d.isActiveUser && d.status === 'Active').length}</h3>
                    <p className="text-gray-500 text-xs mt-1">Ready to accept rides</p>
                  </div>
                  <div className="bg-gradient-to-br from-[#1e2538] to-[#0a0e1a] rounded-lg p-4 border border-blue-900">
                    <p className="text-gray-400 text-sm mb-1">VERIFIED DRIVERS</p>
                    <h3 className="text-2xl font-bold text-blue-400">{drivers.filter(d => d.license && d.license.length > 0).length}</h3>
                    <p className="text-gray-500 text-xs mt-1">License verified</p>
                  </div>
                  <div className="bg-gradient-to-br from-[#1e2538] to-[#0a0e1a] rounded-lg p-4 border border-yellow-900">
                    <p className="text-gray-400 text-sm mb-1">INACTIVE DRIVERS</p>
                    <h3 className="text-2xl font-bold text-yellow-400">{drivers.filter(d => !d.isActiveUser || d.status === 'Inactive').length}</h3>
                    <p className="text-gray-500 text-xs mt-1">Suspended or off-duty</p>
                  </div>
                  <div className="bg-gradient-to-br from-[#1e2538] to-[#0a0e1a] rounded-lg p-4 border border-red-900">
                    <p className="text-gray-400 text-sm mb-1">COMPLETION RATE</p>
                    <h3 className="text-2xl font-bold text-red-400">{drivers.length > 0 ? (bookings.filter(b => b.status === 'Completed').length > 0 ? Math.round((bookings.filter(b => b.status === 'Completed').length / Math.max(bookings.length, 1)) * 100) : 0) : 0}%</h3>
                    <p className="text-gray-500 text-xs mt-1">Of all bookings</p>
                  </div>
                </div>

                <div className="bg-[#1e2538] rounded-lg overflow-hidden p-6">
                  <div className="space-y-4">
                    {drivers.map((driver, index) => (
                      <div key={index} className="bg-[#252d42] rounded-lg p-6 flex flex-col sm:flex-row items-start sm:items-center gap-4 hover:shadow-lg transition-shadow">
                        <div className="flex items-center gap-4 flex-shrink-0">
                          <div className={`w-14 h-14 rounded-full flex items-center justify-center font-bold text-white text-base ${driver.status === 'Active' ? 'bg-green-500' : 'bg-gray-500'}`}>{(driver.name||'').split(' ').map(s=>s[0]).slice(0,2).join('')}</div>
                        </div>

                        <div className="flex-1 min-w-0 pr-4">
                          <div className="text-white font-semibold text-base md:text-lg">{driver.name}</div>
                          <div className="text-gray-200 text-sm md:text-base mt-2 space-y-1">
                            <div className="leading-tight">Plate: <span className="font-semibold text-gray-100">{driver.tricycle || '—'}</span></div>
                            <div className="leading-tight">License: <span className="font-semibold text-gray-100">{driver.license || '—'}</span></div>
                            <div className="leading-tight">Phone: <span className="font-semibold text-gray-100">{stripPhonePrefix(driver.contact) || '—'}</span></div>
                          </div>
                        </div>

                        <div className="flex-shrink-0 w-full sm:w-auto flex flex-col sm:items-end sm:flex-row sm:gap-4 gap-3 items-start">
                          <div className="flex gap-2 items-center">
                            <span className={`inline-flex items-center justify-center h-9 min-w-[88px] px-4 rounded-lg text-sm font-semibold ${driver.isActiveUser ? 'bg-blue-500 text-white' : 'bg-gray-500 text-white'}`}>
                              {driver.isActiveUser ? 'Active' : 'Inactive'}
                            </span>
                            <span className={`inline-flex items-center justify-center h-9 min-w-[88px] px-4 rounded-lg text-sm font-semibold ${driver.status === 'Active' ? 'bg-green-500 text-white' : 'bg-gray-500 text-white'}`}>
                              {driver.status === 'Active' ? 'Online' : 'Offline'}
                            </span>
                          </div>

                          <div className="flex gap-3 mt-3 sm:mt-0">
                            <button 
                              onClick={() => handleEditDriver(index)}
                              className="bg-yellow-500 hover:bg-yellow-600 h-9 min-w-[88px] px-4 rounded-lg font-semibold text-gray-900 flex items-center justify-center"
                            >
                              Edit
                            </button>
                            <button 
                              onClick={() => handleDeleteDriver(index)}
                              className="bg-red-600 hover:bg-red-700 h-9 min-w-[88px] px-4 rounded-lg font-semibold text-white flex items-center justify-center"
                            >
                              Delete
                            </button>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {currentTab === 'bookings' && (
              <div className="space-y-6">
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                  <h2 className="text-2xl font-bold text-white">Booking Management ({filteredBookings.length} bookings)</h2>
                  <button
                    className="bg-yellow-500 hover:bg-yellow-600 px-6 py-3 rounded-lg font-semibold text-gray-900 flex items-center gap-2"
                    onClick={() => setShowBookingFilterModal(true)}
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                    </svg>
                    FILTER
                  </button>
                </div>

                <div className="bg-[#1e2538] p-6 rounded-lg space-y-4">
                  {filteredBookings.length > 0 ? (
                    filteredBookings.map(booking => (
                      <div key={booking.id} className="bg-[#252d42] p-6 rounded-lg hover:bg-[#2d3548] transition-colors">
                        <div className="flex justify-between items-start">
                          <div className="flex-1">
                            <h4 className="font-bold text-white text-lg mb-2">Booking #{booking.id}</h4>
                            <p className="text-sm text-gray-400 mb-1"><span className="font-medium text-gray-300">Passenger:</span> {booking.passengerName}</p>
                            <p className="text-sm text-gray-400 mb-1"><span className="font-medium text-gray-300">Route:</span> {booking.pickup} → {booking.destination}</p>
                            <p className="text-sm text-gray-400 mb-1"><span className="font-medium text-gray-300">Driver:</span> {booking.driverName} • <span className="font-medium text-gray-300">Distance:</span> {booking.distance}</p>
                            <p className="text-sm text-gray-400"><span className="font-medium text-gray-300">Date:</span> {booking.requestedAt.slice(0, 10)}</p>
                          </div>
                          <div className="flex flex-col items-end gap-2">
                            <span className={`px-4 py-2 rounded-lg text-sm font-bold ${
                              booking.status === "Completed" ? "bg-green-600 text-white" :
                              booking.status === "Pending" ? "bg-yellow-500 text-gray-900" :
                              "bg-red-600 text-white"
                            }`}>
                              {booking.status}
                            </span>
                            <span className="text-xl font-bold text-yellow-500">₱{booking.fare}</span>
                          </div>
                        </div>
                      </div>
                    ))
                  ) : (
                    <div className="text-center text-gray-400 py-8">No bookings found</div>
                  )}
                </div>
              </div>
            )}

            {currentTab === 'passengers' && (
              <div className="space-y-6">
                <h2 className="text-2xl font-bold text-white">Passenger Management ({passengers.length} passengers)</h2>
                <div className="bg-[#1e2538] p-6 rounded-lg">
                  <div className="space-y-4">
                    {passengers.length > 0 ? (
                      passengers.map((passenger, idx) => (
                        <div key={idx} className="bg-[#252d42] p-6 rounded-lg hover:shadow-lg transition-shadow flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                          <div className="flex-1">
                            <h4 className="font-bold text-white text-lg">{passenger.name}</h4>
                            <p className="text-sm text-gray-400 mt-2"><span className="font-medium">Email:</span> {passenger.email || 'N/A'}</p>
                            <p className="text-sm text-gray-400"><span className="font-medium">Phone:</span> {stripPhonePrefix(passenger.phone) || 'N/A'}</p>
                            <p className="text-sm text-gray-400"><span className="font-medium">Joined:</span> {passenger.joinedDate.slice(0, 10)}</p>
                          </div>
                          <div className="bg-gradient-to-br from-[#1e2538] to-[#0a0e1a] rounded-lg p-4 border border-blue-900 sm:text-right">
                            <p className="text-gray-400 text-sm">Total Rides</p>
                            <h3 className="text-2xl font-bold text-blue-400">{passenger.totalRides}</h3>
                          </div>
                        </div>
                      ))
                    ) : (
                      <div className="text-center text-gray-400 py-8">No passengers found</div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {currentTab === 'logs' && (
              <div className="space-y-6">
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                  <h2 className="text-2xl font-bold text-white">Audit Logs ({filteredLogs.length} logs)</h2>
                  <input
                    type="text"
                    placeholder="Search logs..."
                    value={logsSearchTerm}
                    onChange={(e) => setLogsSearchTerm(e.target.value)}
                    className="px-4 py-2 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none w-full sm:w-auto"
                  />
                </div>

                <div className="bg-[#1e2538] p-6 rounded-lg">
                  <div className="space-y-3">
                    {filteredLogs.length > 0 ? (
                      filteredLogs.map(log => (
                        <div key={log.id} className="bg-[#252d42] p-4 rounded-lg hover:bg-[#2d3548] transition-colors">
                          <div className="flex justify-between items-start">
                            <div className="flex-1">
                              <p className="text-sm text-gray-400"><span className="font-medium text-gray-300">Booking ID:</span> {log.bookingId}</p>
                              <p className="text-sm text-gray-400"><span className="font-medium text-gray-300">Driver:</span> {log.driver}</p>
                              <p className="text-sm text-gray-400"><span className="font-medium text-gray-300">Event:</span> {log.event}</p>
                              <p className="text-sm text-gray-400"><span className="font-medium text-gray-300">Location:</span> {log.location}</p>
                              <p className="text-sm text-gray-400"><span className="font-medium text-gray-300">Date:</span> {log.timestamp}</p>
                            </div>
                            <span className={`px-3 py-1 rounded text-sm font-bold whitespace-nowrap ${
                              log.status === 'Flagged' ? 'bg-red-600 text-white' : 'bg-green-600 text-white'
                            }`}>
                              {log.status}
                            </span>
                          </div>
                        </div>
                      ))
                    ) : (
                      <div className="text-center text-gray-400 py-8">No logs found</div>
                    )}
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Modals */}
          {showAddModal && (
            <AddDriverModal onClose={() => setShowAddModal(false)} onSave={handleAddNewDriver} />
          )}
          {showImportModal && <ImportApprovedModal onClose={() => setShowImportModal(false)} approvedApplications={approvedApplications} drivers={drivers} />}
          {selectedDriver && (
            <EditDriverModal 
              driver={selectedDriver} 
              driverIndex={selectedDriverIndex}
              onClose={() => {
                setSelectedDriver(null);
                setSelectedDriverIndex(null);
              }} 
              onSave={handleSaveDriver}
            />
          )}
          {showExportModal && <ExportDataModal drivers={drivers} onClose={() => setShowExportModal(false)} />}
          
          {/* Booking Filter Modal */}
          {showBookingFilterModal && (
            <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50">
              <div className="bg-[#1e2538] p-8 rounded-xl w-full max-w-md">
                <h2 className="text-2xl font-bold mb-6 text-white">Filter Bookings</h2>
                <div className="space-y-4">
                  <div>
                    <label className="block text-gray-300 mb-2 font-medium">Date From</label>
                    <input 
                      type="date" 
                      value={dateFromBooking}
                      onChange={(e) => setDateFromBooking(e.target.value)}
                      className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none"
                    />
                  </div>
                  <div>
                    <label className="block text-gray-300 mb-2 font-medium">Date To</label>
                    <input 
                      type="date" 
                      value={dateToBooking}
                      onChange={(e) => setDateToBooking(e.target.value)}
                      className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none"
                    />
                  </div>
                  <div>
                    <label className="block text-gray-300 mb-2 font-medium">Status</label>
                    <div className="space-y-2">
                      {['Completed', 'Pending', 'Cancelled'].map(status => (
                        <label key={status} className="flex items-center gap-2 text-gray-300 cursor-pointer">
                          <input 
                            type="checkbox"
                            checked={statusFiltersBooking[status]}
                            onChange={() => setStatusFiltersBooking(prev => ({ ...prev, [status]: !prev[status] }))}
                            className="w-4 h-4"
                          />
                          {status}
                        </label>
                      ))}
                    </div>
                  </div>
                </div>
                <div className="flex justify-between gap-3 mt-6">
                  <button onClick={() => setShowBookingFilterModal(false)} className="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-semibold text-white">Cancel</button>
                  <button onClick={applyBookingFilters} className="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg font-semibold text-white">Apply</button>
                </div>
              </div>
            </div>
          )}
          
          {confirmDelete.open && (
            <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50">
              <div className="bg-[#1e2538] p-8 rounded-xl w-full max-w-md">
                <h2 className="text-2xl font-bold mb-4 text-white">Confirm Delete</h2>
                <p className="text-gray-300 mb-6">Are you sure you want to delete <span className="font-semibold text-white">{drivers[confirmDelete.index] ? drivers[confirmDelete.index].name : ''}</span>?</p>
                <div className="flex justify-end gap-3">
                  <button onClick={() => setConfirmDelete({ open: false, index: null })} className="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-semibold text-white">Cancel</button>
                  <button onClick={() => performDeleteDriver(confirmDelete.index)} className="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-semibold text-white">Delete</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<AdminDashboard />);
  </script>
</body>
</html>
