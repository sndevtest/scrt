<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pasakay - Booking Management</title>
  <link rel="icon" href="tricy.png" type="image/png">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      onValue,
      get
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBS-g5bFBaJ6a35hWmjvoN-s8FuMEuxtew",
      authDomain: "pasakay-project-ph.firebaseapp.com",
      databaseURL: "https://pasakay-project-ph-default-rtdb.firebaseio.com",
      projectId: "pasakay-project-ph",
      storageBucket: "pasakay-project-ph.firebasestorage.app",
      messagingSenderId: "189297787561",
      appId: "1:189297787561:web:ddad5de3fdf638c6d8dfb8",
      measurementId: "G-2VWQ0C8EZE"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Expose DB helpers to the non-module React script
    window.db = db;
    window.dbRef = ref;
    window.dbOnValue = onValue;
    window.dbGet = get;
  </script>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: "Inter", sans-serif;
      background: #0a0e1a;
      margin: 0;
    }
    
    /* Customized Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: #1a2333;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #fbbf24 0%, #f59e0b 100%);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #fcd34d 0%, #fbbf24 100%);
    }
    
    /* Firefox Scrollbar */
    * {
      scrollbar-color: #2e3c57 #1a2333;
      scrollbar-width: thin;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const BookingManagement = () => {
      const [showFilterModal, setShowFilterModal] = React.useState(false);

      // Raw objects from DB
      const [rawUsers, setRawUsers] = React.useState({});
      const [rawDrivers, setRawDrivers] = React.useState({});
      const [rawPassengers, setRawPassengers] = React.useState({});
      const [rawBookings, setRawBookings] = React.useState({});

      // Hash function to convert Firebase keys to integers
      const hashKeyToInt = (key) => {
        let hash = 0;
        for (let i = 0; i < key.length; i++) {
          const char = key.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash; // Convert to 32-bit integer
        }
        return Math.abs(hash); // Return positive integer
      };

      // Derived arrays for UI
      const [allBookings, setAllBookings] = React.useState([]);
      const [filteredBookings, setFilteredBookings] = React.useState([]);

      // Filter states
      const [dateFrom, setDateFrom] = React.useState("");
      const [dateTo, setDateTo] = React.useState("");
      const [selectedDriver, setSelectedDriver] = React.useState("All Drivers");
      const [statusFilters, setStatusFilters] = React.useState({
        Completed: true,
        Pending: true,
        Cancelled: true
      });

      // Set up realtime listeners to DB nodes
      React.useEffect(() => {
        if (!window.db || !window.dbRef || !window.dbOnValue) return;

        const usersRef = window.dbRef(window.db, 'users');
        const driversRef = window.dbRef(window.db, 'drivers');
        const passengersRef = window.dbRef(window.db, 'passengers');
        const bookingsRef = window.dbRef(window.db, 'bookings');

        const unsubUsers = window.dbOnValue(usersRef, snap => setRawUsers(snap.val() || {}));
        const unsubDrivers = window.dbOnValue(driversRef, snap => setRawDrivers(snap.val() || {}));
        const unsubPassengers = window.dbOnValue(passengersRef, snap => setRawPassengers(snap.val() || {}));
        const unsubBookings = window.dbOnValue(bookingsRef, snap => setRawBookings(snap.val() || {}));

        return () => {
          try { unsubUsers(); } catch(e) {}
          try { unsubDrivers(); } catch(e) {}
          try { unsubPassengers(); } catch(e) {}
          try { unsubBookings(); } catch(e) {}
        };
      }, []);

      // Derive bookings array from DB objects
      React.useEffect(() => {
        const makeFullName = (u) => {
          if (!u) return 'Unknown';
          return [u.Firstname, u.Middlename, u.Lastname].filter(Boolean).join(' ');
        };

        const bookingsArr = Object.entries(rawBookings || {}).map(([key, b]) => {
          const passengerRec = rawPassengers && rawPassengers[b.PassengerID];
          const passengerUser = passengerRec ? rawUsers[passengerRec.UserID] : null;
          const driverRec = rawDrivers && rawDrivers[b.DriverID];
          const driverUser = driverRec ? rawUsers[driverRec.UserID] : null;
          const requested = b.RequestedAt || '';
          const date = requested ? new Date(requested).toISOString().slice(0, 10) : '';
          const time = requested ? new Date(requested).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';

          // Prefer a driverSnapshot stored on the booking (backfilled or captured at assignment time)
          const dSnap = b.driverSnapshot || null;
          let driverName = 'Driver';
          let driverTricycle = '';
          let driverLicense = '';
          if (dSnap && dSnap.name) {
            driverName = dSnap.name;
            driverTricycle = dSnap.tricycle || '';
            driverLicense = dSnap.license || '';
          } else if (driverUser) {
            driverName = makeFullName(driverUser);
            driverTricycle = driverRec ? (driverRec.TricycleNumber || '') : '';
            driverLicense = driverRec ? (driverRec.LicenseNumber || '') : '';
          }

          return {
            id: parseInt(key) || hashKeyToInt(key),
            passenger: b.userName || 'Passenger',
            pickup: b.PickupLocation || '',
            destination: b.DropoffLocation || '',
            fare: b.TotalFare || 0,
            status: (b.Status || 'Unknown').charAt(0).toUpperCase() + (b.Status || 'Unknown').slice(1).toLowerCase(),
            driver: driverName,
            driverTricycle,
            driverLicense,
            distance: b.distanceKm ? `${b.distanceKm}km` : '',
            date,
            time
          };
        });

        setAllBookings(bookingsArr);
        setFilteredBookings(bookingsArr);
      }, [rawUsers, rawDrivers, rawPassengers, rawBookings]);

      const applyFilters = () => {
        let filtered = [...allBookings];

        // Filter by date range
        if (dateFrom) {
          filtered = filtered.filter(b => b.date >= dateFrom);
        }
        if (dateTo) {
          filtered = filtered.filter(b => b.date <= dateTo);
        }

        // Filter by driver
        if (selectedDriver !== "All Drivers") {
          filtered = filtered.filter(b => b.driver === selectedDriver);
        }

        // Filter by status
        filtered = filtered.filter(b => statusFilters[b.status]);

        setFilteredBookings(filtered);
        setShowFilterModal(false);
      };

      const resetFilters = () => {
        setDateFrom("");
        setDateTo("");
        setSelectedDriver("All Drivers");
        setStatusFilters({ Completed: true, Pending: true, Cancelled: true });
        setFilteredBookings(allBookings);
      };

      const toggleStatus = (status) => {
        setStatusFilters(prev => ({ ...prev, [status]: !prev[status] }));
      };

      // Get current page for active link highlight
      const rawSegment = window.location.pathname.split("/").pop() || window.location.href.split("/").pop() || '';
      const normalize = (s) => decodeURIComponent((s || '').toString()).toLowerCase().trim();
      const currentPage = normalize(rawSegment);

      const getLinkClass = (page) => {
        const isActive = currentPage === normalize(page);
        return "flex items-center gap-3 px-4 py-3 rounded-lg transition-colors " +
          (isActive ? "bg-yellow-500 text-gray-900 font-semibold" : "text-gray-300 hover:bg-gray-700");
      };

      const getStatusColor = (status) => {
        if (status === "Completed") return "text-green-400";
        if (status === "Pending") return "text-yellow-300";
        if (status === "Cancelled") return "text-red-400";
        return "text-gray-400";
      };

      // Get unique driver names for dropdown
      // Get active driver names from drivers -> users mapping (skip drivers whose users were deleted)
      const driverNames = React.useMemo(() => {
        const names = new Set();
        Object.entries(rawDrivers || {}).forEach(([id, d]) => {
          if (!d || d.IsActive === false || d.DeletedAt) return;
          const u = rawUsers && rawUsers[d.UserID];
          if (!u || u.IsActive === false || u.DeletedAt) return;
          const name = [u.Firstname, u.Middlename, u.Lastname].filter(Boolean).join(' ');
          if (name) names.add(name);
        });
        return Array.from(names).sort();
      }, [rawDrivers, rawUsers]);

      return (
        <div className="flex min-h-screen bg-[#0a0e1a]">
          {/* Sidebar */}
          <aside className="w-72 bg-[#0e1420] text-white p-6 flex flex-col border-r border-gray-900">
            <div className="flex items-center gap-3 mb-10">
              <div className="w-14 h-14 rounded-2xl flex items-center justify-center overflow-hidden">
                <img src="tricy.png" alt="Pasakay" className="w-full h-full object-cover bg-yellow-500 p-1" />
              </div>
              <div>
                <h1 className="text-2xl font-bold text-yellow-500">PASAKAY</h1>
                <p className="text-sm text-gray-400">Admin Dashboard</p>
              </div>
            </div>

            <nav className="flex flex-col gap-2">
              <a href="dashboard.html" className={getLinkClass("dashboard.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                Dashboard
              </a>
              <a href="driver management.html" className={getLinkClass("driver management.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                Drivers
              </a>
              <a href="passenger management.html" className={getLinkClass("passenger management.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                Passengers
              </a>
              {/* Membership link removed - moved to TODA Officer dashboard */}
              <a href="booking management.html" className={getLinkClass("booking management.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                Bookings
              </a>
              <a href="Logs.html" className={getLinkClass("Logs.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Logs
              </a>
              <a href="Fare Matrix.html" className={getLinkClass("Fare Matrix.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Fare Matrix
              </a>
              <a href="log out.html" className={getLinkClass("log out.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                Log out
              </a>
            </nav>
          </aside>

          {/* Main content */}
          <main className="flex-1 bg-[#1a202e] p-8">
            {/* Header */}
            <header className="flex justify-between items-center mb-8">
              <h2 className="text-3xl font-bold text-white">Booking Management</h2>
              <div className="flex items-center gap-3 bg-yellow-500 px-4 py-2 rounded-lg">
                <div className="w-10 h-10 bg-gray-900 text-yellow-500 rounded-full flex items-center justify-center font-bold text-lg">
                  A
                </div>
                <span className="font-semibold text-gray-900">Admin</span>
              </div>
            </header>

            {/* Booking list box */}
            <div className="bg-[#1e2538] p-8 rounded-xl">
              <div className="flex justify-between items-center mb-6">
                <h3 className="text-2xl font-bold text-white">Booking List ({filteredBookings.length} Bookings)</h3>
                <button
                  className="bg-yellow-500 hover:bg-yellow-600 px-6 py-3 rounded-lg font-semibold text-gray-900 transition-colors"
                  onClick={() => setShowFilterModal(true)}
                >
                  FILTER BOOKINGS
                </button>
              </div>

              <div className="space-y-4">
                {filteredBookings.length > 0 ? (
                  filteredBookings.map(booking => (
                    <div key={booking.id} className="bg-[#252d42] p-6 rounded-lg hover:bg-[#2d3548] transition-colors">
                      <div className="flex justify-between items-start">
                        <div>
                          <h4 className="font-bold text-white text-lg mb-2">Booking #{booking.id}</h4>
                          <p className="text-sm text-gray-400 mb-1">
                            <span className="font-medium text-gray-300">Passenger:</span> {booking.passenger}
                          </p>
                          <p className="text-sm text-gray-400 mb-1">
                            <span className="font-medium text-gray-300">Route:</span> {booking.pickup} → {booking.destination}
                          </p>
                          <p className="text-sm text-gray-400 mb-1">
                            <span className="font-medium text-gray-300">Driver:</span> {booking.driver} • <span className="font-medium text-gray-300">Distance:</span> {booking.distance}
                          </p>
                          <p className="text-sm text-gray-400">
                            <span className="font-medium text-gray-300">Date & Time:</span> {new Date(booking.date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })} {booking.time}
                          </p>
                        </div>
                        <div className="flex flex-col items-end gap-2">
                          <span className={`px-4 py-2 rounded-lg text-sm font-bold ${
                            booking.status === "Completed" ? "bg-green-600 text-white" :
                            booking.status === "Pending" ? "bg-yellow-500 text-gray-900" :
                            "bg-red-600 text-white"
                          }`}>
                            {booking.status}
                          </span>
                          <span className="text-xl font-bold text-yellow-500">₱{booking.fare}</span>
                        </div>
                      </div>
                    </div>
                  ))
                ) : (
                  <div className="text-center text-gray-400 py-8 bg-[#252d42] rounded-lg">
                    No bookings found matching your filters
                  </div>
                )}
              </div>
            </div>

            {/* Modal */}
            {showFilterModal && (
              <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50">
                <div className="bg-[#1e2538] p-8 rounded-xl w-[500px] relative">
                  <button
                    className="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl font-light"
                    onClick={() => setShowFilterModal(false)}
                  >
                    &times;
                  </button>
                  <h2 className="text-2xl font-bold mb-6 text-white">Filter Bookings</h2>

                  <div className="flex flex-col gap-6">
                    {/* Date Range */}
                    <div>
                      <label className="mb-2 block font-semibold text-gray-300">Date Range</label>
                      <div className="flex gap-3 items-center">
                        <input 
                          type="date" 
                          value={dateFrom}
                          onChange={(e) => setDateFrom(e.target.value)}
                          className="px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none flex-1" 
                        />
                        <span className="text-gray-400">to</span>
                        <input 
                          type="date" 
                          value={dateTo}
                          onChange={(e) => setDateTo(e.target.value)}
                          className="px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none flex-1" 
                        />
                      </div>
                    </div>

                    {/* Driver */}
                    <div>
                      <label className="mb-2 block font-semibold text-gray-300">Driver</label>
                      <select 
                        value={selectedDriver}
                        onChange={(e) => setSelectedDriver(e.target.value)}
                        className="px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none w-full"
                      >
                        <option>All Drivers</option>
                        {driverNames.map((driver, idx) => (
                          <option key={idx}>{driver}</option>
                        ))}
                      </select>
                    </div>

                    {/* Booking Status */}
                    <div>
                      <label className="mb-2 block font-semibold text-gray-300">Booking Status</label>
                      <div className="flex flex-col gap-3">
                        <label className="flex items-center gap-3 cursor-pointer text-gray-300 hover:text-white">
                          <input 
                            type="checkbox" 
                            checked={statusFilters.Completed}
                            onChange={() => toggleStatus("Completed")}
                            className="w-5 h-5"
                          /> 
                          <span className="text-green-400 font-medium">Completed</span>
                        </label>
                        <label className="flex items-center gap-3 cursor-pointer text-gray-300 hover:text-white">
                          <input 
                            type="checkbox" 
                            checked={statusFilters.Pending}
                            onChange={() => toggleStatus("Pending")}
                            className="w-5 h-5"
                          /> 
                          <span className="text-yellow-300 font-medium">Pending</span>
                        </label>
                        <label className="flex items-center gap-3 cursor-pointer text-gray-300 hover:text-white">
                          <input 
                            type="checkbox" 
                            checked={statusFilters.Cancelled}
                            onChange={() => toggleStatus("Cancelled")}
                            className="w-5 h-5"
                          /> 
                          <span className="text-red-400 font-medium">Cancelled</span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <div className="flex justify-between gap-3 mt-8">
                    <button 
                      className="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold text-white transition-colors"
                      onClick={resetFilters}
                    >
                      Reset
                    </button>
                    <div className="flex gap-3">
                      <button 
                        className="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg font-semibold text-white transition-colors" 
                        onClick={() => setShowFilterModal(false)}
                      >
                        Cancel
                      </button>
                      <button 
                        className="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold text-white transition-colors"
                        onClick={applyFilters}
                      >
                        Apply Filters
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </main>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<BookingManagement />);
  </script>
</body>
</html>