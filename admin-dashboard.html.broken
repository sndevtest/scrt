<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pasakay - Admin Dashboard</title>
  <link rel="icon" href="tricy.png" type="image/png">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, signOut, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      onValue,
      get,
      set,
      update,
      push,
      remove,
      runTransaction,
      query,
      orderByChild,
      equalTo
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getBytes, list, listAll, getMetadata } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBS-g5bFBaJ6a35hWmjvoN-s8FuMEuxtew",
      authDomain: "pasakay-project-ph.firebaseapp.com",
      databaseURL: "https://pasakay-project-ph-default-rtdb.firebaseio.com",
      projectId: "pasakay-project-ph",
      storageBucket: "pasakay-project-ph.firebasestorage.app",
      messagingSenderId: "189297787561",
      appId: "1:189297787561:web:ddad5de3fdf638c6d8dfb8",
      measurementId: "G-2VWQ0C8EZE"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // Sign in anonymously for Storage/Database operations
    signInAnonymously(auth).catch(err => {
      console.error('Anonymous sign-in failed:', err);
    });

    // Monitor auth state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log('✅ Authenticated as:', user.uid);
        window.currentUser = user;
      } else {
        console.warn('⚠️ Not authenticated');
      }
    });

    // Expose API key for metadata REST fallback
    window.firebaseApiKey = firebaseConfig.apiKey;

    // Expose DB helpers
    window.db = db;
    window.dbRef = ref;
    window.dbOnValue = onValue;
    window.dbGet = get;
    window.dbSet = set;
    window.dbUpdate = update;
    window.dbPush = push;
    window.dbRemove = remove;
    window.dbRunTransaction = runTransaction;
    window.dbQuery = query;
    window.dbOrderByChild = orderByChild;
    window.dbEqualTo = equalTo;

    // Expose Storage helpers
    window.storage = storage;
    window.storageRef = storageRef;
    window.uploadBytes = uploadBytes;
    window.getBytes = getBytes;
    window.storageList = list;
    window.storageListAll = listAll;
    window.getMetadata = getMetadata;

    // Expose Auth
    window.firebaseAuth = auth;
    window.firebaseSignOut = signOut;

    // Role check: verify user is Admin (RoleID = 4)
    const checkAccess = async () => {
      const userRole = sessionStorage.getItem('userRole');
      const userUID = sessionStorage.getItem('userUID');
      
      if (userRole !== '4' || !userUID) {
        console.error('❌ Access denied: Not an Admin');
        window.location.href = 'log in.html';
        return;
      }
      console.log('✅ Admin access granted');
      window.adminAllowed = true;
    };

    checkAccess();
  </script>

  <script src="ui-modals.js"></script>

  <!-- React + Babel + Tailwind -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: "Inter", sans-serif;
      background: #0a0e1a;
    }
    
    /* Customized Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: #1a2333;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #fbbf24 0%, #f59e0b 100%);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #fcd34d 0%, #fbbf24 100%);
    }
    
    /* Firefox Scrollbar */
    * {
      scrollbar-color: #2e3c57 #1a2333;
      scrollbar-width: thin;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Helper: hash Firebase keys to integers
    const hashKeyToInt = (key) => {
      let hash = 0;
      for (let i = 0; i < key.length; i++) {
        const char = key.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return Math.abs(hash);
    };

    // Helper: format license to pattern A00-00-000000 
    const formatLicense = (value) => {
      if (!value) return '';
      const up = value.toString().toUpperCase();
      const raw = up.replace(/[^A-Z0-9]/g, '');
      const p1 = raw.slice(0, 3);
      const p2 = raw.slice(3, 5);
      const p3 = raw.slice(5, 11);
      let formatted = p1;
      if (p2) formatted += '-' + p2;
      if (p3) formatted += '-' + p3;
      return formatted;
    };

    const isValidLicense = (value) => {
      return /^[A-Z]\d{2}-\d{2}-\d{6}$/.test((value||'').toString());
    };

    const normalizeLicenseForCompare = (value) => {
      return (value||'').toString().toUpperCase().replace(/[^A-Z0-9]/g, '');
    };

    // Helper: strip +63 prefix for display
    const stripPhonePrefix = (phone) => {
      if (!phone) return '';
      const str = phone.toString();
      if (str.startsWith('+63')) return str.slice(3);
      return str;
    };

    // Backfill bookings with a driverSnapshot (name, tricycle, license)
    const backfillBookings = async () => {
      if (!window.db || !window.dbRef || !window.dbGet || !window.dbUpdate) {
        window.showAlert('DB helpers not available', 'error');
        return;
      }
      try {
        const bookingsSnap = await window.dbGet(window.dbRef(window.db, 'booking'));
        const bookingsVal = bookingsSnap.val() || {};
        let count = 0;
        for (const [bkId, b] of Object.entries(bookingsVal)) {
          if (!b.DriverID) continue;
          const d = window.drivers && window.drivers.find(drv => drv.id === b.DriverID);
          if (!d) continue;
          const snapshot = {
            name: d.name || '',
            tricycle: d.tricycle || '',
            license: d.license || '',
            userId: d.userId || null
          };
          await window.dbUpdate(window.dbRef(window.db, `booking/${bkId}`), { driverSnapshot: snapshot });
          count++;
        }
        window.showAlert(`Backfilled ${count} booking(s) with driver snapshot`, 'success');
      } catch (err) {
        console.error('Error backfilling bookings:', err);
        window.showAlert('Error backfilling bookings: ' + (err && err.message ? err.message : err), 'error');
      }
    };

    // --- MAIN AdminDashboard COMPONENT ---
    const AdminDashboard = () => {
      const [currentPage, setCurrentPage] = useState('bookings');
      const [userName, setUserName] = useState('Admin');

      // Booking Management State
      const [rawUsers, setRawUsers] = useState({});
      const [rawDrivers, setRawDrivers] = useState({});
      const [rawPassengers, setRawPassengers] = useState({});
      const [rawBookings, setRawBookings] = useState({});
      const [allBookings, setAllBookings] = useState([]);
      const [filteredBookings, setFilteredBookings] = useState([]);
      const [showBookingFilterModal, setShowBookingFilterModal] = useState(false);
      const [dateFrom, setDateFrom] = useState("");
      const [dateTo, setDateTo] = useState("");
      const [selectedBookingDriver, setSelectedBookingDriver] = useState("All Drivers");
      const [statusFilters, setStatusFilters] = useState({
        Completed: true,
        Pending: true,
        Cancelled: true
      });

      // Audit Logs State
      const [auditLogs, setAuditLogs] = useState([]);
      const [auditSearchTerm, setAuditSearchTerm] = useState('');
      const [auditRawDrivers, setAuditRawDrivers] = useState({});
      const [auditRawUsers, setAuditRawUsers] = useState({});

      // Passenger Management State
      const [passengers, setPassengers] = useState([]);
      const [rideHistory, setRideHistory] = useState([]);
      const [selectedPassenger, setSelectedPassenger] = useState(null);
      const [selectedPassengerIndex, setSelectedPassengerIndex] = useState(null);
      const [showPassengerEditModal, setShowPassengerEditModal] = useState(false);
      const [showPassengerFilterModal, setShowPassengerFilterModal] = useState(false);
      const [passengerSearchQuery, setPassengerSearchQuery] = useState("");
      const [passengerStartDate, setPassengerStartDate] = useState("");
      const [passengerEndDate, setPassengerEndDate] = useState("");
      const [rawFeedback, setRawFeedback] = useState({});

      // Load user info from sessionStorage
      React.useEffect(() => {
        const storedName = sessionStorage.getItem('userName') || 'Admin';
        setUserName(storedName);
      }, []);

      // Subscribe to bookings data
      React.useEffect(() => {
        if (!window.db || !window.dbRef || !window.dbOnValue) return;

        const usersRef = window.dbRef(window.db, 'users');
        const driversRef = window.dbRef(window.db, 'drivers');
        const passengersRef = window.dbRef(window.db, 'passengers');
        const bookingsRef = window.dbRef(window.db, 'bookings');
        const applicationsRef = window.dbRef(window.db, 'applications');
        const feedbackRef = window.dbRef(window.db, 'feedback');

        const unsubUsers = window.dbOnValue(usersRef, snap => setRawUsers(snap.val() || {}));
        const unsubDrivers = window.dbOnValue(driversRef, snap => setRawDrivers(snap.val() || {}));
        const unsubPassengers = window.dbOnValue(passengersRef, snap => setRawPassengers(snap.val() || {}));
        const unsubBookings = window.dbOnValue(bookingsRef, snap => setRawBookings(snap.val() || {}));
        const unsubApplications = window.dbOnValue(applicationsRef, snap => setRawApplications(snap.val() || {}));
        const unsubFeedback = window.dbOnValue(feedbackRef, snap => setRawFeedback(snap.val() || {}));

        return () => {
          try { unsubUsers(); } catch(e) {}
          try { unsubDrivers(); } catch(e) {}
          try { unsubPassengers(); } catch(e) {}
          try { unsubBookings(); } catch(e) {}
          try { unsubApplications(); } catch(e) {}
          try { unsubFeedback(); } catch(e) {}
        };
      }, []);

      // Derive bookings array from DB objects
      React.useEffect(() => {
        const makeFullName = (u) => {
          if (!u) return 'Unknown';
          return [u.Firstname, u.Middlename, u.Lastname].filter(Boolean).join(' ');
        };

        const bookingsArr = Object.entries(rawBookings || {}).map(([key, b]) => {
          const passengerRec = rawPassengers && rawPassengers[b.PassengerID];
          const passengerUser = passengerRec ? rawUsers[passengerRec.UserID] : null;
          const driverRec = rawDrivers && rawDrivers[b.DriverID];
          const driverUser = driverRec ? rawUsers[driverRec.UserID] : null;
          const requested = b.RequestedAt || '';
          const date = requested ? new Date(requested).toISOString().slice(0, 10) : '';
          const time = requested ? new Date(requested).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';

          const dSnap = b.driverSnapshot || null;
          let driverName = 'Driver';
          let driverTricycle = '';
          let driverLicense = '';
          if (dSnap && dSnap.name) {
            driverName = dSnap.name;
            driverTricycle = dSnap.tricycle || '';
            driverLicense = dSnap.license || '';
          } else if (driverUser) {
            driverName = makeFullName(driverUser);
            driverTricycle = driverRec ? (driverRec.TricycleNumber || '') : '';
            driverLicense = driverRec ? (driverRec.LicenseNumber || '') : '';
          }

          return {
            id: parseInt(key) || hashKeyToInt(key),
            passenger: b.userName || 'Passenger',
            pickup: b.PickupLocation || '',
            destination: b.DropoffLocation || '',
            fare: b.TotalFare || 0,
            status: (b.Status || 'Unknown').charAt(0).toUpperCase() + (b.Status || 'Unknown').slice(1).toLowerCase(),
            driver: driverName,
            driverTricycle,
            driverLicense,
            distance: b.distanceKm ? `${b.distanceKm}km` : '',
            date,
            time
          };
        });

        setAllBookings(bookingsArr);
        setFilteredBookings(bookingsArr);
      }, [rawUsers, rawDrivers, rawPassengers, rawBookings]);

      // Derive drivers array from users
      React.useEffect(() => {
        const makeFullName = (u) => {
          if (!u) return 'Unknown';
          return [u.Firstname, u.Middlename, u.Lastname].filter(Boolean).join(' ');
        };

        const usersVal = rawUsers || {};
        const drvsVal = rawDrivers || {};
        const driversArr = Object.entries(usersVal)
          .map(([userId, u]) => {
            if (!u) return null;
            if (String(u.RoleID) !== '2') return null;
            if (!u.IsActive) return null;
            if (u.DeletedAt) return null;

            let drvKey = null;
            let drvRec = null;
            for (const [k, drv] of Object.entries(drvsVal)) {
              if (!drv) continue;
              if (String(drv.UserID) === String(userId)) { drvKey = k; drvRec = drv; break; }
            }

            const name = makeFullName(u);
            const tricycle = drvRec ? (drvRec.TricyclePlateNumber || drvRec.TricycleNumber || '') : '';
            const license = drvRec ? (drvRec.LicenseNumber || '') : '';
            const contact = u ? u.MobileNumber : '';
            const status = drvRec && (drvRec.Status === 'Active' || (drvRec.ApplicationStatus || '').toString().toUpperCase().includes('ADDED')) ? 'Active' : 'Inactive';

            return {
              id: drvKey || `user-${userId}`,
              driverId: drvKey || null,
              userId: userId,
              name,
              tricycle,
              license,
              contact,
              status,
              isActiveUser: !!u.IsActive,
              registeredDate: u.CreatedAt || '' ,
              franchiseExpiry: drvRec ? (drvRec.FranchiseExpiry || '') : ''
            };
          })
          .filter(Boolean);

        setDrivers(driversArr);
        window.drivers = driversArr;
      }, [rawUsers, rawDrivers]);

      // Derive passengers array with ride statistics
      React.useEffect(() => {
        const makeFullName = (u) => {
          if (!u) return 'Unknown';
          return [u.Firstname, u.Middlename, u.Lastname].filter(Boolean).join(' ');
        };

        const usersVal = rawUsers || {};
        const bookingsVal = rawBookings || {};
        const feedbackVal = rawFeedback || {};

        const passengersArr = Object.entries(usersVal)
          .map(([userId, u]) => {
            if (!u) return null;
            if (String(u.RoleID) !== '3') return null;
            if (!u.IsActive) return null;
            if (u.DeletedAt) return null;

            // Count rides and ratings
            const userBookings = Object.values(bookingsVal)
              .filter(b => b && String(b.PassengerID) === String(userId));
            
            const ratings = userBookings
              .map(booking => feedbackVal[booking.BookingID])
              .filter(f => f && f.Rating)
              .map(f => parseFloat(f.Rating));
            
            const avgRating = ratings.length > 0 
              ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1)
              : 'N/A';

            const name = makeFullName(u);
            const email = u.Email || '';
            const contact = u.MobileNumber || '';

            return {
              id: userId,
              userId: userId,
              name,
              email,
              contact,
              totalRides: userBookings.length,
              averageRating: avgRating,
              status: u.IsActive ? 'Active' : 'Inactive',
              registeredDate: u.CreatedAt || ''
            };
          })
          .filter(Boolean);

        setPassengers(passengersArr);
      }, [rawUsers, rawBookings, rawFeedback]);

      // Derive ride history for selected passenger
      React.useEffect(() => {
        if (!selectedPassenger) {
          setRideHistory([]);
          return;
        }

        const bookingsVal = rawBookings || {};
        const usersVal = rawUsers || {};
        const feedbackVal = rawFeedback || {};

        const history = Object.entries(bookingsVal)
          .filter(([key, booking]) => booking && String(booking.PassengerID) === String(selectedPassenger.userId))
          .map(([key, booking]) => {
            const driver = Object.values(usersVal)
              .find(u => u && String(u.UserID || u.userId || u.id) === String(booking.DriverID));
            
            const driverName = driver 
              ? [driver.Firstname, driver.Middlename, driver.Lastname].filter(Boolean).join(' ').trim() 
              : 'Unknown';
            
            const feedback = feedbackVal[key] || {};
            
            return {
              bookingId: key,
              driverName: driverName,
              pickup: booking.PickupLocation || '',
              dropoff: booking.DropoffLocation || '',
              distance: booking.distanceKm || 0,
              fare: booking.TotalFare || 0,
              rating: feedback.Rating ? parseFloat(feedback.Rating).toFixed(1) : 'N/A',
              status: (booking.Status || 'Pending').toUpperCase(),
              timestamp: booking.RequestedAt || ''
            };
          })
          .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        setRideHistory(history);
      }, [selectedPassenger, rawBookings, rawUsers, rawFeedback]);

      // Driver management handlers
      // --- FULL DRIVER MANAGEMENT HANDLERS, MODALS, AND UI REPLACED BELOW ---
      // ...existing code from driver management.html (handlers, modals, etc.)...
      // (See next patch for the full JSX/UI replacement)

      // Booking filter functions
      const applyBookingFilters = () => {
        let filtered = [...allBookings];

        if (dateFrom) {
          filtered = filtered.filter(b => b.date >= dateFrom);
        }
        if (dateTo) {
          filtered = filtered.filter(b => b.date <= dateTo);
        }

        if (selectedBookingDriver !== "All Drivers") {
          filtered = filtered.filter(b => b.driver === selectedBookingDriver);
        }

        filtered = filtered.filter(b => statusFilters[b.status]);

        setFilteredBookings(filtered);
        setShowBookingFilterModal(false);
      };

      const resetBookingFilters = () => {
        setDateFrom("");
        setDateTo("");
        setSelectedBookingDriver("All Drivers");
        setStatusFilters({ Completed: true, Pending: true, Cancelled: true });
        setFilteredBookings(allBookings);
      };

      const toggleBookingStatus = (status) => {
        setStatusFilters(prev => ({ ...prev, [status]: !prev[status] }));
      };

      // Get unique driver names for dropdown
      const driverNames = React.useMemo(() => {
        const names = new Set();
        Object.entries(rawDrivers || {}).forEach(([id, d]) => {
          if (!d || d.IsActive === false || d.DeletedAt) return;
          const u = rawUsers && rawUsers[d.UserID];
          if (!u || u.IsActive === false || u.DeletedAt) return;
          const name = [u.Firstname, u.Middlename, u.Lastname].filter(Boolean).join(' ');
          if (name) names.add(name);
        });
        return Array.from(names).sort();
      }, [rawDrivers, rawUsers]);

      // Audit logs listeners
      React.useEffect(() => {
        if (!window.db || !window.dbRef || !window.dbOnValue) return;
        const driversRef = window.dbRef(window.db, 'drivers');
        const usersRef = window.dbRef(window.db, 'users');

        const unsubDrivers = window.dbOnValue(driversRef, snap => setAuditRawDrivers(snap.val() || {}));
        const unsubUsers = window.dbOnValue(usersRef, snap => setAuditRawUsers(snap.val() || {}));

        return () => {
          try { unsubDrivers(); } catch(e) {}
          try { unsubUsers(); } catch(e) {}
        };
      }, []);

      // Listen to audit logs
      React.useEffect(() => {
        if (!window.db || !window.dbRef || !window.dbOnValue) return;
        const logsRef = window.dbRef(window.db, 'auditLogs');
        const unsub = window.dbOnValue(logsRef, snap => {
          const val = snap.val() || {};
          const items = Object.entries(val).map(([key, log], index) => {
            const driverId = log.DriverID || '';
            let driverName = '';
            try {
              const drv = auditRawDrivers && auditRawDrivers[driverId];
              if (drv && drv.UserID && auditRawUsers && auditRawUsers[drv.UserID]) {
                const usr = auditRawUsers[drv.UserID];
                driverName = [usr.Firstname, usr.Middlename, usr.Lastname].filter(Boolean).join(' ');
              }
              if (!driverName && drv) {
                driverName = drv.Name || drv.name || '';
              }
              if (!driverName) driverName = log.DriverName || log.driver || driverId || 'Unknown Driver';
            } catch (e) {
              driverName = log.DriverName || log.driver || driverId || 'Unknown Driver';
            }
            
            const formatDate = (timestamp) => {
              if (!timestamp) return '';
              const date = new Date(timestamp);
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const day = String(date.getDate()).padStart(2, '0');
              return `${year}-${month}-${day}`;
            };
            
            return {
              id: `LOG${String(index + 1).padStart(3, '0')}`,
              dbKey: key,
              bookingId: log.BookingID || log.rideId || '',
              driver: driverName,
              driverId: driverId,
              event: log.ViolationType || log.event || '',
              location: log.Location || log.location || '',
              timestamp: formatDate(log.ViolationTimestamp || log.timestamp || ''),
              status: log.IsFlaggedForReview ? 'Flagged' : (log.status || 'Reviewed')
            };
          });
          setAuditLogs(items);
        });
        return () => { try { unsub(); } catch(e) {} };
      }, [auditRawDrivers, auditRawUsers]);

      // Filter audit logs
      const filteredAuditLogs = (auditLogs || []).filter(log =>
        (log.id || '').toString().toLowerCase().includes(auditSearchTerm.toLowerCase()) ||
        (log.bookingId || '').toString().toLowerCase().includes(auditSearchTerm.toLowerCase()) ||
        (log.driver || '').toString().toLowerCase().includes(auditSearchTerm.toLowerCase()) ||
        (log.event || '').toString().toLowerCase().includes(auditSearchTerm.toLowerCase()) ||
        (log.location || '').toString().toLowerCase().includes(auditSearchTerm.toLowerCase()) ||
        (log.status || '').toString().toLowerCase().includes(auditSearchTerm.toLowerCase())
      );

      // Handle audit status change
      const handleAuditStatusChange = (dbKey, currentStatus) => {
        if (!window.db || !window.dbRef || !window.dbUpdate) return;
        const newStatus = currentStatus === 'Flagged' ? false : true;
        const logRef = window.dbRef(window.db, `auditLogs/${dbKey}`);
        window.dbUpdate(logRef, { IsFlaggedForReview: newStatus })
          .catch(err => console.error('Error updating status:', err));
      };

      const getStatusColor = (status) => {
        if (status === "Completed") return "text-green-400";
        if (status === "Pending") return "text-yellow-300";
        if (status === "Cancelled") return "text-red-400";
        return "text-gray-400";
      };

      // Passenger management handlers
      const handleEditPassenger = (index) => {
        setSelectedPassenger(passengers[index]);
        setSelectedPassengerIndex(index);
        setShowPassengerEditModal(true);
      };

      const handleDeletePassenger = (index) => {
        setSelectedPassenger(passengers[index]);
        setSelectedPassengerIndex(index);
        setConfirmDelete(true);
      };

      const performDeletePassenger = async () => {
        if (!selectedPassenger || !window.db || !window.dbRef || !window.dbUpdate) {
          setConfirmDelete(false);
          return;
        }

        try {
          const userRef = window.dbRef(window.db, `users/${selectedPassenger.userId}`);
          await window.dbUpdate(userRef, { IsActive: false, DeletedAt: new Date().toISOString() });
          window.showAlert('Passenger deactivated successfully', 'success');
          setConfirmDelete(false);
          setSelectedPassenger(null);
        } catch (error) {
          console.error('Error deleting passenger:', error);
          window.showAlert('Error deactivating passenger', 'error');
        }
      };

      const handleSavePassenger = async (editedPassenger) => {
        if (!editedPassenger || !window.db || !window.dbRef || !window.dbUpdate) return;

        // Validation
        if (!editedPassenger.name || editedPassenger.name.trim() === '') {
          window.showAlert('Name is required', 'error');
          return;
        }

        if (!/^\d{11}$/.test(editedPassenger.contact.replace(/\D/g, ''))) {
          window.showAlert('Mobile number must be 11 digits', 'error');
          return;
        }

        if (editedPassenger.email && !editedPassenger.email.toLowerCase().endsWith('@gmail.com')) {
          window.showAlert('Email must be a Gmail address (@gmail.com)', 'error');
          return;
        }

        try {
          const [firstname, ...rest] = editedPassenger.name.split(' ');
          const lastname = rest.pop() || '';
          const middlename = rest.join(' ') || '';

          const userRef = window.dbRef(window.db, `users/${editedPassenger.userId}`);
          await window.dbUpdate(userRef, {
            Firstname: firstname,
            Middlename: middlename,
            Lastname: lastname,
            MobileNumber: editedPassenger.contact,
            Email: editedPassenger.email || ''
          });
          window.showAlert('Passenger updated successfully', 'success');
          setShowPassengerEditModal(false);
          setSelectedPassenger(null);
        } catch (error) {
          console.error('Error saving passenger:', error);
          window.showAlert('Error updating passenger', 'error');
        }
      };

      const handleLogout = async () => {
        try {
          await window.firebaseSignOut(window.firebaseAuth);
          sessionStorage.clear();
          window.location.href = 'log in.html';
        } catch (error) {
          console.error('Logout error:', error);
          alert('Error logging out');
        }
      };

      // AddDriverModal Component
      const AddDriverModal = ({ onClose, onSave }) => {
        const [newDriver, setNewDriver] = React.useState({
          name: "",
          tricycle: "",
          contact: "",
          license: "",
          status: "Active"
        });
        const [nameError, setNameError] = React.useState("");
        const [licenseError, setLicenseError] = React.useState("");
        const [isSaving, setIsSaving] = React.useState(false);

        const handleChange = (field, value) => {
          if (field === 'contact') {
            const numericValue = value.replace(/\D/g, '').slice(0, 11);
            setNewDriver(prev => ({ ...prev, [field]: numericValue }));
          } else if (field === 'name') {
            const hadDigits = /\d/.test(value);
            if (hadDigits) {
              setNameError('Names cannot contain numbers');
            } else {
              setNameError('');
            }
            const sanitized = value.replace(/[^a-zA-Z\s\-']/g, '');
            setNewDriver(prev => ({ ...prev, [field]: sanitized }));
          } else if (field === 'license') {
            const raw = value.replace(/[^A-Za-z0-9\-]/g, '');
            setNewDriver(prev => ({ ...prev, license: raw }));
            setLicenseError('');
          } else {
            setNewDriver(prev => ({ ...prev, [field]: value }));
          }
        };

        const handleBlur = (field) => {
          if (field === 'license') {
            const formatted = formatLicense(newDriver.license);
            setNewDriver(prev => ({ ...prev, license: formatted }));
            if (!formatted || formatted.length < 13) {
              setLicenseError('License number seems incomplete.');
              return;
            }
            if (!isValidLicense(formatted)) {
              setLicenseError('License must match format A01-23-456789');
            } else {
              setLicenseError('');
            }
          }
        };

        const handleAddDriver = () => {
          if (isSaving) return;
          if (!newDriver.name || !newDriver.tricycle || !newDriver.contact || !newDriver.license) {
            window.showAlert("Please fill in all fields!", 'error');
            return;
          }
          const formattedLicense = formatLicense(newDriver.license);
          const licenseRegex = /^[A-Z]\d{2}-\d{2}-\d{6}$/;
          if (!licenseRegex.test(formattedLicense)) {
            window.showAlert('License number must match format like A01-23-456789', 'error');
            return;
          }
          if (/\d/.test(newDriver.name)) {
            window.showAlert('Full name cannot contain numbers.', 'error');
            return;
          }
          if (newDriver.contact.length !== 11) {
            window.showAlert("Phone number must be exactly 11 digits!", 'error');
            return;
          }

          try {
            setIsSaving(true);
            const res = onSave(newDriver);
            if (res && typeof res.then === 'function') {
              res.then(() => setIsSaving(false)).catch(() => setIsSaving(false));
            } else {
              setIsSaving(false);
            }
          } catch (e) {
            setIsSaving(false);
          }
        };

        return (
          <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50">
            <div className="bg-[#1e2538] p-8 rounded-xl w-full max-w-md">
              <h2 className="text-2xl font-bold mb-6 text-white">Add New Driver</h2>
              <div className="grid grid-cols-2 gap-4">
                <input 
                  className="col-span-2 px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                  placeholder="Full Name" 
                  value={newDriver.name}
                  onChange={(e) => handleChange('name', e.target.value)}
                />
                {nameError && <p className="col-span-2 text-sm text-red-400 mt-1">{nameError}</p>}
                <input 
                  className="col-span-1 px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                  placeholder="Plate Number" 
                  value={newDriver.tricycle}
                  onChange={(e) => handleChange('tricycle', e.target.value)}
                />
                <input 
                  className="col-span-1 px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                  placeholder="Phone (11 digits)" 
                  value={newDriver.contact}
                  onChange={(e) => handleChange('contact', e.target.value)}
                  maxLength={11}
                />
                <input 
                  className="col-span-2 px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                  placeholder="License (A01-23-456789)" 
                  value={newDriver.license}
                  onChange={(e) => handleChange('license', e.target.value)}
                  onBlur={() => handleBlur('license')}
                  maxLength={13}
                />
                {licenseError && <p className="col-span-2 text-sm text-red-400 mt-1">{licenseError}</p>}
              </div>
              <p className="text-xs text-gray-400 mt-2">{newDriver.contact.length}/11 digits</p>
              <div className="flex justify-between mt-6">
                <button onClick={onClose} className="bg-red-600 hover:bg-red-700 px-8 py-3 rounded-lg font-semibold text-white">Cancel</button>
                <button onClick={handleAddDriver} disabled={isSaving} className={`px-8 py-3 rounded-lg font-semibold text-white ${isSaving ? 'bg-gray-600 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'}`}>
                  {isSaving ? 'Adding…' : 'Add Driver'}
                </button>
              </div>
            </div>
          </div>
        );
      };

      // EditDriverModal Component
      const EditDriverModal = ({ driver, driverIndex, onClose, onSave }) => {
        const [editedDriver, setEditedDriver] = React.useState({
          name: driver.name,
          contact: stripPhonePrefix(driver.contact),
          license: driver.license,
          tricycle: driver.tricycle,
          franchiseExpiry: driver.franchiseExpiry || ''
        });
        const [editedLicenseError, setEditedLicenseError] = React.useState("");

        const handleChange = (field, value) => {
          if (field === 'contact') {
            const numericValue = value.replace(/\D/g, '').slice(0, 11);
            setEditedDriver(prev => ({ ...prev, [field]: numericValue }));
          } else if (field === 'license') {
            const raw = value.replace(/[^A-Za-z0-9\-]/g, '');
            setEditedDriver(prev => ({ ...prev, license: raw }));
            setEditedLicenseError('');
          } else {
            setEditedDriver(prev => ({ ...prev, [field]: value }));
          }
        };

        const handleEditBlur = (field) => {
          if (field === 'license') {
            const formatted = formatLicense(editedDriver.license);
            setEditedDriver(prev => ({ ...prev, license: formatted }));
            if (!formatted || formatted.length < 13) {
              setEditedLicenseError('License number seems incomplete.');
              return;
            }
            if (!isValidLicense(formatted)) {
              setEditedLicenseError('License must match format A01-23-456789');
            } else {
              setEditedLicenseError('');
            }
          }
        };

        const handleSave = async () => {
          const contactDigits = editedDriver.contact.toString().replace(/\D/g, '');
          if (contactDigits.length !== 11) {
            window.showAlert("Phone number must be exactly 11 digits!", 'error');
            return;
          }
          if (!isValidLicense(editedDriver.license)) {
            window.showAlert('License must match format A01-23-456789', 'error');
            return;
          }

          try {
            const contactWithPrefix = '+63' + contactDigits;
            onSave(driverIndex, { ...editedDriver, contact: contactWithPrefix });
          } catch (err) {
            console.error('Error saving driver:', err);
            window.showAlert('Error saving changes: ' + err.message, 'error');
          }
        };

        return (
          <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50 p-4">
            <div className="bg-[#1e2538] p-8 rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
              <h2 className="text-2xl font-bold mb-6 text-white">Edit Driver Information</h2>
              <div className="space-y-4">
                <div>
                  <label className="block text-gray-300 mb-2 font-medium">Driver Name</label>
                  <input 
                    className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                    value={editedDriver.name}
                    onChange={(e) => handleChange('name', e.target.value)}
                  />
                </div>
                <div>
                  <label className="block text-gray-300 mb-2 font-medium">Contact Number (11 digits)</label>
                  <div className="flex">
                    <div className="inline-flex items-center px-3 rounded-l-lg bg-[#1b2333] text-white border border-r-0 border-gray-700">+63</div>
                    <input 
                      className="w-full px-4 py-3 rounded-r-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                      value={editedDriver.contact}
                      onChange={(e) => handleChange('contact', e.target.value)}
                      maxLength={11}
                    />
                  </div>
                  <p className="text-xs text-gray-400 mt-1">{editedDriver.contact.replace(/\D/g, '').length}/11 digits</p>
                </div>
                <div>
                  <label className="block text-gray-300 mb-2 font-medium">License Number</label>
                  <input 
                    className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                    value={editedDriver.license}
                    onChange={(e) => handleChange('license', e.target.value)}
                    onBlur={() => handleEditBlur('license')}
                  />
                  {editedLicenseError && <p className="text-sm text-red-400 mt-1">{editedLicenseError}</p>}
                </div>
                <div>
                  <label className="block text-gray-300 mb-2 font-medium">Plate Number</label>
                  <input 
                    className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                    value={editedDriver.tricycle}
                    onChange={(e) => handleChange('tricycle', e.target.value)}
                  />
                </div>
                <div>
                  <label className="block text-gray-300 mb-2 font-medium">Franchise Expiry</label>
                  <input 
                    type="date"
                    className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                    value={editedDriver.franchiseExpiry}
                    onChange={(e) => handleChange('franchiseExpiry', e.target.value)}
                  />
                </div>
              </div>
              <div className="flex justify-between gap-3 mt-8">
                <button onClick={onClose} className="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold text-white flex-1">Cancel</button>
                <button onClick={handleSave} className="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold text-white flex-1">Save Changes</button>
              </div>
            </div>
          </div>
        );
      };

      // EditPassengerModal Component
      const EditPassengerModal = ({ passenger, passengerIndex, onClose, onSave }) => {
        const [editedPassenger, setEditedPassenger] = React.useState(passenger || {
          name: '',
          email: '',
          contact: ''
        });

        const handleChange = (field, value) => {
          if (field === 'contact') {
            const numericValue = value.replace(/\D/g, '').slice(0, 11);
            setEditedPassenger(prev => ({ ...prev, [field]: numericValue }));
          } else if (field === 'name') {
            const sanitized = value.replace(/[^a-zA-Z\s\-']/g, '');
            setEditedPassenger(prev => ({ ...prev, [field]: sanitized }));
          } else {
            setEditedPassenger(prev => ({ ...prev, [field]: value }));
          }
        };

        const handleSave = () => {
          onSave(editedPassenger);
        };

        return (
          <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
            <div className="bg-[#1b2333] border border-gray-700 rounded-xl p-8 max-w-md w-full mx-4">
              <h3 className="text-xl font-bold text-white mb-6">Edit Passenger</h3>
              <div className="space-y-4 mb-8">
                <div>
                  <label className="block text-gray-300 mb-2 font-medium">Full Name</label>
                  <input 
                    type="text"
                    className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                    value={editedPassenger.name}
                    onChange={(e) => handleChange('name', e.target.value)}
                  />
                </div>
                <div>
                  <label className="block text-gray-300 mb-2 font-medium">Email (Gmail only)</label>
                  <input 
                    type="email"
                    className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                    value={editedPassenger.email}
                    onChange={(e) => handleChange('email', e.target.value)}
                  />
                </div>
                <div>
                  <label className="block text-gray-300 mb-2 font-medium">Contact Number (11 digits)</label>
                  <div className="flex">
                    <div className="inline-flex items-center px-3 rounded-l-lg bg-[#1b2333] text-white border border-r-0 border-gray-700">+63</div>
                    <input 
                      className="w-full px-4 py-3 rounded-r-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none" 
                      value={editedPassenger.contact}
                      onChange={(e) => handleChange('contact', e.target.value)}
                      maxLength={11}
                    />
                  </div>
                  <p className="text-xs text-gray-400 mt-1">{editedPassenger.contact.replace(/\D/g, '').length}/11 digits</p>
                </div>
              </div>
              <div className="flex justify-between gap-3">
                <button onClick={onClose} className="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold text-white flex-1">Cancel</button>
                <button onClick={handleSave} className="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold text-white flex-1">Save</button>
              </div>
            </div>
          </div>
        );
      };

      return (
        <div className="min-h-screen bg-[#0a0e1a]">
          {/* Header */}
          <header className="bg-[#151b28] border-b border-gray-700">
            <div className="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-lg flex items-center justify-center overflow-hidden bg-yellow-500">
                  <img src="tricy.png" alt="Pasakay" className="w-full h-full object-cover p-1" />
                </div>
                <h1 className="text-2xl font-bold text-yellow-500">PASAKAY</h1>
              </div>
              <div className="text-right">
                <p className="text-sm text-gray-400">Logged in as</p>
                <p className="font-semibold text-white">{userName}</p>
              </div>
            </div>
          </header>

          {/* Navigation Tabs */}
          <div className="bg-[#0f1419] border-b border-gray-700 sticky top-0 z-10">
            <div className="max-w-7xl mx-auto px-6">
              <div className="flex gap-8">
                <button
                  onClick={() => setCurrentPage('bookings')}
                  className={`py-4 px-2 border-b-2 transition-colors ${
                    currentPage === 'bookings'
                      ? 'border-yellow-500 text-yellow-500 font-semibold'
                      : 'border-transparent text-gray-400 hover:text-white'
                  }`}
                >
                  Bookings
                </button>
                <button
                  onClick={() => setCurrentPage('drivers')}
                  className={`py-4 px-2 border-b-2 transition-colors ${
                    currentPage === 'drivers'
                      ? 'border-yellow-500 text-yellow-500 font-semibold'
                      : 'border-transparent text-gray-400 hover:text-white'
                  }`}
                >
                  Drivers
                </button>
                <button
                  onClick={() => setCurrentPage('audit')}
                  className={`py-4 px-2 border-b-2 transition-colors ${
                    currentPage === 'audit'
                      ? 'border-yellow-500 text-yellow-500 font-semibold'
                      : 'border-transparent text-gray-400 hover:text-white'
                  }`}
                >
                  Audit Logs
                </button>
                <button
                  onClick={() => setCurrentPage('passengers')}
                  className={`py-4 px-2 border-b-2 transition-colors ${
                    currentPage === 'passengers'
                      ? 'border-yellow-500 text-yellow-500 font-semibold'
                      : 'border-transparent text-gray-400 hover:text-white'
                  }`}
                >
                  Passengers
                </button>
                <button
                  onClick={() => setCurrentPage('fareMatrix')}
                  className={`py-4 px-2 border-b-2 transition-colors ${
                    currentPage === 'fareMatrix'
                      ? 'border-yellow-500 text-yellow-500 font-semibold'
                      : 'border-transparent text-gray-400 hover:text-white'
                  }`}
                >
                  Fare Matrix
                </button>
                <button
                  onClick={handleLogout}
                  className="py-4 px-2 text-gray-400 hover:text-red-400 transition-colors ml-auto"
                >
                  Log out
                </button>
              </div>
            </div>
          </div>

          {/* Content */}
          <div className="max-w-7xl mx-auto px-6 py-8">
            {/* Bookings Page */}
            {currentPage === 'bookings' && (
              <div className="space-y-6">
                <h2 className="text-3xl font-bold text-white">Booking Management</h2>
                <div className="bg-[#1e2538] p-8 rounded-xl">
                  <div className="flex justify-between items-center mb-6">
                    <h3 className="text-2xl font-bold text-white">Booking List ({filteredBookings.length} Bookings)</h3>
                    <button
                      className="bg-yellow-500 hover:bg-yellow-600 px-6 py-3 rounded-lg font-semibold text-gray-900 transition-colors"
                      onClick={() => setShowBookingFilterModal(true)}
                    >
                      FILTER BOOKINGS
                    </button>
                  </div>

                  <div className="space-y-4">
                    {filteredBookings.length > 0 ? (
                      filteredBookings.map(booking => (
                        <div key={booking.id} className="bg-[#252d42] p-6 rounded-lg hover:bg-[#2d3548] transition-colors">
                          <div className="flex justify-between items-start">
                            <div>
                              <h4 className="font-bold text-white text-lg mb-2">Booking #{booking.id}</h4>
                              <p className="text-sm text-gray-400 mb-1">
                                <span className="font-medium text-gray-300">Passenger:</span> {booking.passenger}
                              </p>
                              <p className="text-sm text-gray-400 mb-1">
                                <span className="font-medium text-gray-300">Route:</span> {booking.pickup} → {booking.destination}
                              </p>
                              <p className="text-sm text-gray-400 mb-1">
                                <span className="font-medium text-gray-300">Driver:</span> {booking.driver} • <span className="font-medium text-gray-300">Distance:</span> {booking.distance}
                              </p>
                              <p className="text-sm text-gray-400">
                                <span className="font-medium text-gray-300">Date & Time:</span> {new Date(booking.date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })} {booking.time}
                              </p>
                            </div>
                            <div className="flex flex-col items-end gap-2">
                              <span className={`px-4 py-2 rounded-lg text-sm font-bold ${
                                booking.status === "Completed" ? "bg-green-600 text-white" :
                                booking.status === "Pending" ? "bg-yellow-500 text-gray-900" :
                                "bg-red-600 text-white"
                              }`}>
                                {booking.status}
                              </span>
                              <span className="text-xl font-bold text-yellow-500">₱{booking.fare}</span>
                            </div>
                          </div>
                        </div>
                      ))
                    ) : (
                      <div className="text-center text-gray-400 py-8 bg-[#252d42] rounded-lg">
                        No bookings found matching your filters
                      </div>
                    )}
                  </div>
                </div>

                {/* Booking Filter Modal */}
                {showBookingFilterModal && (
                  <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50">
                    <div className="bg-[#1e2538] p-8 rounded-xl w-[500px] relative">
                      <button
                        className="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl font-light"
                        onClick={() => setShowBookingFilterModal(false)}
                      >
                        &times;
                      </button>
                      <h2 className="text-2xl font-bold mb-6 text-white">Filter Bookings</h2>

                      <div className="flex flex-col gap-6">
                        <div>
                          <label className="mb-2 block font-semibold text-gray-300">Date Range</label>
                          <div className="flex gap-3 items-center">
                            <input 
                              type="date" 
                              value={dateFrom}
                              onChange={(e) => setDateFrom(e.target.value)}
                              className="px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none flex-1" 
                            />
                            <span className="text-gray-400">to</span>
                            <input 
                              type="date" 
                              value={dateTo}
                              onChange={(e) => setDateTo(e.target.value)}
                              className="px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none flex-1" 
                            />
                          </div>
                        </div>

                        <div>
                          <label className="mb-2 block font-semibold text-gray-300">Driver</label>
                          <select 
                            value={selectedBookingDriver}
                            onChange={(e) => setSelectedBookingDriver(e.target.value)}
                            className="px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none w-full"
                          >
                            <option>All Drivers</option>
                            {driverNames.map((driver, idx) => (
                              <option key={idx}>{driver}</option>
                            ))}
                          </select>
                        </div>

                        <div>
                          <label className="mb-2 block font-semibold text-gray-300">Booking Status</label>
                          <div className="flex flex-col gap-3">
                            <label className="flex items-center gap-3 cursor-pointer text-gray-300 hover:text-white">
                              <input 
                                type="checkbox" 
                                checked={statusFilters.Completed}
                                onChange={() => toggleBookingStatus("Completed")}
                                className="w-5 h-5"
                              /> 
                              <span className="text-green-400 font-medium">Completed</span>
                            </label>
                            <label className="flex items-center gap-3 cursor-pointer text-gray-300 hover:text-white">
                              <input 
                                type="checkbox" 
                                checked={statusFilters.Pending}
                                onChange={() => toggleBookingStatus("Pending")}
                                className="w-5 h-5"
                              /> 
                              <span className="text-yellow-300 font-medium">Pending</span>
                            </label>
                            <label className="flex items-center gap-3 cursor-pointer text-gray-300 hover:text-white">
                              <input 
                                type="checkbox" 
                                checked={statusFilters.Cancelled}
                                onChange={() => toggleBookingStatus("Cancelled")}
                                className="w-5 h-5"
                              /> 
                              <span className="text-red-400 font-medium">Cancelled</span>
                            </label>
                          </div>
                        </div>
                      </div>

                      <div className="flex justify-between gap-3 mt-8">
                        <button 
                          className="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold text-white transition-colors"
                          onClick={resetBookingFilters}
                        >
                          Reset
                        </button>
                        <div className="flex gap-3">
                          <button 
                            className="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg font-semibold text-white transition-colors" 
                            onClick={() => setShowBookingFilterModal(false)}
                          >
                            Cancel
                          </button>
                          <button 
                            className="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold text-white transition-colors"
                            onClick={applyBookingFilters}
                          >
                            Apply Filters
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Drivers Page */}
            {currentPage === 'drivers' && (
              // --- FULL DRIVER MANAGEMENT UI FROM driver management.html ---
              <DriverManagement />
            )}

            {/* Audit Logs Page */}
            {currentPage === 'audit' && (
              <div className="space-y-6">
                <h2 className="text-3xl font-bold text-white">Audit Logs</h2>
                <div className="bg-[#1e2538] p-8 rounded-xl">
                  <div className="flex items-center justify-between mb-6">
                    <h3 className="text-2xl font-bold text-white">System Violation Reports</h3>
                    <div className="relative">
                      <svg className="w-5 h-5 absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                      </svg>
                      <input
                        type="text"
                        placeholder="Search logs..."
                        className="pl-12 pr-4 py-2 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none"
                        value={auditSearchTerm}
                        onChange={(e) => setAuditSearchTerm(e.target.value)}
                      />
                    </div>
                  </div>

                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="bg-[#252d42]">
                          <th className="px-6 py-4 text-left text-white font-semibold">Log ID</th>
                          <th className="px-6 py-4 text-left text-white font-semibold">Booking ID</th>
                          <th className="px-6 py-4 text-left text-white font-semibold">Driver</th>
                          <th className="px-6 py-4 text-left text-white font-semibold">Event</th>
                          <th className="px-6 py-4 text-left text-white font-semibold">Location</th>
                          <th className="px-6 py-4 text-left text-white font-semibold">Timestamp</th>
                          <th className="px-6 py-4 text-left text-white font-semibold">Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {filteredAuditLogs.map((log, index) => (
                          <tr key={index} className="bg-[#151b28] hover:bg-[#1a202e] border-b border-gray-700">
                            <td className="px-6 py-4 text-gray-300 font-medium">{log.id}</td>
                            <td className="px-6 py-4 text-gray-300">{log.bookingId}</td>
                            <td className="px-6 py-4 text-gray-300">{log.driver}</td>
                            <td className="px-6 py-4 text-yellow-400 font-medium">{log.event}</td>
                            <td className="px-6 py-4 text-gray-400">{log.location}</td>
                            <td className="px-6 py-4 text-gray-400">{log.timestamp}</td>
                            <td className="px-6 py-4">
                              <button
                                onClick={() => handleAuditStatusChange(log.dbKey, log.status)}
                                className={`px-3 py-1 rounded-lg text-sm font-bold text-white ${
                                  log.status === 'Flagged'
                                    ? 'bg-red-600 hover:bg-red-700'
                                    : 'bg-green-600 hover:bg-green-700'
                                }`}
                              >
                                {log.status}
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                    {filteredAuditLogs.length === 0 && (
                      <div className="text-center text-gray-400 py-8 bg-[#252d42] rounded-lg mt-4">
                        No logs found matching your search.
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* Passengers Page */}
            {currentPage === 'passengers' && (
              <div className="space-y-6">
                <h2 className="text-3xl font-bold text-white">Passenger Management</h2>
                <div className="bg-[#1e2538] p-8 rounded-xl">
                  <div className="flex justify-between items-center mb-6">
                    <h3 className="text-2xl font-bold text-white">Passenger List ({passengers.length} passengers)</h3>
                    <div className="relative">
                      <svg className="w-5 h-5 absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                      </svg>
                      <input
                        type="text"
                        placeholder="Search by name, email, or phone..."
                        className="pl-12 pr-4 py-2 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none w-96"
                        value={passengerSearchQuery}
                        onChange={(e) => setPassengerSearchQuery(e.target.value)}
                      />
                    </div>
                  </div>

                  <div className="space-y-4">
                    {passengers.length > 0 ? (
                      passengers
                        .filter(p => 
                          p.name.toLowerCase().includes(passengerSearchQuery.toLowerCase()) ||
                          p.email.toLowerCase().includes(passengerSearchQuery.toLowerCase()) ||
                          p.contact.includes(passengerSearchQuery)
                        )
                        .map((passenger, index) => (
                          <div key={index} className="flex justify-between items-center bg-[#252d42] p-6 rounded-lg hover:bg-[#2d3548] transition-colors">
                            <div className="flex items-center gap-4 flex-1">
                              <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-white ${passenger.status === 'Active' ? 'bg-blue-500' : 'bg-gray-500'}`}>
                                {passenger.name.split(' ').map(n => n[0]).join('').slice(0, 2)}
                              </div>
                              <div>
                                <h4 className="font-bold text-white text-lg">{passenger.name}</h4>
                                <p className="text-sm text-gray-400">
                                  {passenger.email} | {stripPhonePrefix(passenger.contact)} | {passenger.totalRides} rides
                                </p>
                                <p className="text-xs text-gray-500 mt-1">
                                  Rating: {passenger.averageRating}/5.0
                                </p>
                              </div>
                            </div>
                            <div className="flex items-center gap-3">
                              <span className={`px-3 py-1 rounded text-sm font-bold text-white ${passenger.status === 'Active' ? 'bg-green-500' : 'bg-gray-500'}`}>
                                {passenger.status}
                              </span>
                              <button
                                onClick={() => handleEditPassenger(index)}
                                className="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-lg text-sm font-semibold text-gray-900"
                              >
                                Edit
                              </button>
                              <button
                                onClick={() => handleDeletePassenger(index)}
                                className="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm font-semibold text-white"
                              >
                                Deactivate
                              </button>
                            </div>
                          </div>
                        ))
                    ) : (
                      <div className="text-center text-gray-400 py-8 bg-[#252d42] rounded-lg">
                        No passengers found.
                      </div>
                    )}
                  </div>
                </div>

                {/* Passenger Ride History */}
                {selectedPassenger && (
                  <div className="bg-[#1e2538] p-8 rounded-xl">
                    <h3 className="text-2xl font-bold text-white mb-6">Ride History - {selectedPassenger.name}</h3>
                    <div className="overflow-x-auto">
                      <table className="w-full text-left">
                        <thead>
                          <tr className="border-b border-gray-700">
                            <th className="px-4 py-3 text-gray-300 font-semibold">Booking ID</th>
                            <th className="px-4 py-3 text-gray-300 font-semibold">Driver</th>
                            <th className="px-4 py-3 text-gray-300 font-semibold">Route</th>
                            <th className="px-4 py-3 text-gray-300 font-semibold">Distance</th>
                            <th className="px-4 py-3 text-gray-300 font-semibold">Fare</th>
                            <th className="px-4 py-3 text-gray-300 font-semibold">Rating</th>
                            <th className="px-4 py-3 text-gray-300 font-semibold">Status</th>
                            <th className="px-4 py-3 text-gray-300 font-semibold">Date</th>
                          </tr>
                        </thead>
                        <tbody>
                          {rideHistory.length > 0 ? (
                            rideHistory.map((ride, idx) => (
                              <tr key={idx} className="border-b border-gray-700 hover:bg-[#252d42]">
                                <td className="px-4 py-3 text-gray-300 text-sm">{ride.bookingId.slice(0, 8)}</td>
                                <td className="px-4 py-3 text-gray-300 text-sm">{ride.driverName}</td>
                                <td className="px-4 py-3 text-gray-300 text-sm">{ride.pickup} → {ride.dropoff}</td>
                                <td className="px-4 py-3 text-gray-300 text-sm">{ride.distance}km</td>
                                <td className="px-4 py-3 text-gray-300 text-sm">₱{ride.fare}</td>
                                <td className="px-4 py-3 text-yellow-400 text-sm">⭐ {ride.rating}</td>
                                <td className="px-4 py-3 text-sm">
                                  <span className={`px-2 py-1 rounded text-xs font-bold ${
                                    ride.status === 'COMPLETED' ? 'bg-green-600 text-white' :
                                    ride.status === 'PENDING' ? 'bg-yellow-600 text-white' :
                                    'bg-red-600 text-white'
                                  }`}>
                                    {ride.status}
                                  </span>
                                </td>
                                <td className="px-4 py-3 text-gray-300 text-sm">{ride.timestamp.split('T')[0]}</td>
                              </tr>
                            ))
                          ) : (
                            <tr>
                              <td colSpan="8" className="px-4 py-6 text-center text-gray-400">
                                No ride history available
                              </td>
                            </tr>
                          )}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* Edit Passenger Modal */}
                {showPassengerEditModal && selectedPassenger && (
                  <EditPassengerModal
                    passenger={selectedPassenger}
                    passengerIndex={selectedPassengerIndex}
                    onClose={() => {
                      setShowPassengerEditModal(false);
                      setSelectedPassenger(null);
                    }}
                    onSave={handleSavePassenger}
                  />
                )}

                {/* Confirm Deactivate Modal */}
                {confirmDelete && selectedPassenger && (
                  <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50">
                    <div className="bg-[#1e2538] p-8 rounded-xl w-full max-w-md">
                      <h2 className="text-2xl font-bold mb-4 text-white">Confirm Deactivate</h2>
                      <p className="text-gray-300 mb-6">Are you sure you want to deactivate <span className="font-semibold text-white">{selectedPassenger.name}</span>?</p>
                      <div className="flex justify-end gap-3">
                        <button onClick={() => setConfirmDelete(false)} className="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-semibold text-white">Cancel</button>
                        <button onClick={performDeletePassenger} className="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-semibold text-white">Deactivate</button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Fare Matrix Page */}
            {currentPage === 'fareMatrix' && (
              <div className="space-y-6">
                <h2 className="text-3xl font-bold text-white">Fare Matrix Settings</h2>
                <div className="bg-[#1e2538] p-8 rounded-xl">
                  <div className="grid gap-6">
                    <div className="bg-[#252d42] p-6 rounded-lg border border-gray-700 hover:bg-[#2d3548] transition-colors">
                      <div className="flex items-center gap-3 mb-3">
                        <svg className="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h4 className="text-xl font-bold text-white">Base Fare Rate</h4>
                      </div>
                      <div className="space-y-2">
                        <p className="text-gray-300">
                          <span className="font-semibold text-yellow-400">Special Trip:</span> ₱30 for the first km (3-4 Passengers)
                        </p>
                        <p className="text-gray-300">
                          <span className="font-semibold text-yellow-400">Additional:</span> ₱5 for every kilometer
                        </p>
                      </div>
                    </div>

                    <div className="bg-[#252d42] p-6 rounded-lg border border-gray-700 hover:bg-[#2d3548] transition-colors">
                      <div className="flex items-center gap-3 mb-3">
                        <svg className="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <h4 className="text-xl font-bold text-white">Service Area</h4>
                      </div>
                      <div className="space-y-2">
                        <p className="text-gray-300">
                          <span className="font-semibold text-green-400">Current Area:</span> Bagong Silangan, Quezon City
                        </p>
                        <p className="text-gray-400 text-sm">
                          Defines the operational boundary for tricycle services
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
   

    ReactDOM.createRoot(document.getElementById("root")).render(<AdminDashboard />);
  </script>
</body>
</html>
