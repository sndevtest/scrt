<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pasakay - Driver Application</title>  
  <link rel="icon" href="tricy.png" type="image/png">

  <!-- React CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>  

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>  

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>  

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getDatabase, ref, onValue, get, set, update, push, runTransaction } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getBytes, list, listAll } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBS-g5bFBaJ6a35hWmjvoN-s8FuMEuxtew",
      authDomain: "pasakay-project-ph.firebaseapp.com",
      databaseURL: "https://pasakay-project-ph-default-rtdb.firebaseio.com",
      projectId: "pasakay-project-ph",
      storageBucket: "pasakay-project-ph.firebasestorage.app",
      messagingSenderId: "189297787561",
      appId: "1:189297787561:web:ddad5de3fdf638c6d8dfb8",
      measurementId: "G-2VWQ0C8EZE"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // Sign in anonymously for Storage/Database operations
    signInAnonymously(auth).catch(err => {
      console.error('Anonymous sign-in failed:', err);
    });

    // Monitor auth state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log('✅ Authenticated as:', user.uid);
        window.currentUser = user;
      } else {
        console.warn('⚠️ Not authenticated');
      }
    });

    window.db = db;
    window.dbRef = ref;
    window.dbOnValue = onValue;
    window.dbGet = get;
    window.dbSet = set;
    window.dbUpdate = update;
    window.dbPush = push;
    window.dbRunTransaction = runTransaction;
    
    // Storage helpers
    window.storage = storage;
    window.storageRef = storageRef;
    window.uploadBytes = uploadBytes;
    window.getBytes = getBytes;
    window.storageList = list;
    window.storageListAll = listAll;
  </script>

  <script src="ui-modals.js"></script>

  <style>
    body {
      font-family: "Inter", sans-serif;
      background: #0a0e1a;
      margin: 0;
    }
    
    /* Customized Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: #1a2333;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #fbbf24 0%, #f59e0b 100%);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #fcd34d 0%, #fbbf24 100%);
    }
    
    /* Firefox Scrollbar */
    * {
      scrollbar-color: #2e3c57 #1a2333;
      scrollbar-width: thin;
    }

    /* Applicants list custom scrollbar - dark blue theme */
    .applicants-scroll::-webkit-scrollbar {
      width: 8px;
    }

    .applicants-scroll::-webkit-scrollbar-track {
      background: #252d42;
      border-radius: 8px;
    }

    .applicants-scroll::-webkit-scrollbar-thumb {
      background: #2d3548;
      border-radius: 8px;
    }

    .applicants-scroll::-webkit-scrollbar-thumb:hover {
      background: #3d4558;
    }
  </style>
</head>  

<body>
  <div id="root"></div>  

  <script type="text/babel">
    // Helper: claim smallest available numeric id atomically (reuses gaps) - MOVED OUTSIDE COMPONENT
    // Returns a NUMBER (not a string) so it can be stored directly in the DB as an integer
    const claimSmallestNumericId = async (baseNode) => {
      if (!window.dbGet || !window.dbRef || !window.dbRunTransaction) throw new Error('DB helpers missing');
      const nodeRef = window.dbRef(window.db, baseNode);
      const snap = await window.dbGet(nodeRef);
      const keys = snap && snap.val() ? Object.keys(snap.val()) : [];
      const numericKeys = keys.map(k => parseInt(k, 10)).filter(n => Number.isInteger(n) && n > 0);
      const max = numericKeys.length ? Math.max(...numericKeys) : 0;

      for (let candidate = 1; candidate <= max; candidate++) {
        if (!numericKeys.includes(candidate)) {
          const allocRef = window.dbRef(window.db, `allocations/${baseNode}/${candidate}`);
          try {
            const tx = await window.dbRunTransaction(allocRef, (current) => {
              if (current) return; // already claimed
              return { reservedAt: Date.now() };
            });
            if (tx && tx.committed) return candidate; // Return NUMBER, not string
          } catch(e) {}
        }
      }

      const newId = max + 1;
      const allocRef2 = window.dbRef(window.db, `allocations/${baseNode}/${newId}`);
      await window.dbRunTransaction(allocRef2, (current) => {
        if (current) return; // someone else claimed
        return { reservedAt: Date.now() };
      });
      return newId; // Return NUMBER, not string
    };
    
    const TricycleManagement = () => {
      const [showModal, setShowModal] = React.useState(false);
      const [showAddDriverModal, setShowAddDriverModal] = React.useState(false);
      const [selected, setSelected] = React.useState(null);
      const [selectedIndex, setSelectedIndex] = React.useState(null);

      // Applicants data from Realtime Database
      const [applicants, setApplicants] = React.useState([]);
      const [statusFilter, setStatusFilter] = React.useState('ALL');
      const [searchQuery, setSearchQuery] = React.useState('');
      const [isProcessing, setIsProcessing] = React.useState(false);

      // Raw drivers and users from DB (we now derive applicants from users where RoleID === 2)
      const [rawDrivers, setRawDrivers] = React.useState({});
      const [rawUsers, setRawUsers] = React.useState({});
      const [selectedPasswordVisible, setSelectedPasswordVisible] = React.useState(false);

      // Helper function for status colors (must be before useEffect that uses it)
      const getStatusColor = (status) => {
          const statusStr = (status || '').toString().toUpperCase();
          // If ApplicationStatus contains 'ADDED', display as ADDED (green)
          if (statusStr.includes('ADDED')) return "bg-blue-600";
          // Extract base status (first word before space or hyphen)
          const baseStatus = statusStr.split(/[\s\-]/)[0];
          switch(baseStatus) {
            case "TO": return "bg-yellow-500"; // "TO REVIEW"
            case "APPROVED": return "bg-green-500";
            case "EXPIRED": return "bg-red-500";
            case "REJECTED": return "bg-red-500";
            default: return "bg-gray-500";
          }
      };

      // Helper to format status for display
      const formatStatusForDisplay = (appStatus) => {
        const statusStr = (appStatus || '').toString().toUpperCase();
        // If contains 'ADDED', display as just 'ADDED'
        if (statusStr.includes('ADDED')) return 'ADDED';
        // Otherwise show the full status
        const words = statusStr.split(/[\s\-]/).filter(Boolean);
        if (words[0] === 'TO') return 'TO REVIEW';
        return words[0] || 'TO REVIEW';
      };

      // Listen to drivers and users nodes so we can display canonical data for applicants when available
      React.useEffect(() => {
        if (!window.db || !window.dbRef || !window.dbOnValue) return;
        const driversRef = window.dbRef(window.db, 'drivers');
        const usersRef = window.dbRef(window.db, 'users');
        const unsubD = window.dbOnValue(driversRef, snap => setRawDrivers(snap.val() || {}));
        const unsubU = window.dbOnValue(usersRef, snap => setRawUsers(snap.val() || {}));
        return () => { try { unsubD(); } catch(e) {} try { unsubU(); } catch(e) {} };
      }, []);

      // Recompute merged applicants list whenever users or drivers change;
      // applicants are derived from users where RoleID === 2 (drivers) and merged with drivers/ record when available
      React.useEffect(() => {
        try { console.debug('Recomputing applicants from rawUsers/rawDrivers', Object.keys(rawUsers||{}).length, Object.keys(rawDrivers||{}).length); } catch(e) {}
        const usersVal = rawUsers || {};
        const items = [];

        for (const [userId, userRec] of Object.entries(usersVal)) {
          if (!userRec) continue;
          // Only consider users with RoleID === 2 (driver role per new flow)
          if (String(userRec.RoleID) !== '2') continue;
          // Skip soft-deleted users
          if (userRec.DeletedAt) continue;

          // find driver record for this user (if any)
          let drvEntry = null;
          for (const [drvId, drv] of Object.entries(rawDrivers || {})) {
            if (!drv) continue;
            if (String(drv.UserID) === String(userId)) {
              drvEntry = { id: drvId, rec: drv };
              break;
            }
          }

          const name = [userRec.Firstname, userRec.Middlename, userRec.Lastname].filter(Boolean).join(' ') || userRec.name || 'Applicant';
          const contact = userRec.MobileNumber || userRec.contact || '';
          const license = drvEntry ? (drvEntry.rec.LicenseNumber || drvEntry.rec.license || '') : '';
          const plate = drvEntry ? (drvEntry.rec.TricyclePlateNumber || drvEntry.rec.TricycleNumber || '') : '';
          const franchiseExpiry = drvEntry ? (drvEntry.rec.FranchiseExpiry || '') : '';
          const appStatus = drvEntry ? (drvEntry.rec.ApplicationStatus || drvEntry.rec.Status || 'TO REVIEW') : 'TO REVIEW';

          const statusRaw = (appStatus || 'TO REVIEW').toString();
          const statusWords = statusRaw.toUpperCase().split(/[\s\-]/).filter(Boolean);
          let status = formatStatusForDisplay(appStatus);

          const initials = (name || 'Applicant').split(' ').map(n => n[0]||'').join('').slice(0,2).toUpperCase();

          items.push({
            id: `user-${userId}`,
            userId: userId,
            drvId: drvEntry ? drvEntry.id : null,
            name,
            contact,
            license,
            plate,
            status,
            registeredDate: formatIsoForDisplay(userRec.CreatedAt || ''),
            franchiseExpiry,
            initials,
            color: getStatusColor(status),
            files: drvEntry && drvEntry.rec.files ? drvEntry.rec.files : {}
          });
        }

        // Also include any drivers that reference users not present (defensive)
        for (const [drvId, drv] of Object.entries(rawDrivers || {})) {
          if (!drv) continue;
          if (drv.UserID && rawUsers && rawUsers[String(drv.UserID)]) continue; // already included
          const name = drv.Name || drv.name || 'Applicant';
          const contact = drv.MobileNumber || drv.contact || '';
          const license = drv.LicenseNumber || drv.license || '';
          const plate = drv.TricyclePlateNumber || drv.TricycleNumber || '';
          const statusRaw = (drv.ApplicationStatus || drv.Status || 'TO REVIEW').toString();
          const statusWords = statusRaw.toUpperCase().split(/[\s\-]/).filter(Boolean);
          const status = formatStatusForDisplay(drv.ApplicationStatus || drv.Status || 'TO REVIEW');
          const initials = (name || 'Applicant').split(' ').map(n => n[0]||'').join('').slice(0,2).toUpperCase();
          items.push({
            id: `drv-${drvId}`,
            drvId,
            userId: drv.UserID || null,
            name,
            contact,
            license,
            plate,
            status,
            registeredDate: formatIsoForDisplay(drv.CreatedAt || ''),
            franchiseExpiry: drv.FranchiseExpiry || '',
            initials,
            color: getStatusColor(status),
            files: drv.files || {}
          });
        }

        setApplicants(items);
      }, [rawDrivers, rawUsers]);

      // Date formatting helpers: display without 'T' and without milliseconds/Z
      const formatIsoForDisplay = (iso) => {
        if (!iso) return '';
        try {
          const s = iso.toString();
          // Remove 'T', '.000Z', 'Z', and milliseconds
          let result = s.replace('T', ' ');
          result = result.replace(/\.\d{3}Z?$/, '');
          result = result.replace(/Z$/, '');
          return result;
        } catch (e) { return iso; }
      };

      // Convert displayed 'YYYY-MM-DD HH:MM:SS' back to ISO-like string
      const displayToIso = (s) => {
        if (!s) return '';
        const m = s.toString().match(/^(\d{4}-\d{2}-\d{2})[ T](\d{2}:\d{2}:\d{2})$/);
        if (m) {
          return `${m[1]}T${m[2]}.000Z`;
        }
        return s;
      };

      // Validation helpers (shared with Driver Management patterns)
      const formatLicense = (value) => {
        if (!value) return '';
        const up = value.toString().toUpperCase();
        const raw = up.replace(/[^A-Z0-9]/g, '');
        const p1 = raw.slice(0, 3);
        const p2 = raw.slice(3, 5);
        const p3 = raw.slice(5, 11);
        let formatted = p1;
        if (p2) formatted += '-' + p2;
        if (p3) formatted += '-' + p3;
        return formatted;
      };

      const isValidLicense = (value) => {
        return /^[A-Z]\d{2}-\d{2}-\d{6}$/.test((value||'').toString());
      };

      const normalizeLicenseForCompare = (value) => {
        return (value||'').toString().toUpperCase().replace(/[^A-Z0-9]/g, '');
      };

      // Helper: strip +63 prefix for display
      const stripPhonePrefix = (phone) => {
        if (!phone) return '';
        const str = phone.toString();
        if (str.startsWith('+63')) return str.slice(3);
        return str;
      };

      const openModal = (index) => {
        // Prefill the modal with applicant values. If this row is backed by a drivers/<id> record,
        // prefer canonical driver/user values so edits can be persisted back to drivers/users.
        const app = applicants[index] || {};
        const base = { 
          ...app,
          // Ensure all fields are initialized (prevents undefined values)
          plate: app.plate || '',
          tricycleNumber: app.tricycleNumber || '',
          license: app.license || '',
          name: app.name || '',
          contact: app.contact || '',
          registeredDate: app.registeredDate || '',
          franchiseExpiry: app.franchiseExpiry || ''
        };
        
        // Ensure UserID is always captured. Our applicants come from users/ (id like 'user-<id>')
        if (!base.UserID) {
          if (app.userId) base.UserID = app.userId || '';
          else if (app.id && typeof app.id === 'string' && app.id.startsWith('user-')) base.UserID = app.id.replace(/^user-/, '');
        }

        // If this row maps to a driver record (drvId), prefill license/tricycle from that driver
        try {
          if (app.drvId) {
            const drv = rawDrivers && rawDrivers[String(app.drvId)];
            if (drv) {
              base.UserID = drv.UserID || base.UserID || '';
              base.license = drv.LicenseNumber || drv.license || base.license || '';
              base.plate = drv.TricyclePlateNumber || base.plate || '';
              base.tricycleNumber = drv.TricycleNumber || base.tricycleNumber || '';
              base.franchiseExpiry = drv.FranchiseExpiry || base.franchiseExpiry || '';
              const userRec = rawUsers && rawUsers[drv.UserID];
              if (userRec) {
                base.contact = stripPhonePrefix(userRec.MobileNumber || base.contact || '');
                base.name = [userRec.Firstname, userRec.Middlename, userRec.Lastname].filter(Boolean).join(' ') || base.name;
              }
              base.registeredDate = formatIsoForDisplay(drv.CreatedAt || drv.registeredDate || base.registeredDate || '');
            }
          }
        } catch (e) {}
        
        try {
          if (app.id && typeof app.id === 'string' && app.id.startsWith('drv-')) {
            const drvId = app.id.replace(/^drv-/, '');
            const drv = rawDrivers && rawDrivers[String(drvId)];
              if (drv) {
              base.UserID = drv.UserID || base.UserID || '';
              base.license = drv.LicenseNumber || drv.license || base.license || '';
                // Prefer explicit plate field if present, but also capture dedicated tricycle number when available
                base.plate = drv.TricyclePlateNumber || base.plate || '';
                base.tricycleNumber = drv.TricycleNumber || base.tricycleNumber || '';
              base.franchiseExpiry = drv.FranchiseExpiry || drv.franchiseExpiry || base.franchiseExpiry || '';
              // prefer user mobile/name
              const userRec = rawUsers && rawUsers[drv.UserID];
              if (userRec) {
                base.contact = stripPhonePrefix(userRec.MobileNumber || base.contact || '');
                base.name = [userRec.Firstname, userRec.Middlename, userRec.Lastname].filter(Boolean).join(' ') || base.name;
              }
              // format registeredDate for display
              base.registeredDate = formatIsoForDisplay(drv.CreatedAt || drv.registeredDate || base.registeredDate || '');
            }
          }
        } catch (e) {}

        // ApplicationStatus is stored in drivers/ when present; otherwise default to TO REVIEW
        try {
          if (base.drvId) {
            const drv = rawDrivers && rawDrivers[String(base.drvId)];
            base.ApplicationStatus = (drv && (drv.ApplicationStatus || drv.Status) ? (drv.ApplicationStatus || drv.Status) : 'TO REVIEW').toString().toUpperCase();
          } else {
            base.ApplicationStatus = (base.status || 'TO REVIEW').toString().toUpperCase();
          }
        } catch (e) {
          base.ApplicationStatus = 'TO REVIEW';
        }
        // Display status mirrors ApplicationStatus here (do not convert APPROVED -> ADDED in this view)
        try {
          base.displayStatus = base.ApplicationStatus || 'TO REVIEW';
        } catch (e) { base.displayStatus = base.ApplicationStatus || 'TO REVIEW'; }

        // Load documents from Realtime Database if driver has documents node
        try {
          if (base.drvId && rawDrivers && rawDrivers[String(base.drvId)]) {
            const drv = rawDrivers[String(base.drvId)];
            if (drv.documents) {
              base.documents = drv.documents;
            } else {
              base.documents = {};
            }
          } else {
            base.documents = {};
          }
        } catch (e) {
          base.documents = {};
        }

        // Strip +63 prefix from contact for display (will be re-added on save)
        if (base.contact) {
          base.contact = stripPhonePrefix(base.contact);
        }
        // include password for editing when user record exists
        try {
          if (base.UserID && rawUsers && rawUsers[base.UserID]) {
            base.password = rawUsers[base.UserID].Password || rawUsers[base.UserID].password || '';
          }
        } catch (e) {}
        setSelectedIndex(index);
        setSelected(base);
        setShowModal(true);
      };

      const closeModal = () => {
        setShowModal(false);
        setSelected(null);
        setSelectedIndex(null);
      };

      const handleInputChange = (e) => {
        const { name, value } = e.target;
        setSelected((prev) => ({
          ...prev,
          [name]: value,
        }));
      };

      const saveChanges = async () => {
        if (selectedIndex !== null && selected && selected.id) {
          // prefer ApplicationStatus field; fallback to legacy status
          const appStatus = (selected.ApplicationStatus || selected.Application_Status || selected.status || 'TO REVIEW').toString().toUpperCase();
          try { console.debug('saveChanges:', {
            selectedApplicationStatus: selected.ApplicationStatus,
            selectedStatus: selected.status,
            appStatus: appStatus,
            allSelected: JSON.stringify(selected)
          }); } catch(e) {}
          // Validate contact length (should be 11 digits - +63 prefix is added automatically)
          const contactDigits = selected.contact.toString().replace(/\D/g, '');
          if (!contactDigits || contactDigits.length !== 11) {
            window.showAlert('Phone number must be exactly 11 digits (format: +63 followed by 09XX XXXX XXX)', 'error');
            return;
          }

          // Format license if present and validate
          let formattedLicense = '';
          if (selected.license) {
            formattedLicense = formatLicense(selected.license);
            if (!isValidLicense(formattedLicense)) {
              window.showAlert('License number must match format like A01-23-456789', 'error');
              return;
            }
            // Check uniqueness across drivers only if license was modified
            try {
              const normNew = normalizeLicenseForCompare(formattedLicense);
              // get original license for this row (if available) and normalize
              const original = (applicants && applicants[selectedIndex] && (applicants[selectedIndex].license || applicants[selectedIndex].LicenseNumber || '')) || '';
              const normOriginal = normalizeLicenseForCompare(original);
              // Only validate uniqueness when the normalized license actually changed
              if (normNew && normNew !== normOriginal) {
                for (const [k, d] of Object.entries(rawDrivers || {})) {
                  if (!d) continue;
                  const normExisting = normalizeLicenseForCompare(d.LicenseNumber || d.license || '');
                  // Exclude current driver from uniqueness check
                  const isSameDriver = (selected.id && selected.id.startsWith('drv-') && selected.id.replace(/^drv-/, '') === k);
                  if (normExisting && normExisting === normNew && !isSameDriver) {
                    window.showAlert('License number already exists. Please use a unique license number.', 'error');
                    return;
                  }
                }
              }
            } catch (e) {}
          }

          const payload = {
            name: selected.name,
            contact: contactDigits.length === 11 ? '+63' + contactDigits : selected.contact,
            license: formattedLicense || selected.license || '',
            plate: selected.plate || '',
            tricycleNumber: selected.tricycleNumber || '',
            // convert displayed date back to ISO-ish string before saving
            registeredDate: displayToIso(selected.registeredDate) || selected.registeredDate || '',
            franchiseExpiry: selected.franchiseExpiry || '',
            ApplicationStatus: appStatus,
            status: appStatus // keep legacy field in sync for UI compatibility
          };

          // If this row was synthesized from a drivers/ record (id like 'drv-<id>'), persist the status back to drivers/<id>
          if (typeof selected.id === 'string' && selected.id.startsWith('drv-')) {
            const drvId = selected.id.replace(/^drv-/, '');
            const drvRef = window.dbRef(window.db, `drivers/${drvId}`);
            try {
              // Update driver ApplicationStatus and any edited fields (license, tricycle, contact, franchiseExpiry)
              const driverUpdatePayload = { ApplicationStatus: appStatus };
              // include formatted license if provided
              if (payload.license) driverUpdatePayload.LicenseNumber = payload.license;
              // Persist plate and tricycle number as SEPARATE fields (always write explicit fields)
              driverUpdatePayload.TricyclePlateNumber = payload.plate || '';
              driverUpdatePayload.TricycleNumber = payload.tricycleNumber || '';
              if (payload.franchiseExpiry) driverUpdatePayload.FranchiseExpiry = payload.franchiseExpiry;
              // Update status label only; driver activation/online state are managed in Driver Management
              if (appStatus === 'EXPIRED') {
                driverUpdatePayload.Status = 'Inactive';
              } else {
                driverUpdatePayload.Status = 'Active';
              }

              try { console.debug('Updating driver', drvId, 'with payload:', driverUpdatePayload); } catch(e) {}
              await window.dbUpdate(drvRef, driverUpdatePayload);
              try { console.debug('Driver update completed for', drvId); } catch(e) {}

              // applications/ node is no longer the canonical source in the new flow.
              // Drivers/ is canonical for application status; we avoid touching applications/ here.

              // Send notification to linked user (if available) and update user contact/name if edited
              try {
                const drvRec = rawDrivers && rawDrivers[String(drvId)];
                const userId = drvRec && drvRec.UserID;
                if (userId) {
                  // update user contact/name if provided
                  try {
                    const userRef = window.dbRef(window.db, `users/${userId}`);
                    const userSnap = await window.dbGet(userRef);
                    const userObj = userSnap.exists() ? userSnap.val() : {};
                    // split name into parts
                    const nameParts = (payload.name || '').trim().split(/\s+/).filter(Boolean);
                    if (nameParts.length) {
                      userObj.Firstname = nameParts[0] || userObj.Firstname || '';
                      userObj.Lastname = nameParts.length > 1 ? nameParts[nameParts.length-1] : userObj.Lastname || '';
                      userObj.Middlename = nameParts.length > 2 ? nameParts.slice(1, -1).join(' ') : userObj.Middlename || '';
                    }
                    if (payload.contact) userObj.MobileNumber = payload.contact;
                    // update password if admin edited it in modal
                    if (selected && (typeof selected.password !== 'undefined')) {
                      userObj.Password = selected.password || '';
                    }
                    await window.dbSet(userRef, userObj);
                  } catch (e) {
                    console.warn('Failed to update user record for driver edit', e);
                  }

                  const notifRef = window.dbRef(window.db, `users/${userId}/notifications/${Date.now()}`);
                  await window.dbSet(notifRef, {
                    type: 'APPLICATION_STATUS_UPDATE',
                    message: `Your application status is now ${appStatus}`,
                    createdAt: Date.now(),
                    seen: false
                  });
                }
              } catch (e) {
                console.warn('Failed to send notification to user for driver status change', e);
              }

              // Update local rawDrivers and applicants view
              try {
                const updatedApplicants = [...applicants];
                // Compute display status: if APPROVED and a driver exists, show ADDED (display-only)
                let displayStatusAfter = appStatus;
                try {
                  // Keep display status consistent with ApplicationStatus; mapping to 'ADDED' only happens in Driver Management
                  // (do not convert 'APPROVED' to 'ADDED' here)
                } catch (e) {}

                updatedApplicants[selectedIndex] = { ...updatedApplicants[selectedIndex], ...payload, status: displayStatusAfter, color: getStatusColor(displayStatusAfter) };
                setApplicants(updatedApplicants);

                // Update rawDrivers immutably so React picks up change
                setRawDrivers(prev => {
                  const copy = { ...(prev || {}) };
                  copy[drvId] = { ...(copy[drvId] || {}), ...driverUpdatePayload };
                  return copy;
                });

                // Force a fresh read to ensure listeners and other tabs reflect canonical data
                try {
                  const driversSnap = await window.dbGet(window.dbRef(window.db, 'drivers'));
                  const drvVal = driversSnap.val() || {};
                  setRawDrivers(drvVal);
                  try { console.debug('Refreshed drivers after update', Object.keys(drvVal).length); } catch(e) {}
                } catch(e) { console.warn('Failed to refresh drivers after update', e); }
              } catch (e) { console.warn('Error updating local state after driver update', e); }

              window.showAlert("Application status saved for " + selected.name, 'success');
              closeModal();
            } catch (err) {
              console.error('Error updating driver ApplicationStatus:', err);
              window.showAlert('Error saving changes to driver: ' + (err.message || err), 'error');
            }
            return;
          }

          // Default: write to applications/<id>
          // Store essential fields in applications/ (reference users/ for name, email, phone)
          const appRef = window.dbRef(window.db, `applications/${selected.id}`);
          const userIdVal = selected.UserID || (applicants && applicants[selectedIndex] && applicants[selectedIndex].UserID) || '';
          const appPayload = {
            UserID: userIdVal ? parseInt(userIdVal, 10) : null,
            ApplicationStatus: appStatus,
            LicenseNumber: formattedLicense || selected.license || '', // Store license in applications
            TricyclePlateNumber: selected.plate || '', // explicit plate
            TricycleNumber: selected.tricycleNumber || '' // internal number (no fallback to plate)
          };
          // If admin edited password on the modal and this application references a user, persist password to users/<id>
          try {
            if (userIdVal && (typeof selected.password !== 'undefined')) {
              await window.dbUpdate(window.dbRef(window.db, `users/${userIdVal}`), { Password: selected.password || '' });
            }
          } catch (e) {
            console.warn('Failed to update user password for application edit', e);
          }
          // Persist applicant changes via users/ and drivers/ (applications/ is deprecated)
          try {
            const userIdVal = selected.userId || (selected.id && selected.id.startsWith('user-') ? selected.id.replace(/^user-/, '') : selected.UserID || '');
            // persist password to users/<id> if admin edited it
            try {
              if (userIdVal && (typeof selected.password !== 'undefined')) {
                await window.dbUpdate(window.dbRef(window.db, `users/${userIdVal}`), { Password: selected.password || '' });
              }
            } catch (e) { console.warn('Failed to update user password for applicant edit', e); }

            // If this applicant already has a driver record, update it
            if (selected.drvId) {
              const drvKey = selected.drvId;
              const driverUpdate = { ApplicationStatus: appStatus };
              // Do not toggle driver/user activation or online flags here; only update status label
              if (appStatus === 'EXPIRED') {
                driverUpdate.Status = 'Inactive';
              } else {
                driverUpdate.Status = 'Active';
              }
              driverUpdate.TricyclePlateNumber = payload.plate || '';
              driverUpdate.TricycleNumber = payload.tricycleNumber || '';
              if (payload.license) driverUpdate.LicenseNumber = payload.license;
              if (payload.franchiseExpiry) driverUpdate.FranchiseExpiry = payload.franchiseExpiry;
              await window.dbUpdate(window.dbRef(window.db, `drivers/${drvKey}`), driverUpdate);

              // update user contact/name if present
              try {
                if (userIdVal) {
                  const userRef = window.dbRef(window.db, `users/${userIdVal}`);
                  const nameParts = (payload.name || '').trim().split(/\s+/).filter(Boolean);
                  const toUpd = {};
                  if (nameParts.length) {
                    toUpd.Firstname = nameParts[0] || '';
                    toUpd.Lastname = nameParts.length > 1 ? nameParts[nameParts.length-1] : '';
                    toUpd.Middlename = nameParts.length > 2 ? nameParts.slice(1, -1).join(' ') : '';
                  }
                  if (payload.contact) toUpd.MobileNumber = payload.contact;
                  if (Object.keys(toUpd).length) await window.dbUpdate(userRef, toUpd);
                }
              } catch (e) { console.warn('Failed to update user info after driver change', e); }

              // notify user
              try {
                const notifRef = window.dbRef(window.db, `users/${userIdVal}/notifications/${Date.now()}`);
                await window.dbSet(notifRef, { type: 'APPLICATION_STATUS_UPDATE', message: `Your application status is now ${appStatus}`, createdAt: Date.now(), seen: false });
              } catch (e) { console.warn('Failed to notify user', e); }

              // refresh drivers
              try { const driversSnap = await window.dbGet(window.dbRef(window.db, 'drivers')); setRawDrivers(driversSnap.val() || {}); } catch(e) {}

              // update local applicants list
              try { const updatedApplicants = [...applicants]; updatedApplicants[selectedIndex] = { ...updatedApplicants[selectedIndex], ...payload, status: appStatus, color: getStatusColor(appStatus) }; setApplicants(updatedApplicants); } catch (e) {}

              window.showAlert('Changes saved for ' + selected.name, 'success');
              closeModal();
              return;
            }

            // No driver record yet: update user and create driver record if needed
            if (userIdVal) {
              try {
                const userRef = window.dbRef(window.db, `users/${userIdVal}`);
                const nameParts = (payload.name || '').trim().split(/\s+/).filter(Boolean);
                const toUpd = {};
                if (nameParts.length) {
                  toUpd.Firstname = nameParts[0] || '';
                  toUpd.Lastname = nameParts.length > 1 ? nameParts[nameParts.length-1] : '';
                  toUpd.Middlename = nameParts.length > 2 ? nameParts.slice(1, -1).join(' ') : '';
                }
                if (payload.contact) toUpd.MobileNumber = payload.contact;
                if (typeof selected.password !== 'undefined') toUpd.Password = selected.password || '';
                if (Object.keys(toUpd).length) await window.dbUpdate(userRef, toUpd);
              } catch (e) { console.warn('Failed to update user record for applicant', e); }
            }

            // Create driver record if license/plate provided or status is APPROVED
            if (payload.license || payload.plate || appStatus === 'APPROVED') {
              try {
                const newDrvId = await claimSmallestNumericId('drivers');
                const drvPayload = {
                  UserID: userIdVal || null,
                  LicenseNumber: payload.license || '',
                  TricyclePlateNumber: payload.plate || '',
                  TricycleNumber: payload.tricycleNumber || payload.plate || '',
                  FranchiseExpiry: payload.franchiseExpiry || '',
                  // keep IsApplying true unless the driver was explicitly 'ADDED' in Driver Management
                  IsApplying: appStatus === 'ADDED' ? false : true,
                  ApplicationStatus: appStatus,
                  CreatedAt: new Date().toISOString()
                };
                await window.dbSet(window.dbRef(window.db, `drivers/${newDrvId}`), drvPayload);
                if (userIdVal) await window.dbUpdate(window.dbRef(window.db, `users/${userIdVal}`), { DriverID: newDrvId, RoleID: 2 });
                try { const driversSnap = await window.dbGet(window.dbRef(window.db, 'drivers')); setRawDrivers(driversSnap.val() || {}); } catch(e) {}
                
                // Automatically create Firebase Storage folder for this driver
                // Folder name format: firstname_lastname_driverId (e.g., "JOHN_DOE_1")
                try {
                  if (window.storage && window.storageRef && window.uploadBytes) {
                    const nameParts = (name || '').trim().split(/\s+/).filter(Boolean);
                    const firstname = nameParts[0] || '';
                    const lastname = nameParts.length > 1 ? nameParts[nameParts.length-1] : '';
                    const folderName = `${firstname}_${lastname}_${newDrvId}`.replace(/\s+/g, '_').toUpperCase();
                    const folderPath = `drivers/${folderName}/.folder`;
                    const markerRef = window.storageRef(window.storage, folderPath);
                    const markerContent = `Driver: ${name}\nDriver ID: ${newDrvId}\nFolder: ${folderName}\nCreated: ${new Date().toISOString()}`;
                    const markerBlob = new Blob([markerContent], { type: 'text/plain' });
                    const uploadResult = await window.uploadBytes(markerRef, markerBlob);
                    console.log(`✅ Storage folder created: ${folderName}`, uploadResult);
                  } else {
                    console.warn('Storage helpers not available:', { storage: !!window.storage, storageRef: !!window.storageRef, uploadBytes: !!window.uploadBytes });
                  }
                } catch (storageErr) {
                  console.error('❌ Storage Error:', storageErr);
                  console.warn('Warning: Could not create storage folder (non-critical)', storageErr);
                }
                
                window.showAlert('Applicant updated and driver record created', 'success');
                closeModal();
                return;
              } catch (e) { console.error('Failed to create driver record', e); window.showAlert('Failed to create driver record', 'error'); }
            }

            window.showAlert('Changes saved for ' + selected.name, 'success');
            closeModal();
            return;
          } catch (err) {
            console.error('Error updating applicant:', err);
            window.showAlert('Error saving changes: ' + (err.message || err), 'error');
            return;
          }
        }
      };

      const approveAndAdd = async () => {
        if (!selected || !selected.id) return;
        if (!window.db || !window.dbRef || !window.dbPush || !window.dbGet || !window.dbUpdate) {
          window.showAlert('Database helpers not available', 'error');
          return;
        }

        setIsProcessing(true);
        try {
          if (!window.dbRunTransaction || !window.dbRef || !window.dbSet || !window.dbGet || !window.dbUpdate) {
            throw new Error('Required DB helpers not available');
          }

          const normalize = (s) => (s||'').toString().toUpperCase().replace(/[^A-Z0-9]/g, '');
          const licenseNorm = normalize(selected.license);

          // Check drivers for duplicate license
          const driversSnap = await window.dbGet(window.dbRef(window.db, 'drivers'));
          const driversVal = driversSnap.val() || {};
          for (const [k, d] of Object.entries(driversVal)) {
            const dLicense = normalize(d.LicenseNumber || d.license || '');
            if (dLicense && dLicense === licenseNorm) {
              window.showAlert('A driver with the same license already exists. Aborting add.', 'error');
              setIsProcessing(false);
              return;
            }
          }

          // Claim smallest available numeric IDs and create records (reuses gaps)
          const userId = await claimSmallestNumericId('users');

          // Create user record
          const fullName = (selected.name || '').trim();
          const parts = fullName.split(' ').filter(Boolean);
          const firstname = parts.shift() || fullName;
          const lastname = parts.join('') || '';

          const userPayload = {
            Firstname: firstname,
            Lastname: lastname,
            MobileNumber: selected.contact || '',
            Email: selected.email || '',
            Role: 'Driver',
            // RoleID numeric for driver role (use 2 as driver code)
            RoleID: 2,
            // store admin-provided password in plain text (per request)
            Password: selected.password || '',
            CreatedAt: new Date().toISOString(),
            // Do not activate user here; activation happens in Driver Management
            IsActive: false
          };

          // userId is now a NUMBER from claimSmallestNumericId, use it directly
          const userRef = window.dbRef(window.db, `users/${userId}`);
          await window.dbSet(userRef, userPayload);

          const driverId = await claimSmallestNumericId('drivers');

          // Create driver record
          const driverPayload = {
            UserID: userId, // Store as number, not string
            LicenseNumber: selected.license || '',
            TricyclePlateNumber: selected.plate || '',
            TricycleNumber: selected.tricycleNumber || selected.plate || '',
            ApplicationStatus: 'APPROVED',
            // Driver-level IsActive/IsOnline are not stored here. User record owns IsActive.
            CreatedAt: new Date().toISOString()
          };

          // driverId is now a NUMBER from claimSmallestNumericId, use it directly
          const driverRef = window.dbRef(window.db, `drivers/${driverId}`);
          await window.dbSet(driverRef, driverPayload);

          // Update user record to include DriverID reference
          try {
            await window.dbUpdate(userRef, { DriverID: driverId, RoleID: 2 });
          } catch (e) {
            console.warn('Failed to update user with DriverID/RoleID after adding driver', e);
          }

          // (no explicit allocation writes here — reservation is handled inside claimSmallestNumericId)

          // Update local UI state (no longer writing to legacy `applications/` node)
          const payload = {
            UserID: userId,
            DriverID: driverId,
            ApplicationStatus: 'APPROVED',
            LicenseNumber: selected.license || '',
            TricyclePlateNumber: selected.plate || '',
            TricycleNumber: selected.tricycleNumber || selected.plate || '',
            CreatedAt: new Date().toISOString()
          };
          const updatedApplicants = [...applicants];
          if (typeof selectedIndex === 'number' && updatedApplicants[selectedIndex]) {
            updatedApplicants[selectedIndex] = { ...updatedApplicants[selectedIndex], ...payload };
            setApplicants(updatedApplicants);
          }

          window.showAlert('Applicant approved and added as driver', 'success');
          closeModal();
        } catch (err) {
          console.error('Error approving and adding driver:', err);
          window.showAlert('Error: ' + (err.message || err), 'error');
        } finally {
          setIsProcessing(false);
        }
      };

      const rawSegment = window.location.pathname.split("/").pop() || window.location.href.split("/").pop() || '';
      const normalize = (s) => decodeURIComponent((s || '').toString()).toLowerCase().trim();
      const currentPage = normalize(rawSegment);

      const getLinkClass = (page) => {
        const isActive = currentPage === normalize(page);
        return "flex items-center gap-3 px-4 py-3 rounded-lg transition-colors " +
          (isActive ? "bg-yellow-500 text-gray-900 font-semibold" : "text-gray-300 hover:bg-gray-700");
      };

      return (
        <div className="flex min-h-screen bg-[#0a0e1a]">

          {/* Sidebar */}
          <aside className="w-72 bg-[#0e1420] text-white p-6 flex flex-col border-r border-gray-900">
            <div className="flex items-center gap-3 mb-10">
              <div className="w-14 h-14 rounded-2xl flex items-center justify-center overflow-hidden">
                <img src="tricy.png" alt="Pasakay" className="w-full h-full object-cover bg-yellow-500 p-1" />
              </div>
              <div>
                <h1 className="text-2xl font-bold text-yellow-500">PASAKAY</h1>
                <p className="text-sm text-gray-400">Admin Dashboard</p>
              </div>
            </div>

            <nav className="flex flex-col gap-2">
              <a href="dashboard.html" className={getLinkClass("dashboard.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                Dashboard
              </a>
              <a href="driver management.html" className={getLinkClass("driver management.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                Drivers
              </a>
              <a href="passenger management.html" className={getLinkClass("passenger management.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                Passengers
              </a>
              <a href="Driver application.html" className={getLinkClass("Driver application.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Membership
              </a>
              <a href="booking management.html" className={getLinkClass("booking management.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                Bookings
              </a>
              <a href="Logs.html" className={getLinkClass("Logs.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Logs
              </a>
              <a href="Fare Matrix.html" className={getLinkClass("Fare Matrix.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Fare Matrix
              </a>
              <a href="log out.html" className={getLinkClass("log out.html")}>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                Log out
              </a>
            </nav>
          </aside>

          {/* Main Content */}
          <main className="flex-1 bg-[#1a202e] p-8">

            <header className="flex justify-between items-center mb-8">
              <h2 className="text-3xl font-bold text-white">Driver Application</h2>
              <div className="flex items-center gap-3 bg-yellow-500 px-4 py-2 rounded-lg">
                <div className="w-10 h-10 bg-gray-900 text-yellow-500 rounded-full flex items-center justify-center font-bold text-lg">
                  A
                </div>
                <span className="font-semibold text-gray-900">Admin</span>
              </div>
            </header>

              {/* Add Driver Modal */}
              {showAddDriverModal && (
                <div className="fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-50">
                  <div className="bg-[#1e2538] p-8 rounded-xl w-[520px]">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-2xl font-bold text-white">Add New Driver (Quick)</h3>
                      <button onClick={() => setShowAddDriverModal(false)} className="text-gray-400 hover:text-white text-2xl font-light">×</button>
                    </div>
                    <AddSimpleDriverForm onClose={() => setShowAddDriverModal(false)} />
                  </div>
                </div>
              )}

            {/* Applicants List */}
            <div className="bg-[#1e2538] p-8 rounded-xl">
              <div className="flex justify-between items-center mb-6">
                <h3 className="text-2xl font-bold text-white">Driver Applicants</h3>
                <button onClick={() => setShowAddDriverModal(true)} className="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-white text-sm font-semibold">Add Applicant</button>
              </div>

              <div className="flex items-center gap-4 mb-4">
                <select value={statusFilter} onChange={(e) => setStatusFilter(e.target.value)} className="px-3 py-2 rounded bg-[#252d42] text-white border border-gray-700">
                  <option value="ALL">All Statuses</option>
                  <option value="TO REVIEW">To Review</option>
                  <option value="APPROVED">Approved</option>
                  <option value="EXPIRED">Expired</option>
                  <option value="REJECTED">Rejected</option>
                </select>
                <input placeholder="Search applicants..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="px-3 py-2 rounded bg-[#252d42] text-white border border-gray-700 flex-1" />
              </div>

              <div className="space-y-4 applicants-scroll" style={{
                maxHeight: '600px',
                overflowY: 'auto',
                scrollbarColor: '#2d3548 #252d42',
                scrollbarWidth: 'thin',
                paddingRight: '8px'
              }}>
                {applicants.filter(a => {
                  if (statusFilter !== 'ALL' && a.status !== statusFilter) return false;
                  if (searchQuery && searchQuery.trim()) {
                    const q = searchQuery.toLowerCase();
                    return (a.name||'').toLowerCase().includes(q) || (a.contact||'').toLowerCase().includes(q) || (a.license||'').toLowerCase().includes(q);
                  }
                  return true;
                }).map((applicant, index) => (
                  <div key={applicant.id || index} className="flex justify-between items-center bg-[#252d42] p-6 rounded-lg hover:bg-[#2d3548] transition-colors">
                    <div className="flex items-center gap-4">
                      <div className={`w-12 h-12 rounded-full ${applicant.color} flex items-center justify-center font-bold text-white text-lg`}>
                        {applicant.initials}
                      </div>
                      <div>
                        <h4 className="font-bold text-white text-lg">{applicant.name}</h4>
                        <p className="text-sm text-gray-400">
                          Contact: {stripPhonePrefix(applicant.contact)} | License: {applicant.license} | Plate: {applicant.plate}
                        </p>
                      </div>
                    </div>
                    <div className="flex items-center gap-3">
                      <span className={`${getStatusColor(applicant.status)} px-4 py-2 rounded-lg text-sm font-bold text-white`}>
                        {applicant.status}
                      </span>
                      <button
                        onClick={() => openModal(index)}
                        className="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-lg text-sm font-semibold text-gray-900 flex items-center gap-2"
                      >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        Edit
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </main>

          {/* MODAL */}
          {showModal && selected && (
            <div className="fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-50 overflow-y-auto py-8">
              <div className="bg-[#1e2538] p-8 rounded-xl w-[1000px] max-h-[90vh] overflow-y-auto">

                {/* Header */}
                <div className="flex justify-between items-center mb-6">
                  <h3 className="text-2xl font-bold text-white">Applicant Review</h3>
                  <button onClick={closeModal} className="text-gray-400 hover:text-white text-3xl font-light">
                    &times;
                  </button>
                </div>

                {/* Inputs */}
                <div className="grid grid-cols-2 gap-6 mb-8">
                  <Input label="Full Name" name="name" value={selected.name} onChange={handleInputChange} />
                  <div className="flex flex-col">
                    <label className="text-sm text-gray-300 mb-2 font-medium">Contact Number (11 digits)</label>
                    <div className="flex">
                      <div className="inline-flex items-center px-3 rounded-l-lg bg-[#1b2333] text-white border border-r-0 border-gray-700">+63</div>
                      <input
                        name="contact"
                        value={selected.contact || ''}
                        onChange={(e) => {
                          const raw = e.target.value.replace(/\D/g, '').slice(0,11);
                          handleInputChange({ target: { name: 'contact', value: raw } });
                        }}
                        maxLength="11"
                        placeholder="09123456789"
                        className="w-full px-4 py-3 rounded-r-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none"
                      />
                    </div>
                    <p className="text-xs text-gray-400 mt-1">Format: +63 followed by 11 digits</p>
                  </div>
                  <div className="flex flex-col">
                    <label className="text-sm text-gray-300 mb-2 font-medium">Password</label>
                    <div className="relative">
                      <input
                        name="password"
                        type={selectedPasswordVisible ? 'text' : 'password'}
                        value={selected.password || ''}
                        onChange={(e) => handleInputChange({ target: { name: 'password', value: e.target.value } })}
                        placeholder="Enter password (stored as plain text)"
                        className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none"
                      />
                      <button
                        type="button"
                        onClick={() => setSelectedPasswordVisible(v => !v)}
                        className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-300 hover:text-white"
                        aria-label="Toggle password visibility"
                      >
                        {selectedPasswordVisible ? (
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-5.523 0-10-4.477-10-10 0-1.05.165-2.063.469-3.013M3 3l18 18"/></svg>
                        ) : (
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                        )}
                      </button>
                    </div>
                    <p className="text-xs text-gray-400 mt-1">Password is stored in users/&lt;id&gt;/Password as plain text.</p>
                  </div>
                  <div className="flex flex-col">
                    <label className="text-sm text-gray-300 mb-2 font-medium">License Number</label>
                    <input
                      name="license"
                      value={selected.license}
                      onChange={(e) => {
                        const raw = e.target.value.replace(/[^A-Za-z0-9\-]/g, '');
                        handleInputChange({ target: { name: 'license', value: raw } });
                      }}
                      onBlur={() => {
                        const formatted = formatLicense(selected.license);
                        handleInputChange({ target: { name: 'license', value: formatted } });
                      }}
                      placeholder="e.g. A01-23-456789"
                      className="px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none"
                    />
                  </div>
                  <div className="flex flex-col">
                    <label className="text-sm text-gray-300 mb-2 font-medium">Registered Date</label>
                    <input
                      name="registeredDate"
                      value={selected.registeredDate}
                      onChange={handleInputChange}
                      placeholder="YYYY-MM-DD HH:MM:SS"
                      className="px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none"
                    />
                  </div>
                  <Input label="Tricycle Plate Number" name="plate" value={selected.plate} onChange={handleInputChange} />
                  <Input label="Tricycle Number" name="tricycleNumber" value={selected.tricycleNumber} onChange={handleInputChange} />
                  <Input label="Franchise Expiry" name="franchiseExpiry" value={selected.franchiseExpiry} onChange={handleInputChange} />

                  <div>
                    <div className="flex items-center gap-3">
                      <label className="text-sm text-gray-300 font-medium whitespace-nowrap">Application Status</label>
                      {selected && selected.displayStatus === 'ADDED' && (
                        <span className="inline-flex items-center ml-2 px-2 py-0.5 text-xs font-semibold rounded bg-blue-600 text-white">
                          Display: ADDED
                        </span>
                      )}
                    </div>
                    <select
                      name="ApplicationStatus"
                      value={selected.ApplicationStatus || selected.Application_Status || selected.status || 'TO REVIEW'}
                      // keep a small gap between label row and select
                      style={{ marginTop: '6px' }}
                      onChange={handleInputChange}
                      className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none"
                    >
                      <option value="TO REVIEW">To Review</option>
                      <option value="APPROVED">Approved</option>
                      <option value="REJECTED">Rejected</option>
                      <option value="EXPIRED">Expired</option>
                    </select>
                  </div>
                </div>

                {/* FILE SUBMISSION TABLE */}
                <h4 className="text-xl font-bold mb-4 text-white">Submitted Documents</h4>

                <div className="overflow-x-auto mb-8">
                  <table className="w-full border-collapse">
                    <thead>
                      <tr className="bg-[#252d42]">
                        <th className="px-6 py-4 text-left text-white font-semibold">Requirement</th>
                        <th className="px-6 py-4 text-left text-white font-semibold">Status</th>
                        <th className="px-6 py-4 text-left text-white font-semibold">Date Submitted</th>
                        <th className="px-6 py-4 text-left text-white font-semibold">File</th>
                      </tr>
                    </thead>
                    <tbody>
                      <FileRow
                        requirement="Driver's License"
                        documentType="license"
                        driverId={selected.drvId}
                        doc={selected.documents?.license}
                        missing={!selected.documents?.license}
                      />
                      <FileRow
                        requirement="NBI Clearance"
                        documentType="nbi"
                        driverId={selected.drvId}
                        doc={selected.documents?.nbi}
                        missing={!selected.documents?.nbi}
                      />
                      <FileRow
                        requirement="QC ID"
                        documentType="qc"
                        driverId={selected.drvId}
                        doc={selected.documents?.qc}
                        missing={!selected.documents?.qc}
                      />
                      <FileRow
                        requirement="Drug Test Result"
                        documentType="drug"
                        driverId={selected.drvId}
                        doc={selected.documents?.drug}
                        missing={!selected.documents?.drug}
                      />
                    </tbody>
                  </table>
                </div>

                {/* Action Buttons */}
                <div className="flex justify-between">
                  <button onClick={closeModal} className="bg-red-600 hover:bg-red-700 px-8 py-3 rounded-lg font-semibold text-white">
                    Cancel
                  </button>
                  <div className="flex items-center gap-3">
                    <button onClick={saveChanges} className="bg-green-600 hover:bg-green-700 px-8 py-3 rounded-lg font-semibold text-white">
                      Save Changes
                    </button>
                  </div>
                </div>

              </div>
            </div>
          )}
        </div>
      );
    };

    const Input = ({ label, name, value, onChange }) => (
      <div className="flex flex-col">
        <label className="text-sm text-gray-300 mb-2 font-medium">{label}</label>
        <input
          name={name}
          value={value || ''}
          onChange={onChange}
          className="px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:border-yellow-500 focus:outline-none"
        />
      </div>
    );

    const AddSimpleDriverForm = ({ onClose }) => {
      const [name, setName] = React.useState('');
      const [email, setEmail] = React.useState('');
      const [contact, setContact] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [showPassword, setShowPassword] = React.useState(false);
      const [nameError, setNameError] = React.useState('');
      const [emailError, setEmailError] = React.useState('');
      const [contactError, setContactError] = React.useState('');
      const [isSaving, setIsSaving] = React.useState(false);

      // Real-time validation for name field
      const handleNameChange = (e) => {
        const value = e.target.value.replace(/[^a-zA-Z\s\-']/g, '');
        setName(value);
        
        // Real-time error checking
        if (value && /\d/.test(value)) {
          setNameError('Numbers are not allowed in name');
        } else if (!value) {
          setNameError('Full name is required');
        } else {
          setNameError('');
        }
      };

      // Real-time validation for email field
      const handleEmailChange = (e) => {
        const value = e.target.value.trim().toLowerCase();
        setEmail(value);
        
        // Real-time error checking
        if (!value) {
          setEmailError('Email is required');
        } else {
          let emailToCheck = value;
          if (!emailToCheck.includes('@')) {
            emailToCheck = emailToCheck + '@gmail.com';
          }
          const domain = emailToCheck.split('@')[1] || '';
          if (domain !== 'gmail.com') {
            setEmailError('Email must be a gmail.com address');
          } else {
            setEmailError('');
          }
        }
      };

      // Real-time validation for contact field
      const handleContactChange = (e) => {
        const value = e.target.value.replace(/\D/g, '').slice(0,11);
        setContact(value);
        
        // Real-time error checking
        if (value.length === 0) {
          setContactError('Phone number is required');
        } else if (value.length < 11) {
          setContactError(`${11 - value.length} more digit${11 - value.length !== 1 ? 's' : ''} needed`);
        } else if (value.length === 11) {
          setContactError('');
        }
      };

      const validate = () => {
        let ok = true;
        // Name: no digits
        if (!name || /\d/.test(name)) {
          setNameError('Full name is required and cannot contain numbers');
          ok = false;
        } else setNameError('');

        // Email: enforce gmail.com domain (append if user forgot domain)
        let e = (email || '').toString().trim().toLowerCase();
        if (!e) {
          setEmailError('Email is required'); ok = false;
        } else {
          if (!e.includes('@')) e = e + '@gmail.com';
          const domain = e.split('@')[1] || '';
          if (domain !== 'gmail.com') { setEmailError('Email must be a gmail.com address'); ok = false; }
          else setEmailError('');
        }

        // Contact: must be 11 digits (displayed with +63 prefix, but only 11 digits needed)
        const phoneRaw = (contact || '').toString().replace(/\D/g, '').slice(0,11);
        if (phoneRaw.length !== 11) { setContactError('Phone number must be exactly 11 digits'); ok = false; } else setContactError('');

        // Return phone with +63 prefix format
        const fullPhone = '+63' + phoneRaw;
        return { ok, emailPrepared: e, phoneRaw: fullPhone };
      };

      const handleSubmit = async () => {
        const { ok, emailPrepared, phoneRaw } = validate();
        if (!ok) return;
        if (!window.db || !window.dbRef || !window.dbSet || !window.dbRunTransaction) {
          window.showAlert('Database not available', 'error');
          return;
        }
        setIsSaving(true);
        try {
          // Use push() keys for quick-add to avoid creating allocations entries
          // split name
          const parts = (name || '').trim().split(/\s+/).filter(Boolean);
          const firstname = parts[0] || '';
          const lastname = parts.length > 1 ? parts[parts.length-1] : '';
          const middlename = parts.length > 2 ? parts.slice(1, -1).join(' ') : '';
          const userObj = {
            Firstname: firstname,
            Middlename: middlename,
            Lastname: lastname,
            Email: emailPrepared,
            MobileNumber: phoneRaw,
            Role: 'Driver',
            RoleID: 2,
            Password: password || '',
            CreatedAt: new Date().toISOString(),
            // New applicant: IsActive should be false until approved
            IsActive: false
          };
          // create user with numeric id (claim smallest available) instead of a push key
          // userId is now a NUMBER from claimSmallestNumericId, use it directly
          const userId = await claimSmallestNumericId('users');
          const userRef = window.dbRef(window.db, `users/${userId}`);
          await window.dbSet(userRef, userObj);

          // Also create a drivers/ record for this applicant (IsApplying: true, ApplicationStatus: TO REVIEW)
          const driverId = await claimSmallestNumericId('drivers');
          const driverRef = window.dbRef(window.db, `drivers/${driverId}`);
          const driverObj = {
            UserID: userId,
            LicenseNumber: '',
            TricyclePlateNumber: '',
            TricycleNumber: '',
            FranchiseExpiry: '',
            IsApplying: true,
            ApplicationStatus: 'TO REVIEW',
            CreatedAt: new Date().toISOString()
          };
          await window.dbSet(driverRef, driverObj);

          // Automatically create Firebase Storage folder structure for this driver
          // Folder name format: firstname_lastname_driverId (e.g., "JOHN_DOE_1")
          try {
            if (window.storage && window.storageRef && window.uploadBytes) {
              // Create folder name: firstname_lastname_driverId
              const folderName = `${firstname}_${lastname}_${driverId}`.replace(/\s+/g, '_').toUpperCase();
              const folderPath = `drivers/${folderName}/.folder`;
              const markerRef = window.storageRef(window.storage, folderPath);
              const markerContent = `Driver: ${name}\nDriver ID: ${driverId}\nFolder: ${folderName}\nCreated: ${new Date().toISOString()}`;
              const markerBlob = new Blob([markerContent], { type: 'text/plain' });
              const uploadResult = await window.uploadBytes(markerRef, markerBlob);
              console.log(`✅ Storage folder created: ${folderName}`, uploadResult);
            } else {
              console.warn('Storage helpers not available:', { storage: !!window.storage, storageRef: !!window.storageRef, uploadBytes: !!window.uploadBytes });
            }
          } catch (storageErr) {
            console.error('❌ Storage Error:', storageErr);
            console.warn('Warning: Could not create storage folder (non-critical)', storageErr);
            // Don't fail the entire operation if storage folder creation fails
          }

          window.showAlert('Driver applicant added and marked as TO REVIEW. Storage folder created.', 'success');
          onClose();
        } catch (err) {
          console.error('Error adding driver applicant', err);
          window.showAlert('Error: ' + (err && err.message ? err.message : err), 'error');
        } finally {
          setIsSaving(false);
        }
      };

      return (
        <div className="space-y-4">
          <div>
            <label className="text-sm text-gray-300 mb-2 font-medium">Full Name</label>
            <input 
              value={name} 
              onChange={handleNameChange} 
              placeholder="Enter full name (letters, spaces, hyphens only)"
              className={`w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border ${nameError ? 'border-red-500' : 'border-gray-700'} focus:outline-none transition`}
            />
            {nameError && <p className="text-sm text-red-400 mt-1">{nameError}</p>}
          </div>
          <div>
            <label className="text-sm text-gray-300 mb-2 font-medium">Email</label>
            <input 
              value={email} 
              onChange={handleEmailChange} 
              placeholder="example@gmail.com (gmail.com only)"
              className={`w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border ${emailError ? 'border-red-500' : 'border-gray-700'} focus:outline-none transition`}
            />
            {emailError && <p className="text-sm text-red-400 mt-1">{emailError}</p>}
          </div>
          <div>
            <label className="text-sm text-gray-300 mb-2 font-medium">Contact Number (11 digits)</label>
            <div className="flex">
              <div className="inline-flex items-center px-3 rounded-l-lg bg-[#1b2333] text-white border border-r-0 border-gray-700">+63</div>
              <input 
                value={contact} 
                onChange={handleContactChange} 
                placeholder="09123456789" 
                maxLength="11" 
                className={`w-full px-4 py-3 rounded-r-lg bg-[#252d42] text-white border ${contactError ? 'border-red-500' : 'border-gray-700'} focus:outline-none transition`}
              />
            </div>
            <p className="text-xs text-gray-400 mt-1">Format: +63 followed by 11 digits</p>
            {contactError && <p className="text-sm text-red-400 mt-1">{contactError}</p>}
          </div>
          <div>
            <label className="text-sm text-gray-300 mb-2 font-medium">Password</label>
            <div className="relative">
              <input
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="Set a password (stored plain)"
                type={showPassword ? 'text' : 'password'}
                className="w-full px-4 py-3 rounded-lg bg-[#252d42] text-white border border-gray-700 focus:outline-none"
              />
              <button type="button" onClick={() => setShowPassword(v => !v)} className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-300 hover:text-white">
                {showPassword ? (
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-5.523 0-10-4.477-10-10 0-1.05.165-2.063.469-3.013M3 3l18 18"/></svg>
                ) : (
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                )}
              </button>
            </div>
            <p className="text-xs text-gray-400 mt-1">Password will be written to `users/&lt;id&gt;/Password` as plain text.</p>
          </div>
          <div className="flex justify-end gap-3 mt-4">
            <button onClick={onClose} className="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded text-white">Cancel</button>
            <button onClick={handleSubmit} disabled={isSaving || nameError || emailError || contactError} className={`px-6 py-2 rounded font-semibold text-white ${isSaving || nameError || emailError || contactError ? 'bg-gray-600 cursor-not-allowed' : 'bg-yellow-500 hover:bg-yellow-600'}`}>
              {isSaving ? 'Adding…' : 'Add Applicant'}
            </button>
          </div>
        </div>
      );
    };

    const FileRow = ({ requirement, documentType, driverId, doc, missing }) => {
      // documentType: 'license', 'nbi', 'qc', 'drug'
      // doc: { documentType, uploadedAt, fileName, storagePath, downloadUrl, size }
      
      if (missing || !doc) {
        return (
          <tr className="bg-[#151b28] hover:bg-[#1a202e]">
            <td className="px-6 py-4 text-gray-300 font-medium">{requirement}</td>
            <td className="px-6 py-4 text-center" colSpan="3">
              <div className="flex items-center justify-center gap-2">
                <span className="bg-red-600 px-4 py-2 rounded-lg text-sm font-bold text-white">NOT SUBMITTED</span>
              </div>
            </td>
          </tr>
        );
      }

      const uploadDate = doc.uploadedAt ? new Date(doc.uploadedAt).toLocaleDateString() : 'N/A';
      const fileSize = doc.size ? (doc.size / 1024 / 1024).toFixed(2) + ' MB' : 'Unknown';

      return (
        <tr className="bg-[#151b28] hover:bg-[#1a202e]">
          <td className="px-6 py-4 text-gray-300 font-medium">{requirement}</td>
          <td className="px-6 py-4 text-gray-400">-</td>
          <td className="px-6 py-4 text-gray-400">{uploadDate}</td>
          <td className="px-6 py-4">
            {doc.downloadUrl ? (
              <a
                href={doc.downloadUrl}
                target="_blank"
                rel="noopener noreferrer"
                className="flex items-center gap-3 text-yellow-500 hover:text-yellow-400 transition-colors"
                title={`Download ${doc.fileName}`}
              >
                <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"/>
                </svg>
                <div>
                  <div className="font-medium text-sm">{doc.fileName || `${requirement}.jpg`}</div>
                  <div className="text-xs text-gray-400">{fileSize}</div>
                </div>
              </a>
            ) : (
              <span className="text-gray-400 text-sm">URL unavailable</span>
            )}
          </td>
        </tr>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<TricycleManagement />);
  </script>
</body>
</html>